<!DOCTYPE html>
@using FXAdminTransferConnex.Entities;
@using TransferConnexChatApp;
@{
    ViewBag.Title = "LoadContackListToslack";
   // Layout = "~/Views/Shared/_Layout.cshtml";
    Layout = null;
}

<html lang="en">
<head>
    <title>TransferConnex Chat</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

    <!-- Add manifest -->
    <link rel="manifest" href="~/chatmanifest.json">
    <meta name="theme-color" content="#ff1962">


    <!-- Favicons -->
  


    <link rel="icon" type="image/png" href="~/Content/img/icons/chat-icon/apple-touch-icon/favicon.png" sizes="32x32">
    <link rel="apple-touch-icon" href="~/Content/img/icons/chat-icon/apple-touch-icon/favicon.png">
    <link rel="apple-touch-icon" sizes="60x60" href="~/Content/img/icons/chat-icon/apple-touch-icon/apple-touch-icon-iphone-60x60.png">
    <link rel="apple-touch-icon" sizes="72x72" href="~/Content/img/icons/chat-icon/apple-touch-icon/apple-touch-icon-72x72.png">
    <link rel="apple-touch-icon" sizes="76x76" href="~/Content/img/icons/chat-icon/apple-touch-icon/apple-touch-icon-ipad-76x76.png">
    <link rel="apple-touch-icon" sizes="114x114" href="~/Content/img/icons/chat-icon/apple-touch-icon/apple-touch-icon-iphone-retina-114x114.png">
    <link rel="apple-touch-icon" sizes="120x120" href="~/Content/img/icons/chat-icon/apple-touch-icon/apple-touch-icon-iphone-retina-120x120.png">
    <link rel="apple-touch-icon" sizes="144x144" href="~/Content/img/icons/chat-icon/apple-touch-icon/apple-touch-icon-144x144.png">
    <link rel="apple-touch-icon" sizes="152x152" href="~/Content/img/icons/chat-icon/apple-touch-icon/apple-touch-icon-ipad-retina-152x152.png">
    <link rel="apple-touch-icon" sizes="180x180" href="~/Content/img/icons/chat-icon/apple-touch-icon/apple-touch-icon-180x180.png">
    <link rel="apple-touch-icon" sizes="192x192" href="~/Content/img/icons/chat-icon/apple-touch-icon/apple-touch-icon-192x192.png">


    <link href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.5.2/animate.min.css" type="text/css" rel="stylesheet" />
    <link href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/css/bootstrap.min.css" type="text/css" rel="stylesheet" />
    <link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" type="text/css" rel="stylesheet" />
    <link href="~/Content/css/toastr.min.css" rel="stylesheet" />
    <link href="~/Content/themes/base/jquery-ui.min.css" rel="stylesheet" />


    @*<script src="~/Scripts/bootbox.js"></script>*@
    <style>
        .panel-footer {
            padding: 0px;
            background-color: white;
            border-top: 0px;
            border-bottom-right-radius: 0px;
            border-bottom-left-radius: 0px;
        }

        .modal-content {
            width: auto;
            height: inherit;
            margin: 0 auto;
        }

        #GroupMembers {
            padding-left: 15px;
            padding-bottom: 0%;
            padding-top: 10px;
            color: #bcabbc;
        }

        body {
            overflow: hidden !important;
            cursor: pointer;
        }


        #square {
            display: flex;
            height: 100vh;
        }

        #leftSquare {
            /*width: 25%;*/ /*column changes 5 2 5 in user-status-top-header class*/
            width: 20%;
            background: linear-gradient(#341535 100%, #341535 100%);
        }

        .sticky-after-scroll::-webkit-scrollbar-track {
            -webkit-box-shadow: inset 0 0 3px rgba(0,0,0,0.3);
            background-color: #e1e1e1;
        }

        .sticky-after-scroll::-webkit-scrollbar {
            width: 5px;
            background-color: #e1e1e1;
        }

        .sticky-after-scroll::-webkit-scrollbar-thumb {
            background-color: #9b9b9b;
            border: 2px solid #9b9b9b;
        }

        #row {
            display: block;
            align-items: center;
            padding: 10px;
        }

        #circle {
            border-radius: 50%;
            width: 10px;
            height: 10px;
            background: #1ddc23;
            justify-content: space-evenly;
            color: white;
            margin-right: 3px;
            display: inline-flex
        }

        channel-title {
            color: #2C2D30;
            font-family: "lato";
            font-size: 18px;
            font-weight: 800;
            padding-left: 3%;
            text-align: left;
            z-index: 3;
        }

        #chatMessages {
            float: left;
            width: 100%;
            /*width: 87%;*/
            height: 85vh;
        }

        span {
            color: #bcabbc;
        }

        .fa-inverse {
            color: #bcabbc;
        }

        #subtitle {
            /*padding: 4px 80px 7px 8px;*/
            color: white;
            display: inline-flex;
            align-items: center;
        }

        #time {
            color: #2C2D30;
            padding-left: 5px;
            font-family: "lato";
            font-size: 11px;
            opacity: 0.6;
            font-weight: 400;
        }

        .channel-top {
            display: flex;
            align-items: center;
            justify-content: flex-start;
            padding: 15px;
            position: inherit;
            margin-top: 0px;
            z-index: 999;
        }

            .channel-top h4 {
                margin: 0;
            }

        .search-bottom {
            position: absolute;
            display: flex;
            align-items: center;
            padding: 0px 14px;
            margin: auto;
            left: 15%;
            bottom: 3%;
            height: 5%;
            width: 83.5%;
            font-weight: 100;
            font-family: "lato";
            font-size: 16px;
            opacity: 0.6;
            color: #2C2D30;
            border: 2px solid gray
        }

        #line-bottom {
            position: absolute;
            display: block;
            margin: auto;
            bottom: 3.1%;
            right: 10%;
            opacity: 0.1;
            font-family: "lato";
            font-size: 22px;
            opacity: 0.3;
            font-weight: 100;
            color: #2C2D30;
        }

        formCreateGroup
        .ui-widget.ui-widget-content {
            padding: 0px;
        }

        .chatWidget {
            width: 70px;
            height: 70px;
            border-radius: 50%;
            background-color: cornflowerblue;
            z-index: 100;
            cursor: pointer;
            position: fixed;
            bottom: 40px;
            right: 19px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

            .chatWidget i.fa.fa-comments {
                font-size: 36px;
            }

            .chatWidget i.fa.fa-comments {
                font-size: 20px !important;
            }

            .chatWidget .chatWidget-box {
                width: auto;
                margin: auto;
                display: flex;
                justify-content: center;
                align-items: center;
                color: #fff;
            }

        .chatAvatar {
            width: 36px;
            height: 36px;
            line-height: 30px;
            border-radius: 50%;
            font-size: 18px;
            color: #341535;
            text-align: center;
            background: #7b647c /*background: radial-gradient(circle farthest-corner at 10% 20%, rgb(45 128 208) 10.3%, rgba(56,190,201,1) 90%);*/;
            display: flex;
            align-items: center;
            justify-content: center;
            outline: 0;
        }

            .chatAvatar:hover, .chatAvatar:focus {
                outline: 0;
            }

        @@media screen and (max-width: 767px) {
            .chatWidget {
                width: 50px;
                height: 50px;
                display: flex;
                align-items: center;
                justify-content: center;
            }

                .chatWidget > div {
                    width: 25px !important;
                    margin: 0px !important;
                }

                .chatWidget .fa.fa-comments {
                    font-size: 20px !important;
                }
        }

        .chat-pb-5 {
            margin-bottom: 5px !important;
            padding-bottom: 5px;
            padding-top: 5px;
            cursor: pointer;
            margin: 0px 0px;
            border-radius: 5px;
        }

        .chat-badge {
            margin-right: 0px;
            float: right;
            color: white;
            /* width: 25px;
            height: 25px;*/
            width: 20px;
            height: 20px;
            border-radius: 50%;
            text-align: center;
            line-height: 20px;
            /*background: linear-gradient(rgb(9, 103, 184) 0%, rgb(57, 87, 179) 100%);*/
            background: red;
            margin-right: 6px;
        }

        .chatPanel {
            position: relative;
            bottom: 0;
            width: 100%;
            display: flex;
            flex-wrap: wrap;
            flex-direction: column;
        }

        .smalltxt {
            height: 30px;
        }

        .btn-sm, .btn-group-sm > .btn {
            font-size: 12px !important;
        }

        .msg_a {
            float: left;
            /*clear: both;*/
            background: #c6dee8;
            padding: 5px 10px;
            border-radius: 0px 10px 10px 10px;
            margin-bottom: 4px;
            margin-top: 4px;
            margin-left: 5px;
            max-width: calc(40vw);
            display: inline-table;
            word-wrap: anywhere;
        }

        .msg_b_row {
            display: flex;
            justify-content: flex-end;
        }

        .msg_b {
            margin-right: 00px;
            float: right;
            clear: both;
            background: #eadfea;
            padding: 5px 10px;
            border-radius: 10px 10px 0px 10px;
            position: relative;
            margin-bottom: 10px;
            max-width: calc(40vw);
            display: inline-table;
            word-wrap: anywhere;
        }

        .edit_icon {
            float: right;
            position: relative;
            color: #80808059;
            padding: 5px 10px;
        }
        /*.msg_b:after {*/
        /*content: "\f142";*/
        /*font-family: "FontAwesome";
                position: absolute;
                right: -8px;
                top: -1px;
                color: #4d394b;
            }*/
        .msg_b_menu {
            /*margin-right: -39px;
            float: right;*/
            /*margin-right: -39 px;*/
            float: right;
            padding: 0 10px 0px 10px;
            position: relative;
        }

        .chat_option {
            /*border: 1px solid rgba(0,0,0,0.5);
            float: right;
            position: relative;
            display: none;*/
            border: none;
            float: right;
            position: absolute;
            display: none;
            left: -70px;
            top: 15px;
            background-color: #ffffff;
            border-radius: 4px;
            box-shadow: 0 0 3px 1px #d1c9d1;
            width: 81px;
            z-index: 1;
        }

            .chat_option span {
                display: inline-block;
                width: 100%;
                color: #341535;
                border-bottom: solid 1px #ebdeeb;
                padding: 5px 5px;
                text-align: center;
            }

                .chat_option span:last-child {
                    border-bottom: none;
                }

                .chat_option span:hover {
                    background-color: #ebdeeb;
                    color: #341535;
                }

        /*   .msg-time {
            float: left;
            width: 100%;
            font-size: 9px;
            font-weight: 300;
            line-height: 12px;
            text-align: right;
            color: #1B1B1B;
            letter-spacing: 0.5px;
        }*/

        .msg-time {
            display: flex;
            width: 100%;
            font-size: 9px;
            font-weight: 300;
            line-height: normal;
            text-align: right;
            color: #1B1B1B;
            letter-spacing: 0.5px;
            align-items: center;
            justify-content: flex-end;
            padding-right:10px;
        }

        .message-with-profile .msg-time {
            text-align: left;
            margin-bottom: 0;
            margin-left: 5px;
            justify-content: flex-start;
        }

        .user-pro-nm {
            display: inline-block;
        }

        .msg_a + .msg-time {
            text-align: left;
        }

        .lbl_msg_sender_a {
            text-align: left;
            margin: 0;
            padding: 0px;
            margin-bottom: 4px;
            font-size: 12px;
            font-weight: 600;
        }

        .lbl_msg_sender_b {
            text-align: right;
            margin: 0px 0px 4px 0;
            padding: 0px 0px 0px 0px;
            font-size: 12px;
            font-weight: 600;
        }

        .chatmsgs {
            position: relative;
            overflow: auto;
            height: 65vh;
            padding: 15px 70px;
        }

        @@media (max-width:767px) {
            .chatmsgs {
                padding: 15px 15px;
            }
        }

        .ui-dialog .ui-dialog-titlebar-close {
            right: 1em;
        }

        .ui-dialog-titlebar-plus {
            right: 3em;
        }

        @@media screen and (max-width: 700px) {
            .chatmsgs {
                position: relative;
                overflow: auto;
                height: 73vh;
                margin: -7px -14px;
            }
        }

        .chatmsgs::-webkit-scrollbar {
            width: 6px;
        }

        .chatmsgs::-webkit-scrollbar-track {
            -webkit-box-shadow: inset 0 0 6px rgba(0,0,0,0.3);
            border-radius: 10px;
        }

        .chatmsgs::-webkit-scrollbar-thumb {
            border-radius: 10px;
            -webkit-box-shadow: inset 0 0 6px rgba(0,0,0,0.5);
        }

        #ChatListDiv::-webkit-scrollbar {
            width: 6px;
        }

        #ChatListDiv::-webkit-scrollbar-track {
            -webkit-box-shadow: inset 0 0 6px rgba(0,0,0,0.3);
            border-radius: 10px;
        }

        #ChatListDiv::-webkit-scrollbar-thumb {
            border-radius: 10px;
            -webkit-box-shadow: inset 0 0 6px rgba(0,0,0,0.5);
        }

        .emojiPanel {
            overflow-y: auto;
            font-size: 25px;
            padding: 0px;
            display: none;
            position: absolute;
            bottom: 59px;
            z-index: 999;
            background-color: lightgoldenrodyellow;
        }

            .emojiPanel span:hover {
                cursor: pointer;
            }

            .emojiPanel::-webkit-scrollbar {
                width: 6px;
            }

            .emojiPanel::-webkit-scrollbar-track {
                -webkit-box-shadow: inset 0 0 6px rgba(0,0,0,0.3);
                border-radius: 10px;
            }

            .emojiPanel::-webkit-scrollbar-thumb {
                border-radius: 10px;
                -webkit-box-shadow: inset 0 0 6px rgba(0,0,0,0.5);
            }

        .status-circle-online {
            position: relative;
            margin-right: 0px;
            width: 11px;
            height: 11px;
            border-radius: 50%;
            background-color: #4fc93a;
            border: 2px solid white;
            float: right;
            margin-top: -13px;
            overflow: overlay;
        }

        p.time-summary-day-sticky {
            display: flex;
            align-items: center;
            justify-content: center;
            color: #898989;
            background-color: beige;
            width: auto;
            flex-direction: column;
            position: fixed;
            top: 55px;
            margin: 0 auto;
            width: 100px;
            padding: 0px;
            border-radius: 16px;
            left: 220px;
            right: 0;
        }

        p.time-summary-day {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 100%;
            padding: 15px 0px;
            background-color: #ffffff;
            white-space: nowrap;
        }

            p.time-summary-day:after {
                width: 50%;
                content: "";
                height: 1px;
                background-color: #f1f1f1;
                margin-left: 10px;
            }

            p.time-summary-day:before {
                width: 50%;
                content: "";
                height: 1px;
                background-color: #f1f1f1;
                margin-right: 10px;
            }

        @@media (max-width:992px) {
            p .time-summary-day-sticky {
                left: 0;
                right: 0;
                font-size: 12px;
                width: 80px;
                padding: 3px;
                top: 52px;
            }
        }

        .status-circle-offline {
            margin-right: 0px;
            width: 11px;
            height: 11px;
            border-radius: 50%;
            background-color: #ffffff;
            border: 3px solid #ff5722;
            /* border: 3px solid #4fc93a;*/
            /*bottom: 0;
            right: 0;
            position: absolute;*/
            float: right;
            margin-top: -13px;
            position: relative;
        }

        .status-circle-online-title {
            width: 15px;
            height: 15px;
            border-radius: 50%;
            background-color: limegreen;
            border: 2px solid white;
            float: right;
        }

        .status-circle-offline-title {
            width: 15px;
            height: 15px;
            border-radius: 50%;
            background-color: red;
            border: 2px solid white;
            float: right;
        }

        #chat {
            /*background-image: url('../../Content/Images/ChatBG.jpg');*/
            background-size: cover;
            background-color: #ffffff;
            padding: 1em;
        }

        .modal.fade #newChatModalPopup.modal-dialog {
            transform: translate3d(0, 100%, 0);
        }

        .modal.in #newChatModalPopup.modal-dialog {
            transform: translate3d(0, 0, 0);
        }

        .ui-dialog .ui-dialog-title {
            font-size: 18px;
            line-height: 40px;
        }

        #chat.chatPanel .form-control {
            box-shadow: none;
        }

        #chat .chatPanel .input-group-btn:nth-child(2) button {
            border-radius: 0px;
        }

        #chat .chatPanel .input-group-btn button {
            height: 30px;
        }

        .ui-widget.ui-widget-content {
            padding: 0px;
        }

        .top-header {
            position: relative;
        }

            .top-header .user-active-header {
                background-color: #ffffff;
                color: #4d394b;
                display: flex;
                align-items: center;
                box-shadow: 0 0 4px #f1f1f1;
                border-bottom: 1px solid #f1f1f1;
            }

        .user-img-profile {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            object-fit: cover;
        }

        #rightIcons > input:focus, #rightIcons > input, #rightIcons > input:hover {
            border: none;
            outline: 0;
        }

        .dropdown-status .btn-default {
            color: #fff;
            background-color: transparent;
            border: none !important;
            padding-bottom: 0;
            padding-top: 0;
            padding-left: 0;
            outline: none !important;
        }

        .dropdown-status .dropdown-menu {
            left: unset;
            right: unset;
        }

            .dropdown-status .dropdown-menu li a {
                display: flex;
                align-items: center;
            }

                .dropdown-status .dropdown-menu li a i {
                    margin-right: 10px;
                    width: 15px
                }

        .dropdown-status .btn-default:hover, .dropdown-status .btn-default:focus {
            background-image: none;
            background-color: transparent !important;
            border: none !important;
            color: #ffffff !important;
            outline: 0;
        }

        .dropdown-status {
            padding: 0px !important;
            /* left: 0px; */
            top: 6px;
            right: 15px;
            display: flex;
            flex-flow: column wrap;
            align-items: baseline;
        }

        .user-details-list {
            display: flex;
            justify-content: flex-start;
            padding-left: 0px;
            padding-right: 0px;
            align-items: center;
        }

        /*.user-details-list .user-profile-name {
            color: #bcabbc;
            display: flex;
            align-items: center;
            justify-content: space-between;
            width: 100%;
        }*/

        .user-profile-name {
            flex: 1;
            max-width: 100%;
        }

        .user-details-list .user-profile-img {
            width: 36px;
            height: 37px;
            margin-right: 15px;
            margin-left: 15px;
        }



        #row.user-status-top-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 13px 20px 0;
            margin: 0 auto !important;
        }

        .btn.btn-smile, .btn.btn-attachment {
            border-radius: 0px;
        }

        .chat-input-box {
            /*position: absolute;*/
            width: 100%;
            bottom: -7px;
            background-color: #ffffff;
            box-shadow: 0px -1px 1px #f1f2f3;
            padding-left: 0;
        }

        .btn.btn-default.btn-smile, .btn.btn-default.btn-attachment, input#TxtMessage {
            padding: 10px 10px;
            border: none;
            background: transparent;
            box-shadow: none;
        }

            .btn.btn-default.btn-smile:focus, .btn.btn-default.btn-attachment:focus, input#TxtMessage:focus {
                outline: 0;
            }

        .btn.btn-default.btn-attachment {
            padding-left: 0px;
        }
        /* .btn.btn-default.btn-smile:hover, .btn.btn-default.btn-attachment:hover{
            background-color:#f1f1f1;
        }*/
        button.btn.btn-default.btn-smile.btn-sm i {
            font-size: 20px;
            padding: 3px;
            color: #ff9800;
        }

        button.btn.btn-default.btn-sm.btn-attachment i {
            font-size: 20px;
            padding: 6px;
            color: #000000;
        }

        textarea#TxtMessage {
            height: 100%;
            font-size: 16px;
            width: 82%;
            display: flex;
            position: absolute;
            border: none;
            padding: 14px 0;
            resize: none;
        }

            textarea#TxtMessage:hover, textarea#TxtMessage:focus {
                border: none;
                outline: none;
            }

            textarea#TxtMessage::-webkit-scrollbar {
                display: none;
            }

            textarea#TxtMessage::-webkit-scrollbar {
                width: 0 !important
            }

        textarea#TxtMessage {
            overflow: -moz-scrollbars-none;
        }

        textarea#TxtMessage {
            -ms-overflow-style: none;
        }

        #row.channels-box {
            display: flex;
            justify-content: space-between;
            padding-top: 15px;
            border-bottom: solid 1px #592d5a;
        }

        .sticky-after-scroll {
            overflow: hidden;
            overflow-y: auto;
            height: 100vh;
            position: relative;
        }

        #row.chatListParent {
            padding: 0 0 20px 0;
        }

        .active-user {
            background-color: #502f51;
            border-radius: 0;
        }

        .chat-message-load {
            position: absolute;
            top: 0px;
            left: 0px;
            right: 0px;
            margin: 0 auto;
            background-color: #f2f2f2;
            z-index: 999;
            text-align: center;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        #LoadUser {
            padding: 10px;
            width: 90%;
            display: flex;
            justify-content: center;
            margin: 0 auto;
            border-radius: 2em;
            padding-right: 30px;
            background: #7b647c;
            color: white;
        }

            #LoadUser::-webkit-input-placeholder { /* Edge */
                color: #bcabbc
            }

            #LoadUser:-ms-input-placeholder { /* Internet Explorer 10-11 */
                color: #bcabbc
            }

            #LoadUser::placeholder {
                color: #bcabbc
            }

        .search-bar {
            position: relative;
        }

            .search-bar input {
                padding-right: 30px
            }

            .search-bar i {
                position: absolute;
                top: 13px;
                right: 30px;
                background: #7b647c;
                color: #bcabbc;
            }

        .resize-user-main-details {
            position: sticky;
            top: 0;
            background-color: #341535;
            z-index: 2;
        }

        .back-btn {
            display: none;
        }

        .user-sticky {
            float: right;
            margin-left: 15px;
            transform: rotate( 45deg);
            margin-right: 15px;
            /*padding-top: 5px;*/
        }

        .sticked-user {
            transform: rotate(0deg);
        }

        .sticky-data-show {
            position: fixed;
            width: 81.5%;
            text-align: center;
        }

            .sticky-data-show .btn.btn-show-previous-chat {
                margin: 0 auto;
                text-align: center;
                display: flex;
                padding: 0;
                font-size: 14px;
                padding: 5px 10px;
                border-radius: 16px;
                outline: 0;
                background-color: #bcabbc;
                border-color: #bcabbc;
                color: #341535;
                transition: all 0.5s ease-in-out;
            }

        .btn.btn-show-previous-chat:hover,
        .btn.btn-show-previous-chat:focus {
            background-color: #c8afc8;
            border-color: #c8afc8;
            outline: 0;
        }

        @@media (max-width:992px) {
            #leftSquare {
                width: 100%
            }

            .top-header {
                display: none;
            }

                .top-header.top-mobi-header {
                    display: block;
                    position: fixed;
                    height: 100%;
                }

            .sticky-after-scroll {
                height: 100vh
            }

            textarea#TxtMessage {
                width: 76%;
            }

            .TxtMessage {
                width: 76%;
            }

            .chat-input-box {
                box-shadow: none;
                position: absolute;
                width: 100%;
                bottom: 0;
            }

            #chatMessages {
                background: #ffffff;
                margin: 0px;
                height: 100%;
                padding-bottom: 7em;
                /* wa*/
            }

            .back-btn {
                display: block;
            }

            .resize-user-main-details {
                width: 100%;
                float: left;
            }
        }

        i.editGroupBtn {
            float: right;
            margin-right: 5px;
        }

        i.deleteGroupBtn {
            float: right;
            margin-right: 30px;
        }

        /*For User Status*/
        .status-circle-away {
            margin-right: 0px;
            width: 11px;
            height: 11px;
            border-radius: 50%;
            background-color: #f29d0a;
            border: 2px solid white;
            float: right;
            margin-top: -13px;
            overflow: overlay;
            position: relative;
        }

        .status-circle-dnd {
            margin-right: 0px;
            width: 11px;
            height: 11px;
            border-radius: 50%;
            background-color: #d40000;
            border: 2px solid white;
            float: right;
            margin-top: -13px;
            overflow: overlay;
            position: relative;
        }

        .status-circle-invisible {
            margin-right: 0px;
            width: 11px;
            height: 11px;
            border-radius: 50%;
            background-color: #87a8ff;
            border: 2px solid white;
            float: right;
            margin-top: -13px;
            overflow: overlay;
            position: relative;
        }

        .user-status-online {
            border-radius: 50%;
            width: 10px;
            height: 10px;
            background: #1ddc23;
            justify-content: space-evenly;
            color: white;
            margin-right: 3px;
            display: inline-flex
        }

        .user-status-away {
            border-radius: 50%;
            width: 10px;
            height: 10px;
            background: #f29d0a;
            justify-content: space-evenly;
            color: white;
            margin-right: 3px;
            display: inline-flex
        }

        .user-status-dnd {
            border-radius: 50%;
            width: 10px;
            height: 10px;
            background: #d40000;
            justify-content: space-evenly;
            color: white;
            margin-right: 3px;
            display: inline-flex
        }

        .user-status-invisible {
            border-radius: 50%;
            width: 10px;
            height: 10px;
            background: #87a8ff;
            justify-content: space-evenly;
            color: white;
            margin-right: 3px;
            display: inline-flex
        }

        .Send-Btn {
            position: absolute;
            right: 5.5%;
            top: 8px;
            padding: 6px 11px;
            border-radius: 20px;
            width: 40px;
            height: 40px;
            cursor: pointer;
            color: #fff;
            background-color: #341535;
            border-color: #341535;
        }

        /* added for notification */
        .switch {
            position: relative;
            display: inline-block;
            /*  width: 90px;
            height: 34px;*/
            bottom: 10px;
            /*left: 20px;*/
        }

            .switch input {
                display: none;
            }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            /*background-color: #ca2222;*/
            -webkit-transition: .4s;
            transition: .4s;
        }

            .slider:before {
                position: absolute;
                content: "";
                height: 12px;
                width: 12px;
                left: 4px;
                bottom: 3px;
                background-color: white;
                -webkit-transition: .4s;
                transition: .4s;
            }

        input:checked + .slider {
            /*background-color: #2ab934;*/
            background-color: #7b647c;
        }

        input:focus + .slider {
            box-shadow: 0 0 1px #2196F3;
        }

        input:checked + .slider:before {
            -webkit-transform: translateX(28px);
            -ms-transform: translateX(28px);
            transform: translateX(28px);
        }

        /*------ ADDED CSS ---------*/
        .on {
            display: none;
        }

        .on, .off {
            color: white;
            position: absolute;
            transform: translate(-50%,-50%);
            top: 50%;
            left: 50%;
            font-size: 10px;
            font-family: Verdana, sans-serif;
        }

        input:checked + .slider .on {
            display: block;
        }

        input:checked + .slider .off {
            display: none;
        }

        /*--------- END --------*/

        /* Rounded sliders */
        .slider.round {
            border-radius: 34px;
            height: 20px;
            width: 50px;
            border: 1px solid #bcabbc;
        }

            .slider.round:before {
                border-radius: 50%;
            }

        .notification_on {
            font-size: 12px;
            color: white;
            margin-right: 25px;
        }

        .notification_off {
            font-size: 12px;
            color: white;
            margin-left: 30px;
        }

        #leftSquare {
            /*min-width: 400px;*/
            min-width: 300px;
        }

        .profile {
            position: relative;
            top: 8px;
            max-width: 80px;
        }

            .profile #userStaticStatus {
                position: absolute;
                top: 27px;
                left: 45px;
            }

        @@media screen and (max-width:992px) {
            #row.user-status-top-header,
            #row.channels-box {
                height: 100%;
                width: 100%;
                position: relative;
                float: left;
            }

                #row.user-status-top-header .col:first-child {
                    width: 70%;
                    float: left;
                }

                #row.user-status-top-header .col:nth-child(2) {
                    float: right;
                    /*width: 15%;*/
                    /*width:5%;*/
                    margin: 0 0 0 auto;
                }

            .profile {
                width: 16.66666667%;
                min-width: 80px;
            }

            #row.user-status-top-header .dropdown.dropdown-status {
                float: right;
                width: 83.33333333%;
            }

            #row.channels-box span#channels {
                width: 90%;
                float: left;
            }

            #row.channels-box i.add {
                float: right;
                width: 5%;
                margin: 0 auto !important;
            }

            #row.channels-box .toggle_btn {
                float: right;
                width: 5%;
            }

            #row.channels-box i.add,
            #row.channels-box .toggle_btn {
                text-align: right;
            }

            .search-bar {
                position: relative;
                float: left;
                width: 100%;
                padding: 0 25px;
            }

                .search-bar #LoadUser {
                    width: 100%;
                }

                .search-bar i {
                    right: 50px;
                }

            #GroupMembers {
                float: left;
                width: 100%;
            }

            .resize-user-main-details .col-md-10 {
                display: flex;
                align-items: center;
                justify-content: space-around;
            }
        }

        @@media screen and (max-width:480px) {

            #row.user-status-top-header .col:nth-child(2) {
                /*width: 20%;*/
            }

            #row.user-status-top-header .dropdown.dropdown-status {
                /*width: 20%;*/
            }

            #row.user-status-top-header .col:first-child {
                width: 100%;
            }

            #row.channels-box span#channels {
                width: 80%;
                float: left;
            }

            #row.channels-box i.add {
                float: right;
                width: 10%;
                margin: 0 auto;
            }

            #row.channels-box .toggle_btn {
                float: right;
                width: 10%;
            }
        }

        #userStaticStatus {
            position: relative;
            bottom: 16px;
            /* right: -16px; */
            left: 18px;
        }

        .searchStatus {
            left: 10px;
        }

        .loader:before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            display: block;
            background: rgba(0,0,0,0.3);
            width: 100%;
            height: 100%;
        }

        .loader img {
            border: 0;
            width: 100%;
            height: 100%;
            max-width: 50px;
            max-height: 50px;
            z-index: 99;
        }

        .loader {
            float: left;
            width: 100%;
            height: 100%;
            position: fixed;
            left: 0;
            right: 0;
            top: 0;
            bottom: 0;
            z-index: 99999;
            background: rgba(0, 0, 0, 0);
            user-select: none;
            -moz-user-select: none;
            -khtml-user-select: none;
            -webkit-user-select: none;
            -o-user-select: none;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .loading_img {
            border: 6px solid #f3f3f3;
            border-top: 6px solid #341535;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
        }

        .grp_name {
            float: left;
            width: 70%;
            padding-bottom: 11px;
        }

        .grp_action {
            float: right;
        }

        @@keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        .signout{
            color:white !important;
        }
    </style>
</head>
<body>
    <input type="hidden" id="SignalRGroupName" />

    <input type="hidden" id="SignalR_To_ID" />

    <input type="hidden" id="SignalR_From_ID" />

    <input type="hidden" id="isPrivateChat" />

    <input type="hidden" id="SignalR_TO_DB_ID" />

    <input type="hidden" id="RingcentralCallStart" value="false" />

    <input type="file" id="ChatAttachment" style="display:none;" multiple />

    <input type="hidden" id="ChatId" />
    @*<input type="hidden" id="IsEdited" />*@
    <input type="hidden" id="DyId" />
    <div class="animated slideInLeft" id="square">

        <div class="animated bounceInUp sticky-after-scroll" id="leftSquare">
            <div class="resize-user-main-details">
                <div id="row" class="user-status-top-header row no-gutters">

                    <div class="col col-md-8 col-sm-10" style="padding:0px !important">
                        <div class="col-md-6 col-sm-6 profile">
                            @if (ProjectSession.LoginChatUserDetails != null && ProjectSession.LoginChatUserDetails.FirstName != null && ProjectSession.LoginChatUserDetails.LastName != null)
                            {
                                if (string.IsNullOrEmpty(ProjectSession.LoginChatUserDetails.ImageName))
                                {
                                    <div class="chatAvatar"><div> @ProjectSession.LoginChatUserDetails.FirstName.Substring(0, 1)@ProjectSession.LoginChatUserDetails.LastName.Substring(0, 1)</div></div>
                                    <div id="userStaticStatus"></div>
                                }
                                else
                                {
                                    <img class="user-img-profile" src="@ProjectSession.LoginChatUserDetails.ImageURL" alt=""/>
                                    <div id="userStaticStatus"></div>
                                }
                            }
                        </div>
                        <div class="col-md-6 col-sm-6 dropdown  dropdown-status">
                            <div id="subtitle"> @ProjectSession.LoginChatUserDetails.FirstName @ProjectSession.LoginChatUserDetails.LastName</div>

                            <button class="btn-default dropdown-toggle" type="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="true" id="selectstatus">
                                @*<div id="userStaticStatus"></div>*@ <span id="staticStatusSpan">Active</span>

                                <!--@*<div id="circle"></div> Active*@-->
                                @*<span class="caret">
                                    </*@
                                    <span class="caret"></span>
                            </button>

                            <ul class="dropdown-menu" aria-labelledby="selectstatus">
                                <li class="userStatus"><a href="#"><i class="fa fa-check "></i>Active</a></li>
                                <li class="userStatus"><a href="#"><i></i>Away</a></li>
                                <li class="userStatus"><a href="#"><i></i>Do not Distrub</a></li>
                                <li class="userStatus"><a href="#"><i></i>Invisible</a></li>
                            </ul>
                            <!--<div class="row dropdown-toggle" data-toggle="dropdown" aria-haspopup="true" aria-expanded="true" id="selectstatus">-->
                            @*<div id="userStaticStatus"></div>*@
                            <!--<span id="staticStatusSpan" style="font-size:12px;">Active</span>
                                <span class="caret"></span>
                                <ul class="dropdown-menu" aria-labelledby="selectstatus">
                                    <li class="userStatus"><a href="#"><i class="fa fa-check "></i>Active</a></li>
                                    <li class="userStatus"><a href="#"><i></i>Away</a></li>
                                    <li class="userStatus"><a href="#"><i></i>Do not Distrub</a></li>
                                    <li class="userStatus"><a href="#"><i></i>Invisible</a></li>
                                </ul>
                            </div>-->
                        </div>

                    </div>
                    <div class="col col-md-3 col-sm-1">
                        <label class="switch">
                            <input type="checkbox" id="togBtn" />
                            <div class="slider round">
                                <span class="on"><i class="fa fa-bell notification_on" aria-hidden="true"></i></span>
                                <span class="off">
                                    <i class="fa fa-bell-slash notification_off" aria-hidden="true"></i>
                                </span>

                            </div>
                        </label>
                    </div>
                    <div class="col col-md-1 col-sm-1">
                        <a class="signout"  href="@Url.Action("Logout", "Login")"><i title="Logout" class="fa fa-sign-out fa-lg"></i></a>
                        @*<button type="button" class="signout"><i class="fa fa-sign-out" aria-hidden="true"></i></button>*@
                    </div>
                    <!--<div class=" col col-md-4 dropdown dropdown-status">-->
                    @*<button class="btn btn-default dropdown-toggle" type="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="true" id="selectstatus" onchange="UpdateUserStatus();">*@
                    <!--<!--<button class="btn btn-default dropdown-toggle" type="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="true" id="selectstatus">
                    <div id="userStaticStatus"></div> <span id="staticStatusSpan">Active</span>-->
                    -->
                    <!--@*<div id="circle"></div> Active*@-->
                    <!--<!--<span class="caret"></span>
                    </button>-->
                    <!--@* for userStatus class on click method defined for change status *@
                        @*<ul class="dropdown-menu" aria-labelledby="selectstatus">
                            <li class="userStatus"><a href="#"><i class="fa fa-check "></i>Active</a></li>
                            <li class="userStatus"><a href="#"><i></i>Away</a></li>
                            <li class="userStatus"><a href="#"><i></i>Do not Distrub</a></li>
                            <li class="userStatus"><a href="#"><i></i>Invisible</a></li>
                        </ul>*@
                    </div>-->



                </div>

                <div id="rightIcons" class="search-bar">
                    <input class="search" id="LoadUser" placeholder="Search" type="text">
                    <i class="fa fa-search"></i>
                </div>
                <div id="row" class="channels-box">
                    <span id="channels" class="channel_title" style="font-weight: bold;">CHANNELS<span id="GroupCount"></span></span>
                    <i class="add fa fa-plus-circle fa-inverse" aria-hidden="true" style="margin-left: 130px;" onclick="AddEditGroup(0)" title="create roup"></i>  @*margin-left:200px*@
                    <div class="toggle_btn" id="btn_toggle" style="float:right;">
                        <i class="fa fa-chevron-down" id="showChannel" aria-hidden="true" style="color: #bcabbc;display:none"></i>
                        <i class="fa fa-chevron-up" id="hideChannel" aria-hidden="true" style="color: #bcabbc;"></i>
                    </div>
                </div>

            </div>
            <div class="row">
                <div id="GroupMembers">
                </div>
                <span class="chat-badge" id="parentChatBadge" style="display:none;position:fixed;right:20px;bottom:125px">0</span>
            </div>
            <div id="row" class="fixme" style="justify-content: space-between; background: linear-gradient(#341535 100%, #341535 100%);position: sticky; top: 0">
                <span style="font-size:14px; font-weight:bold;">DIRECT MESSAGES<span id="DirectMessage"></span></span>

                <div class="toggle_btn" id="btn_toggle_directMsg" style="float:right;">
                    <i class="fa fa-chevron-down" id="showDirectMsg" aria-hidden="true" style="color: #bcabbc;display:none"></i>
                    <i class="fa fa-chevron-up" id="hideDirectMsg" aria-hidden="true" style="color: #bcabbc;"></i>
                </div>


            </div>
            <div class="chatListParent" id="row">
                <div id="ChatListDiv">

                </div>

                <span class="chat-badge" id="parentChatBadge" style="display:none;position:fixed;right:20px;bottom:125px">0</span>
            </div>

        </div>
        <div class="top-header" style="width: 100%">

            <div class="chat-message-load">
                <img src="~/Images/i_chat_message1.png" alt=""/>
            </div>
            <div class="animated bounceInDown resizetopheader user-active-header" id="headeruser">
                @*id="headeruser"*@
                <a class="back-btn" style="padding-top: 0px;padding-left: 15px; font-weight:bold;" onclick="hideChat();"><i class="fa fa-angle-left" style="font-size:26px; color:#341535"></i></a>
                <div class="user-profile-img" style="padding-top: 10px;padding-left: 10px;"><div class="chatAvatar openChatbox"></div></div>
                <div class="channel-top" id="TopChannelDiv">
                    <h4 id="channel-title">
                        <b>@ProjectSession.LoginChatUserDetails.FirstName @ProjectSession.LoginChatUserDetails.LastName</b>
                    </h4>
                </div>
            </div>
            <div class="chatmsgs resizemains" id="chatMessages">
                <div class="sticky-data-show">
                    <button class="btn btn-show-previous-chat">Show Previous Message</button>
                </div>
            </div>
            <div class="col-lg-12 resizebottom chat-input-box">
                <div class="chatPanel">
                    <div class="col-sm-12 emojiPanel" id="diveEmojiPanel">
                        @Html.Partial("_PartialViewEmojis")
                    </div>
                    <div class="input-group" style="display: inline-table;">
                        <div class="input-group-btn">
                            <button class="btn btn-default btn-smile btn-sm" onclick="toggleEmojis()">
                                <i class="fa fa-smile-o" aria-hidden="true"></i>
                            </button>
                        </div>
                        <div class="input-group-btn">
                            <button class="btn btn-default btn-sm btn-attachment" onclick="toggleChatAttachment()">
                                <i class="fa fa-paperclip" aria-hidden="true"></i>
                                <span id="ChatAttachmentBadge" class="badge" style="position:absolute;top:-15px;left:15px;z-index:5;background-color:red;display:none">0</span>
                            </button>
                        </div>
                        @*<input id="TxtMessage" type="text" data-emoji-input="unicode" data-emojiable="true" class="form-control input-sm smalltxt" placeholder="Type your message here...">*@

                        <textarea id="TxtMessage" data-emoji-input="unicode" data-emojiable="true" class="input-sm smalltxt" placeholder="Type your message here..."></textarea>
                        <button class="btn btn-default Send-Btn" onclick="sendMessage()">
                            <i class="fa fa-paper-plane"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="loader">
        @*<img src="~/Content/Images/chat_loader1.gif" alt="Loading..." />*@
        <div class="loading_img"></div>
    </div>
</body>
</html>
<!-- Add Edit Group Modal -->
<div class="modal fade" id="AddEditGroupModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
    <div class="vertical-alignment-helper">
        <div class="modal-dialog vertical-align-center modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal">
                        <span aria-hidden="true">&times;</span><span class="sr-only">Close</span>
                    </button>
                    <h4 class="modal-title">Group Details</h4>
                </div>
                <div class="modal-body">
                    <div id="idGroupModelBody">

                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-primary" onclick="SaveSignalRGroupDetail()">Save</button>
                    <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://code.jquery.com/jquery-3.1.1.min.js"></script>
<script src="~/Scripts/jquery-1.12.4.min.js"></script>
<script src="~/Scripts/jquery.validate.min.js"></script>
<script src="~/Scripts/jquery.validate.unobtrusive.min.js"></script>
<script src="~/Scripts/toastr.min.js"></script>
<script src="~/Scripts/jquery-ui-1.12.1.min.js"></script>
<script src="~/Scripts/jquery.signalR-2.4.1.min.js"></script>
<script src="~/signalr/Hubs"></script>
<script src="~/Scripts/bootstrap.min.js"></script>
<script src="~/Scripts/toastr.min.js"></script>
<script src="~/Scripts/bootbox.js"></script>
<script type="text/javascript">
    var chat;
    var emojiCode = [];
    var lastChatInd = 0;
    var DeleteChannel = false;

    $(document).ready(function () {
        $('.loader').hide();
       /* $('.loading_img').hide();*/
        $(".toggle").css("display", "none");

        //$(document).click(function () {
        //    var container = $(".toggle");
        //    if (!container.is(event.target) && !container.has(event.target).length) {
        //        container.css("display","none");
        //    }
        //});

        window.addEventListener('mouseup', function (event) {
            var toggle = $('.toggle');
            if (event.target != toggle && event.target.parentNode != toggle) {
                toggle.css("display", "none");
            }
        });

        $('#LoadUser').keyup(function () {
            GetUserName();
        });
        $(window).scroll(function () {
            if ($(this).scrollTop() > 50) {

                if ($("#lblheadertxt").html() == '') {
                    $("#divlblheader").hide();
                }
                else {
                    $("#divlblheader").show();
                }
                $('#back-to-top').fadeIn();

                //$('#back-to-toptext').fadeIn();
            } else {
                $('#back-to-top').fadeOut();
                //$('#back-to-toptext').fadeOut();
            }
        });
        toastr.options = {
            "closeButton": true,
            "debug": false,
            "positionClass": "toast-bottom-right",
            "onclick": null,
            "showDuration": "1000",
            "hideDuration": "1000",
            "timeOut": "5000",
            "extendedTimeOut": "1000",
            "showEasing": "swing",
            "hideEasing": "linear",
            "showMethod": "fadeIn",
            "hideMethod": "fadeOut"
        };
        ConnectWithSignalR();
        //intervalval = setInterval(function () {

        //   // ConnectWithSignalR();
        //    //LoadPrivateChatFromDB()
        //    if ($("#isPrivateChat").val().toString().toLowerCase() === "true")
        //        LoadPrivateChatFromDB()
        //    else
        //        LoadGroupChatFromDB()
        //}, 30000);
        //window.addEventListener('beforeunload', function (event) {
        //    clearInterval(intervalval);
        //});
        $("#ChatAttachment").change(function (event) {
            if (event.target.files.length > 0) {
                $("#ChatAttachmentBadge").show();
                $("#ChatAttachmentBadge").html(event.target.files.length);
                $('#TxtMessage').val('').focus();
            }
            else {
                $("#ChatAttachmentBadge").hide();
                $("#ChatAttachmentBadge").html(0);
            }
        });
        if (window.Notification && Notification.permission !== "granted") {
                Notification.requestPermission(function (status) {
                    if (Notification.permission !== status) {
                        Notification.permission = status;
                    }
                });
        }
        GetUserStatus();
        //let UserOnlineStatusId = "";
        //let UserOnlineStatus = UserOnlineStatusId == 2 ? "Away" : UserOnlineStatusId == 3 ? "Do not Distrub" : UserOnlineStatusId == 4 ? "Invisible" : "Active";
        //let status = UserOnlineStatusId == 2 ? $("#userStaticStatus").addClass("user-status-away") : UserOnlineStatusId == 3 ? $("#userStaticStatus").addClass("user-status-dnd") : UserOnlineStatusId == 4 ? $("#userStaticStatus").addClass("user-status-invisible") : $("#userStaticStatus").addClass("user-status-online");
        //$("#staticStatusSpan").text(UserOnlineStatus);
        //$("li.userStatus").each(function () {
        //    if ($(this).find("a").text() == UserOnlineStatus) {
        //        $("i.fa-check").removeClass("fa fa-check");
        //        $(this).find("a").find("i").addClass("fa fa-check");
        //    }
        //});
        //$.connection.hub.disconnected(function () {
        //    setTimeout(function () {
        //        $.connection.hub.start();
        //    }, 5000); // Restart connection after 5 seconds.
        //});



        $("#btn_toggle").click(function () {
            $("#GroupMembers").toggle();
            var val = $("#GroupMembers").css("display");
            if (val == "block") {
                $("#showChannel").css({ "display":"none"});
                $("#hideChannel").css({ "display": "block" });
            }
            else {
                $("#showChannel").css({ "display": "block" });
                $("#hideChannel").css({ "display": "none" });
            }

        });
        $("#btn_toggle_directMsg").click(function () {
            $("#ChatListDiv").toggle();
            var val = $("#ChatListDiv").css("display");
            if (val == "block") {
                $("#showDirectMsg").css({ "display": "none" });
                $("#hideDirectMsg").css({ "display": "block" });
            }
            else {
                $("#showDirectMsg").css({ "display": "block" });
                $("#hideDirectMsg").css({ "display": "none" });
            }

        });
    });


    function ConnectWithSignalR() {
        chat = $.connection.chatHub;

        chat.client.PublicMessage = function (Cl_Name, Cl_Message) {
            console.log(Cl_Name, Cl_Message);
            if (Cl_Name === "NewJoin" || Cl_Name === "Disconnect") {
                //DeleteChannel = true;
                    loadChatContact();
                //LoadPrivateChatFromDB();
               // LoadGroupChatFromDB();

            }
            if (Cl_Name === "DeleteChannel") {
                var val = $("#SignalR_TO_DB_ID").val();
                if (val === Cl_Message) {
                    DeleteChannel = true;
                }
                //DeleteChannel = true;
                loadChatContact();
            }
        };
        chat.client.PrivateMessage = function (Cl_From_Id, Cl_Name, Cl_Message, ChatId, IsEdit) {

            let UserName = '@ProjectSession.LoginChatUserDetails.FirstName' + ' ' + '@ProjectSession.LoginChatUserDetails.LastName';
            console.log(Cl_From_Id, Cl_Name, Cl_Message);
            if (Cl_Name === UserName) {

                if (ChatId != '' && IsEdit == true) {
                    $("#msg_" + ChatId).val(htmlEncode(Cl_Message));

                }
                else if (ChatId != '' && IsEdit == false) {
                    $("#otherside_" + ChatId).parent().parent().remove();
                }
                else {
                    $('#chatMessages').append('<div class="msg_b">' + htmlEncode(Cl_Message) + '</div>');
                }

            }
            else {

                if (Cl_From_Id === $('#SignalR_To_ID').val()) {

                        var userprofile_src = $("#headeruser img").attr("src");
                        if (ChatId != '' && IsEdit == true) {
                            $("#otherside_" + ChatId).text(htmlEncode(Cl_Message));
                        }
                        else if (ChatId != '' && IsEdit == false) {
                            $("#otherside_" + ChatId).parent().parent().remove();
                        } else {
                            if (userprofile_src) {
                                if (Cl_Message.length > 0)
                                    $('#chatMessages').append(
                                        '<div class="message-with-profile" style="display:flex;width:100%">'
                                        + '<div class="user-profile-img" style="padding-top:0px;padding-left: 0;display: inline-block;float: left;">'
                                        + '    <div class="chatAvatar openChatbox msghistoryUser">'
                                        + '<img class="chatAvatar" src="' + userprofile_src + '">'
                                        + '</div></div>'
                                        + '	<div class="user-pro-nm">'
                                        /*+ '<label class="msg-time" style="padding-right: 22%;">' + formatAMPM(new Date()) + '</label>'*/
                                        + '<label class="msg-time">' + formatAMPM(new Date()) + '</label>'
                                        + '<div class="msg_a">' + htmlEncode(Cl_Message) + '</div>'
                                        + '</div></div>'

                                    );
                            }
                            else {
                                var userInitial = $("#headeruser h4")[0].outerText;
                                if (Cl_Message.length > 0)
                                    $('#chatMessages').append(
                                        '<div class="message-with-profile" style="display:flex;width:100%">'
                                        + '<div class="user-profile-img" style="padding-top:0px;padding-left: 0;display: inline-block;float: left;">'
                                        + '    <div class="chatAvatar openChatbox msghistoryUser">'
                                        + '<h4>' + userInitial + '</h4>'
                                        + '</div></div>'
                                        + '	<div class="user-pro-nm">'
                                        /*+ '<label class="msg-time" style="padding-right: 22%;">' + formatAMPM(new Date()) + '</label>'*/
                                        + '<label class="msg-time">' + formatAMPM(new Date()) + '</label>'
                                        + '<div class="msg_a">' + htmlEncode(Cl_Message) + '</div>'
                                        + '</div></div>'
                                    );
                            }

                    }
                    scrollChatDiv();
                    $("#chatMessages").html('');
                    LoadPrivateChatFromDB();


                }
                else {

                    if ($('#' + Cl_From_Id).length > 0 && $("#channel-title").text() == $('#' + Cl_From_Id).children(".user-profile-name").contents()[0].data) {
                        $("#SignalR_To_ID").val(Cl_From_Id)

                        if ($("#isPrivateChat").val() == 'true')//edited from true to 'true'
                            LoadPrivateChatFromDB()
                        else
                            LoadGroupChatFromDB()
                    }
                    else {

                        if (ChatId != '' && IsEdit == false) {
                            $("#otherside_" + ChatId).parent().parent().remove();
                        }

                        if (Cl_From_Id == $("#SignalR_To_ID").val()) {
                            if ($("#isPrivateChat").val() == 'true')//edited from true to 'true'
                                LoadPrivateChatFromDB()
                            else
                                LoadGroupChatFromDB()
                        }

                        let ChatListDiv = document.getElementById('ChatListDiv');
                        let htmlElement = document.getElementById(Cl_From_Id);
                        let nextHtmlElement_id = $("#" + Cl_From_Id).next().attr("id");
                        let nextElemet = document.getElementById(nextHtmlElement_id);
                        if (htmlElement) {
                            htmlElement.remove();
                        }

                        if (Cl_Message.length > 0 && htmlElement != null) {
                            let badgeVal = htmlElement.querySelector('.chat-badge').innerHTML;
                            badgeVal = parseInt(badgeVal) + 1;
                            htmlElement.querySelector('.chat-badge').style.display = "block";
                            htmlElement.querySelector('.chat-badge').innerHTML = badgeVal;
                        }
                        ChatListDiv.insertBefore(htmlElement, nextElemet);
                        //ChatListDiv.insertBefore(htmlElement, ChatListDiv.firstChild);
                        mainChatBadgeValue();
                        /*var title = Cl_Name + badgeVal;*/
                        if (Cl_Message.length > 0)
                            /*sendNotificationToWindow(title, htmlEncode(Cl_Message));*/
                        sendNotificationToWindow(Cl_Name, htmlEncode(Cl_Message));
                    }


                }
            }
            //scrollChatDiv();
            //$("#chatMessages").html('');
            //LoadPrivateChatFromDB();

        };
        chat.client.broadcastMessage = function (name, message) {
            $('#discussion').append('<li><strong>' + name
                + '</strong>:&nbsp;&nbsp;' + message + '</li>');

        };
        chat.client.SayWhoIsTyping = function (html) {
            $('#TxtMessage').val(htmlEncode(html));
            console.log(htmlEncode(html));
            setInterval(function () { $('#TxtMessage').val(''); }, 5000);
        };
        @*chat.client.updateMessages = function () {
             let UserName = '@ProjectSession.LoginUserDetails.FirstName' + ' ' + '@ProjectSession.LoginUserDetails.LastName';
            console.log(Cl_From_Id, Cl_Name, Cl_Message);
            if (Cl_Name === UserName) {
                $('#chatMessages').append('<div class="msg_b">' + htmlEncode(Cl_Message) + '</div>');
            }
            else {
                if (Cl_From_Id === $('#SignalR_To_ID').val()) {

                    $('#chatMessages').append(
                        '<div class="msg_a">' + htmlEncode(Cl_Message) + '</div>'
                        + '<label class="msg-time" style="padding-right: 22%;">' + formatAMPM(new Date()) + '</label>'
                    );

                }
                else {
                    let ChatListDiv = document.getElementById('ChatListDiv');
                    let htmlElement = document.getElementById(Cl_From_Id);
                    htmlElement.remove();
                    let badgeVal = htmlElement.querySelector('.chat-badge').innerHTML;
                    badgeVal = parseInt(badgeVal) + 1;
                    htmlElement.querySelector('.chat-badge').style.display = "block";
                    htmlElement.querySelector('.chat-badge').innerHTML = badgeVal;
                    ChatListDiv.insertBefore(htmlElement, ChatListDiv.firstChild);
                    mainChatBadgeValue();
                    sendNotificationToWindow(Cl_Name, htmlEncode(Cl_Message));
                }
            }
        };*@
        $('#TxtMessage').focus();
        chat.client.GroupMessage = function (msgFrom, msg, GroupName, ChatId, IsEdit) {

            var UserName = '@ProjectSession.LoginChatUserDetails.FirstName' + ' ' + '@ProjectSession.LoginChatUserDetails.LastName';
            if (GroupName === $('#SignalRGroupName').val()) {

                 if (msgFrom === UserName) {

                    //$('#chatMessages').append(
                    //        '<label class="msg-time">' + formatAMPM(new Date()) + '</label>'
                    //        + '<div class="msg_b">' + htmlEncode(msg) + '</div>'
                    //    );

                    if (ChatId != '' && IsEdit == true) {
                        $("#msg_" + ChatId).val(htmlEncode(msg));
                    }
                    else if (ChatId != '' && IsEdit == false) {
                        $("#otherside_" + ChatId).parent().parent().remove();
                    }
                    else {
                        if (msg.length > 0) {

                            $('#chatMessages').append(
                            '<label class="msg-time">' + formatAMPM(new Date()) + '</label>'
                            + '<div class="msg_b">' + htmlEncode(msg) + '</div>'
                            );

                            //LoadGroupChatFromDB();
                            //lastChatInd = 1 + lastChatInd;
                            //$('#chatMessages').append(
                            //    //'<label class="msg-time">' + formatAMPM(new Date()) + '</label>'
                            //    //+ '<div class="msg_b">' + htmlEncode(msg) + '</div>'

                            //    '<div class="msg_b_row"><div class="msg_b">' + htmlEncode(msg)+'</div>'
                            //    + '<div class="msg_b_menu" id="Msg_Menu_' + lastChatInd + '" onclick="ShowPopup(' + lastChatInd +',${data.Data[i].PersonalChatId});">'
                            //        + '<i class="fa fa-ellipsis-v"></i><div class="chat_option" id="chat_option_${i}">'
                            //            + '<span onclick="EditMessage(${data.Data[i].PersonalChatId},${i})">Edit</span>'
                            //        + '<span onclick="RemoveMessage(${data.Data[i].PersonalChatId},${i})"   >Remove</span></div>'
                            //    + '</div></div><label class="msg-time" id="Msg_Time_${i}" style="">${data.Data[i].StrMsgDateTime}</label>'
                            //);
                        }
                    }


                }
                //else if (ChatId != '' && IsEdit == false) {
                //    $("#otherside_" + ChatId).parent().parent().remove();
                //}
                else {

                    if (ChatId == 0) {
                        var strIntial = "";

                        var initial = msgFrom.split(" ");
                        if (initial.length > 0) {
                            strIntial = initial[0].charAt(0);
                            if (initial.length > 1) {
                                strIntial += initial[1].charAt(0);
                            }
                        }

                        //var initial = data.Data[i].UserName.split(" ");
                        //if (initial.length > 0) {
                        //    strIntial = initial[0].charAt(0);
                        //    if (initial.length > 1) {
                        //        strIntial += initial[1].charAt(0);
                        //    }

                        //}

                        if (IsEdit == true) {
                            $('#chatMessages').append(

                                '<div class="message-with-profile" style="display:flex;width:100%">'
                                + '<div class="user-profile-img" style="padding-top:0px;padding-left: 0;display: inline-block;float: left;">'
                                + '<div class="chatAvatar openChatbox msghistoryUser"><h4>' + strIntial + '</h4></div>'
                                + '</div>'
                                + '<div class="user-pro-nm">'
                                + '<label class="msg-time lbl_msg_sender_a 11">' + msgFrom + '&nbsp;<span>' + formatAMPM(new Date()) + '</span></label>'
                                + '<div class="msg_a">' + htmlEncode(msg) + '</div>'
                                + '</div>'
                                + '<div class="edit_icon"><i class="fa fa-pencil" title="This message has been edited"></i></div>'/*edited*/
                                + '</div>'
                            );
                        }

                    }

                    else if (ChatId != 0 && IsEdit == true) {
                        $("#otherside_" + ChatId).text(msg);
                    }
                    else if (ChatId != 0 && IsEdit == false){
                        $("#otherside_" + ChatId).parent().parent().remove();
                    }
                }
                scrollChatDiv();
                $("#chatMessages").html('');
                LoadGroupChatFromDB();
                //UpdateUnReadCount(ChatId);

            }
            else {

                let ChatListDiv = document.getElementById('GroupMembers');
                let htmlElement = document.getElementById(GroupName);
                var badgeVal = htmlElement.querySelector('.chat-badge').innerHTML;
                badgeVal = parseInt(badgeVal) + 1;
                htmlElement.querySelector('.chat-badge').style.display = "block";
                htmlElement.querySelector('.chat-badge').innerHTML = badgeVal;
                ChatListDiv.insertBefore(htmlElement, ChatListDiv.firstChild);
                mainChatBadgeValue();
               // var title = msgFrom + badgeVal;
                if (msg.length > 0)
                    /*sendNotificationToWindow(title, htmlEncode(msg));*/
                sendNotificationToWindow(msgFrom, htmlEncode(msg));

            }
        };

        $.connection.hub.disconnected(function (data) {
            console.log("disconnected server");
            $(".loader").show();
            setTimeout(function () {
                $.connection.hub.start().done(function (data) {
                    $(".loader").hide();
                    console.log("connected");
                    $('#message').keypress(function (e) {
                      var encodedName = $('<div/>').text("@ProjectSession.LoginChatUserDetails.FirstName @ProjectSession.LoginChatUserDetails.LastName" + " is Typing..").html();
                      chat.server.isTyping(encodedName);
                    });
                    $("#SignalR_From_ID").val(data.id);
                    SaveSignalRUserNGetContacts();
                    //LoadPrivateChatFromDB();
                   // LoadGroupChatFromDB();
                }).fail(function (er) {
                    console.log("Hub error", er);
                });
           }, 5000); // Restart connection after 5 seconds.
        });

        //$.connection.hub.disconnected = function (data) {
        //    $(".loader").show();
        //    console.log("Server disconnected", data);
        //    setInterval(function () {
        //        $.connection.hub.start().done(function (data) {
        //            $("#SignalR_From_ID").val(data.id);
        //            SaveSignalRUserNGetContacts();
        //        }).fail(function (er) {
        //            console.log("Hub error", er);
        //        });
        //    }, 5000);
        //    console.log("Server disconnected", data);
        //};
        // // connecting: 0, connected: 1, reconnecting: 2, disconnected: 4
        $.connection.hub.stateChanged = function (change) {
            console.log(change);
            if (change.newState === $.signalR.connectionState.reconnecting) {
                console.log("liveFeed is reconnecting!");
                //$.connection.hub.start().done(function (data) {
                //    $("#SignalR_From_ID").val(data.id);
                //    SaveSignalRUserNGetContacts();
                //}).fail(function (er) {
                //    console.log("Hub error", er);
                //});
            }
            else if (change.newState === $.signalR.connectionState.connected) {
                console.log("liveFeed is connected!");

            }
            while (change.newState === $.signalR.connectionState.disconnected) {
                console.log("in while loop reconnecting server");

                $.connection.hub.start().done(function (data) {
                     $('#message').keypress(function (e) {
                      var encodedName = $('<div/>').text("@ProjectSession.LoginChatUserDetails.FirstName @ProjectSession.LoginChatUserDetails.LastName" + " is Typing..").html();
                      chat.server.isTyping(encodedName);
                    });
                    $("#SignalR_From_ID").val(data.id);
                    SaveSignalRUserNGetContacts();
                    //LoadPrivateChatFromDB();
                    //LoadGroupChatFromDB();
                }).fail(function (er) {
                    console.log("Hub error", er);
                });
            }
        };

        $.connection.hub.start().done(function (data) {
            @*$('#TxtMessage').keypress(function (e) {
              var encodedName = $('<div/>').text("@ProjectSession.LoginUserDetails.FirstName @ProjectSession.LoginUserDetails.LastName" + " is Typing..").html();
              chat.server.isTyping(encodedName);
            });*@
            $("#SignalR_From_ID").val(data.id);
            SaveSignalRUserNGetContacts();
        }).fail(function (er) {
            console.log("Hub error", er);
        });


    }
    function triggerNewJoinAlert() {
        chat.server.newJoinAlert($('#SignalR_From_ID').val());
    }
    function privateChat(Message, ChatId, IsEdit) {
        var UserName = '@ProjectSession.LoginChatUserDetails.FirstName' + ' ' + '@ProjectSession.LoginChatUserDetails.LastName';
        if (Message) {

            //var tags = Message.split(',');
            //  for (var i = 0; i < tags.length; i++) {


            if (IsEdit) {
                var i = $('#DyId').val();
                var el = $("#Msg_" + i);
                var p_el = el.parents('div').eq(0);
                var isedited = $('div:first', p_el).attr('class');
                if (isedited != "edit_icon") {
                    p_el.prepend(`<div class="edit_icon" id="editIcon_${i}"><i class="fa fa-pencil" title="This message has been edited"></i></div>`);
                }

                $('#Msg_' + $('#DyId').val()).text(Message);
            }
            else {
                
                if (Message.charAt(0) != "<") {
                    var i = 0;
                    if ($('#chatMessages div.msg_b:last').length > 0) {
                        i = parseInt($('#chatMessages div.msg_b:last').attr('id').split("_")[1]);
                        i = i + 1;

                        var lastdiv = $('div:last', '#chatMessages').attr('class');
                        var current_time = formatAMPM(new Date());
                        var time = $('label:last', '#chatMessages').text();
                        var pre_time_str = time.split(" ")[0];
                        var pre_time_format = time.split(" ")[1];
                        var current_time_str = current_time.split(" ")[0];
                        var current_time_format = current_time.split(" ")[1];
                        var previous_time = $("#Msg_Time_" + (i - 1)).text();
                        var diff = Math.abs(parseInt(current_time_str.split(":")[1]) - parseInt(pre_time_str.split(":")[1]))
                     

                        if (lastdiv == "chat_option") {
                            if (diff <= 5) {
                                if (current_time_format == pre_time_format) {
                                    $('#chatMessages').append(

                                        `<label class="msg-time" id="Msg_Time_${i}" style="display:none">${formatAMPM(new Date())}</label>`
                                        + `<div class="msg_b_row"><div class="msg_b" title="${formatAMPM(new Date())}" id="Msg_${i}">${Message}</div>`
                                        + `<div class="msg_b_menu" id="Msg_Menu_${i}" onclick="ShowPopup(${i},${ChatId});">`
                                        + `<i class="fa fa-ellipsis-v"></i><div class="chat_option" id="chat_option_${i}">`
                                        + `<span onclick="EditMessage(${ChatId},${i})">Edit</span>`
                                        + `<span onclick="RemoveMessage(${ChatId},${i})">Remove</span></div>`
                                        + `</div></div>`

                                        //'<div class="msg_b">' + tags[i] + '</div>'
                                        //+ '<label class="msg-time">' + formatAMPM(new Date()) + '</label>'
                                    );
                                }
                                else {
                                    $('#chatMessages').append(

                                        `<label class="msg-time" id="Msg_Time_${i}" style="">${formatAMPM(new Date())}</label><div class="msg_b_row"><div class="msg_b" id="Msg_${i}">${Message}</div>`
                                        + `<div class="msg_b_menu" id="Msg_Menu_${i}" onclick="ShowPopup(${i},${ChatId});">`
                                        + `<i class="fa fa-ellipsis-v"></i><div class="chat_option" id="chat_option_${i}">`
                                        + `<span onclick="EditMessage(${ChatId},${i})">Edit</span>`
                                        + `<span onclick="RemoveMessage(${ChatId},${i})">Remove</span></div>`
                                        + `</div></div>`

                                        //'<div class="msg_b">' + tags[i] + '</div>'
                                        //+ '<label class="msg-time">' + formatAMPM(new Date()) + '</label>'
                                    );
                                }

                            }
                            else {
                                $('#chatMessages').append(


                                    `<label class="msg-time" id="Msg_Time_${i}" style="">${formatAMPM(new Date())}</label><div class="msg_b_row"><div class="msg_b" id="Msg_${i}">${Message}</div>`
                                    + `<div class="msg_b_menu" id="Msg_Menu_${i}" onclick="ShowPopup(${i},${ChatId});">`
                                    + `<i class="fa fa-ellipsis-v"></i><div class="chat_option" id="chat_option_${i}">`
                                    + `<span onclick="EditMessage(${ChatId},${i})">Edit</span>`
                                    + `<span onclick="RemoveMessage(${ChatId},${i})">Remove</span></div>`
                                    + `</div></div>`

                                    //'<div class="msg_b">' + tags[i] + '</div>'
                                    //+ '<label class="msg-time">' + formatAMPM(new Date()) + '</label>'
                                );
                            }
                        }
                        else {
                            $('#chatMessages').append(


                                `<label class="msg-time" id="Msg_Time_${i}" style="">${formatAMPM(new Date())}</label><div class="msg_b_row"><div class="msg_b" id="Msg_${i}">${Message}</div>`
                                + `<div class="msg_b_menu" id="Msg_Menu_${i}" onclick="ShowPopup(${i},${ChatId});">`
                                + `<i class="fa fa-ellipsis-v"></i><div class="chat_option" id="chat_option_${i}">`
                                + `<span onclick="EditMessage(${ChatId},${i})">Edit</span>`
                                + `<span onclick="RemoveMessage(${ChatId},${i})">Remove</span></div>`
                                + `</div></div>`

                                //'<div class="msg_b">' + tags[i] + '</div>'
                                //+ '<label class="msg-time">' + formatAMPM(new Date()) + '</label>'
                            );
                        }
                    }
                    else {
                        i = i + 1;

                            $('#chatMessages').append(


                                `<label class="msg-time" id="Msg_Time_${i}" style="">${formatAMPM(new Date())}</label><div class="msg_b_row"><div class="msg_b" id="Msg_${i}">${Message}</div>`
                                + `<div class="msg_b_menu" id="Msg_Menu_${i}" onclick="ShowPopup(${i},${ChatId});">`
                                + `<i class="fa fa-ellipsis-v"></i><div class="chat_option" id="chat_option_${i}">`
                                + `<span onclick="EditMessage(${ChatId},${i})">Edit</span>`
                                + `<span onclick="RemoveMessage(${ChatId},${i})">Remove</span></div>`
                                + `</div></div>`

                                //'<div class="msg_b">' + tags[i] + '</div>'
                                //+ '<label class="msg-time">' + formatAMPM(new Date()) + '</label>'
                            );
                        
                    }
                       /*  var i = parseInt($('#chatMessages div.msg_b:last').attr('id').split("_")[1]);*/
                         /*var i = parseInt($('div:last', '#chatMessages').attr('id').split("_")[2]);*/
                      
                }
                else {
                         var i = 0;
                         if ($('#chatMessage div.msg_b:last').length > 0) {
                             i = parseInt($('#chatMessages div.msg_b:last').attr('id').split("_")[1]);

                             i = i + 1;

                             var lastdiv = $('div:last', '#chatMessages').attr('class');
                             var current_time = formatAMPM(new Date());
                             var time = $('label:last', '#chatMessages').text();
                             var pre_time_str = time.split(" ")[0];
                             var pre_time_format = time.split(" ")[1];
                             var current_time_str = current_time.split(" ")[0];
                             var current_time_format = current_time.split(" ")[1];
                             var previous_time = $("#Msg_Time_" + (i - 1)).text();
                             var diff = Math.abs(parseInt(current_time_str.split(":")[1]) - parseInt(pre_time_str.split(":")[1]))

                             if (lastdiv == "chat_option") {
                                 if (diff <= 5) {
                                     if (current_time_format == pre_time_format) {
                                         $('#chatMessages').append(

                                             `<label class="msg-time" id="Msg_Time_${i}" style="display:none">${formatAMPM(new Date())}</label>`
                                             + `<div class="msg_b_row"><div class="msg_b" title="${formatAMPM(new Date())}" id="Msg_${i}">${Message}</div>`
                                             + `<div class="msg_b_menu" id="Msg_Menu_${i}" onclick="ShowPopup(${i},${ChatId});">`
                                             + `<i class="fa fa-ellipsis-v"></i><div class="chat_option" id="chat_option_${i}">`
                                             /*+ `<span onclick="EditMessage(${ChatId},${i})">Edit</span>`*/
                                             + `<span onclick="RemoveMessage(${ChatId},${i})">Remove</span></div>`
                                             + `</div></div>`

                                             //'<div class="msg_b">' + tags[i] + '</div>'
                                             //+ '<label class="msg-time">' + formatAMPM(new Date()) + '</label>'
                                         );
                                     }
                                     else {
                                         $('#chatMessages').append(

                                             `<label class="msg-time" id="Msg_Time_${i}" style="">${formatAMPM(new Date())}</label><div class="msg_b_row"><div class="msg_b" id="Msg_${i}">${Message}</div>`
                                             + `<div class="msg_b_menu" id="Msg_Menu_${i}" onclick="ShowPopup(${i},${ChatId});">`
                                             + `<i class="fa fa-ellipsis-v"></i><div class="chat_option" id="chat_option_${i}">`
                                             /*   + `<span onclick="EditMessage(${ChatId},${i})">Edit</span>`*/
                                             + `<span onclick="RemoveMessage(${ChatId},${i})">Remove</span></div>`
                                             + `</div></div>`

                                             //'<div class="msg_b">' + tags[i] + '</div>'
                                             //+ '<label class="msg-time">' + formatAMPM(new Date()) + '</label>'
                                         );
                                     }

                                 }
                                 else {
                                     $('#chatMessages').append(


                                         `<label class="msg-time" id="Msg_Time_${i}" style="">${formatAMPM(new Date())}</label><div class="msg_b_row"><div class="msg_b" id="Msg_${i}">${Message}</div>`
                                         + `<div class="msg_b_menu" id="Msg_Menu_${i}" onclick="ShowPopup(${i},${ChatId});">`
                                         + `<i class="fa fa-ellipsis-v"></i><div class="chat_option" id="chat_option_${i}">`
                                         /*+ `<span onclick="EditMessage(${ChatId},${i})">Edit</span>`*/
                                         + `<span onclick="RemoveMessage(${ChatId},${i})">Remove</span></div>`
                                         + `</div></div>`

                                         //'<div class="msg_b">' + tags[i] + '</div>'
                                         //+ '<label class="msg-time">' + formatAMPM(new Date()) + '</label>'
                                     );
                                 }
                             }
                             else {
                                 $('#chatMessages').append(


                                     `<label class="msg-time" id="Msg_Time_${i}" style="">${formatAMPM(new Date())}</label><div class="msg_b_row"><div class="msg_b" id="Msg_${i}">${Message}</div>`
                                     + `<div class="msg_b_menu" id="Msg_Menu_${i}" onclick="ShowPopup(${i},${ChatId});">`
                                     + `<i class="fa fa-ellipsis-v"></i><div class="chat_option" id="chat_option_${i}">`
                                     /* + `<span onclick="EditMessage(${ChatId},${i})">Edit</span>`*/
                                     + `<span onclick="RemoveMessage(${ChatId},${i})">Remove</span></div>`
                                     + `</div></div>`

                                     //'<div class="msg_b">' + tags[i] + '</div>'
                                     //+ '<label class="msg-time">' + formatAMPM(new Date()) + '</label>'
                                 );
                             }

                         }
                         //var i = parseInt($('#chatMessages div.msg_b:last').attr('id').split("_")[1]);
                         /*var i = parseInt($('div:last', '#chatMessages').attr('id').split("_")[2]);*/
                         else {

                             i = i + 1;

                             $('#chatMessages').append(


                                 `<label class="msg-time" id="Msg_Time_${i}" style="">${formatAMPM(new Date())}</label><div class="msg_b_row"><div class="msg_b" id="Msg_${i}">${Message}</div>`
                                 + `<div class="msg_b_menu" id="Msg_Menu_${i}" onclick="ShowPopup(${i},${ChatId});">`
                                 + `<i class="fa fa-ellipsis-v"></i><div class="chat_option" id="chat_option_${i}">`
                                 /* + `<span onclick="EditMessage(${ChatId},${i})">Edit</span>`*/
                                 + `<span onclick="RemoveMessage(${ChatId},${i})">Remove</span></div>`
                                 + `</div></div>`

                                 //'<div class="msg_b">' + tags[i] + '</div>'
                                 //+ '<label class="msg-time">' + formatAMPM(new Date()) + '</label>'
                             );
                             
                         }

                     }
                    

               /* LoadPrivateChatFromDB();*/
            }

                //$('#chatMessages').html('');
                //LoadPrivateChatFromDB();
               //$.connection.hub.start().done(function () {
            /*chat.server.privateChat($('#SignalR_To_ID').val(), $('#SignalR_From_ID').val(), UserName, tags[i], ChatId, IsEdit);*/
            chat.server.privateChat($('#SignalR_To_ID').val(), $('#SignalR_From_ID').val(), UserName, Message, ChatId, IsEdit);
               //});
           // }
            scrollChatDiv();
        }
        else {

            $.connection.hub.start().done(function () {
                chat.server.privateChat($('#SignalR_To_ID').val(), $('#SignalR_From_ID').val(), UserName, '', ChatId, IsEdit);
            });

        }
        //let msg = $("#TxtMessage").val().trim();
        //if (msg.length > 0) {
        //    if ($('#ChatId').val() == 0) {
        //        //$('#chatMessages').append(
        //        //    '<div class="msg_b">' + $('#TxtMessage').val() + '</div>'
        //        //    + '<label class="msg-time">' + formatAMPM(new Date()) + '</label>'
        //        //);
        //        LoadPrivateChatFromDB();
        //    }
        //    chat.server.privateChat($('#SignalR_To_ID').val(), $('#SignalR_From_ID').val(), UserName, $('#TxtMessage').val(), ChatId, IsEdit);
        //}
        /*scrollChatDiv();*/
        $('#TxtMessage').val('').focus();
    }
    function groupChat(Message, ChatId, IsEdit) {

        //$('#chatMessages').append('<div class="msg_b" style="font-size:16px;">' + $('#TxtMessage').val() + '</div>');
        var UserName = '@ProjectSession.LoginChatUserDetails.FirstName' + ' ' + '@ProjectSession.LoginChatUserDetails.LastName';

        if (Message) {

            var tags = Message.split(',');
            for (var i = 0; i < tags.length; i++) {
                chat.server.broadCastInGroup(UserName, tags[i], $("#SignalRGroupName").val(), ChatId, IsEdit);
            }
        }
        else {
            chat.server.broadCastInGroup(UserName, '', $("#SignalRGroupName").val(), ChatId, IsEdit);
        }

        //let msg = $("#TxtMessage").val().trim();
        //if (msg.length > 0) {
        //    chat.server.broadCastInGroup(UserName, $("#TxtMessage").val(), $("#SignalRGroupName").val(), ChatId, IsEdit);
        //}
        $('#TxtMessage').val('').focus();
    }
    function joinGroup(GroupName) {
        var UserName = '@ProjectSession.LoginChatUserDetails.FirstName' + ' ' + '@ProjectSession.LoginChatUserDetails.LastName';
        chat.server.groupconnect(UserName, GroupName);
    }
    //function sendMessage() {

    //    var chatid = $('#ChatId').val();
    //    if (chatid > 0 && chatid != '') {
    //        if ($("#isPrivateChat").val().toString().toLowerCase() === "true") {
    //            UpdateMessageFromDb($('#ChatId').val());
    //        }

    //    }
    //    else {
    //        let msg = $("#TxtMessage").val().trim();
    //        var files = $('#ChatAttachment').prop('files');
    //        if (files.length > 0) {
    //            if ($("#isPrivateChat").val().toString().toLowerCase() === "true") {
    //                SavePrivateChatToDB($("#TxtMessage").val());
    //            }
    //            else {
    //                SaveGroupChatToDB($("#TxtMessage").val());
    //            }
    //        }
    //        else {
    //            if (msg.length > 0) {
    //                if ($("#diveEmojiPanel").is(":visible")) {
    //                    toggleEmojis();
    //                }
    //                if ($("#isPrivateChat").val().toString().toLowerCase() === "true") {
    //                    SavePrivateChatToDB($("#TxtMessage").val());
    //                }
    //                else {
    //                    SaveGroupChatToDB($("#TxtMessage").val());
    //                }
    //            }
    //            else {
    //                $('#TxtMessage').val('').focus();
    //                return false;
    //            }
    //        }
    //        {
    //            if (msg.length > 0) {
    //                if ($("#diveEmojiPanel").is(":visible")) {
    //                    toggleEmojis();
    //                }
    //                if ($("#isPrivateChat").val().toString().toLowerCase() === "true") {
    //                    SavePrivateChatToDB($("#TxtMessage").val());
    //                }
    //                else {
    //                    SaveGroupChatToDB($("#TxtMessage").val());
    //                }
    //            }
    //            else {
    //                $('#TxtMessage').val('').focus();
    //                return false;
    //            }
    //        }
    //    }
    //}
    function sendMessage() {
        //let pattern = new RegExp('(?:\uD83D(?:\uDD73\uFE0F?|\uDC41(?:(?:\uFE0F(?:\u200D\uD83D\uDDE8\uFE0F?)?|\u200D\uD83D\uDDE8\uFE0F?))?|[\uDDE8\uDDEF]\uFE0F?|\uDC4B(?:\uD83C[\uDFFB-\uDFFF])?|\uDD90(?:(?:\uD83C[\uDFFB-\uDFFF]|\uFE0F))?|[\uDD96\uDC4C\uDC48\uDC49\uDC46\uDD95\uDC47\uDC4D\uDC4E\uDC4A\uDC4F\uDE4C\uDC50\uDE4F\uDC85\uDCAA\uDC42\uDC43\uDC76\uDC66\uDC67](?:\uD83C[\uDFFB-\uDFFF])?|\uDC71(?:(?:\uD83C(?:[\uDFFB-\uDFFF](?:\u200D(?:[\u2640\u2642]\uFE0F?))?)|\u200D(?:[\u2640\u2642]\uFE0F?)))?|\uDC68(?:(?:\uD83C(?:\uDFFB(?:\u200D(?:\uD83E(?:\uDD1D\u200D\uD83D\uDC68\uD83C[\uDFFC-\uDFFF]|[\uDDB0\uDDB1\uDDB3\uDDB2\uDDAF\uDDBC\uDDBD])|\u2695\uFE0F?|\uD83C[\uDF93\uDFEB\uDF3E\uDF73\uDFED\uDFA4\uDFA8]|\u2696\uFE0F?|\uD83D[\uDD27\uDCBC\uDD2C\uDCBB\uDE80\uDE92]|\u2708\uFE0F?))?|\uDFFC(?:\u200D(?:\uD83E(?:\uDD1D\u200D\uD83D\uDC68\uD83C[\uDFFB\uDFFD-\uDFFF]|[\uDDB0\uDDB1\uDDB3\uDDB2\uDDAF\uDDBC\uDDBD])|\u2695\uFE0F?|\uD83C[\uDF93\uDFEB\uDF3E\uDF73\uDFED\uDFA4\uDFA8]|\u2696\uFE0F?|\uD83D[\uDD27\uDCBC\uDD2C\uDCBB\uDE80\uDE92]|\u2708\uFE0F?))?|\uDFFD(?:\u200D(?:\uD83E(?:\uDD1D\u200D\uD83D\uDC68\uD83C[\uDFFB\uDFFC\uDFFE\uDFFF]|[\uDDB0\uDDB1\uDDB3\uDDB2\uDDAF\uDDBC\uDDBD])|\u2695\uFE0F?|\uD83C[\uDF93\uDFEB\uDF3E\uDF73\uDFED\uDFA4\uDFA8]|\u2696\uFE0F?|\uD83D[\uDD27\uDCBC\uDD2C\uDCBB\uDE80\uDE92]|\u2708\uFE0F?))?|\uDFFE(?:\u200D(?:\uD83E(?:\uDD1D\u200D\uD83D\uDC68\uD83C[\uDFFB-\uDFFD\uDFFF]|[\uDDB0\uDDB1\uDDB3\uDDB2\uDDAF\uDDBC\uDDBD])|\u2695\uFE0F?|\uD83C[\uDF93\uDFEB\uDF3E\uDF73\uDFED\uDFA4\uDFA8]|\u2696\uFE0F?|\uD83D[\uDD27\uDCBC\uDD2C\uDCBB\uDE80\uDE92]|\u2708\uFE0F?))?|\uDFFF(?:\u200D(?:\uD83E(?:\uDD1D\u200D\uD83D\uDC68\uD83C[\uDFFB-\uDFFE]|[\uDDB0\uDDB1\uDDB3\uDDB2\uDDAF\uDDBC\uDDBD])|\u2695\uFE0F?|\uD83C[\uDF93\uDFEB\uDF3E\uDF73\uDFED\uDFA4\uDFA8]|\u2696\uFE0F?|\uD83D[\uDD27\uDCBC\uDD2C\uDCBB\uDE80\uDE92]|\u2708\uFE0F?))?)|\u200D(?:\uD83E[\uDDB0\uDDB1\uDDB3\uDDB2\uDDAF\uDDBC\uDDBD]|\u2695\uFE0F?|\uD83C[\uDF93\uDFEB\uDF3E\uDF73\uDFED\uDFA4\uDFA8]|\u2696\uFE0F?|\uD83D(?:\uDC69\u200D\uD83D(?:\uDC66(?:\u200D\uD83D\uDC66)?|\uDC67(?:\u200D\uD83D[\uDC66\uDC67])?)|\uDC68\u200D\uD83D(?:\uDC66(?:\u200D\uD83D\uDC66)?|\uDC67(?:\u200D\uD83D[\uDC66\uDC67])?)|\uDC66(?:\u200D\uD83D\uDC66)?|\uDC67(?:\u200D\uD83D[\uDC66\uDC67])?|[\uDD27\uDCBC\uDD2C\uDCBB\uDE80\uDE92])|\u2708\uFE0F?|\u2764(?:\uFE0F\u200D\uD83D(?:\uDC8B\u200D\uD83D\uDC68|\uDC68)|\u200D\uD83D(?:\uDC8B\u200D\uD83D\uDC68|\uDC68)))))?|\uDC69(?:(?:\uD83C(?:\uDFFB(?:\u200D(?:\uD83E(?:\uDD1D\u200D\uD83D(?:\uDC69\uD83C[\uDFFC-\uDFFF]|\uDC68\uD83C[\uDFFC-\uDFFF])|[\uDDB0\uDDB1\uDDB3\uDDB2\uDDAF\uDDBC\uDDBD])|\u2695\uFE0F?|\uD83C[\uDF93\uDFEB\uDF3E\uDF73\uDFED\uDFA4\uDFA8]|\u2696\uFE0F?|\uD83D[\uDD27\uDCBC\uDD2C\uDCBB\uDE80\uDE92]|\u2708\uFE0F?))?|\uDFFC(?:\u200D(?:\uD83E(?:\uDD1D\u200D\uD83D(?:\uDC69\uD83C[\uDFFB\uDFFD-\uDFFF]|\uDC68\uD83C[\uDFFB\uDFFD-\uDFFF])|[\uDDB0\uDDB1\uDDB3\uDDB2\uDDAF\uDDBC\uDDBD])|\u2695\uFE0F?|\uD83C[\uDF93\uDFEB\uDF3E\uDF73\uDFED\uDFA4\uDFA8]|\u2696\uFE0F?|\uD83D[\uDD27\uDCBC\uDD2C\uDCBB\uDE80\uDE92]|\u2708\uFE0F?))?|\uDFFD(?:\u200D(?:\uD83E(?:\uDD1D\u200D\uD83D(?:\uDC69\uD83C[\uDFFB\uDFFC\uDFFE\uDFFF]|\uDC68\uD83C[\uDFFB\uDFFC\uDFFE\uDFFF])|[\uDDB0\uDDB1\uDDB3\uDDB2\uDDAF\uDDBC\uDDBD])|\u2695\uFE0F?|\uD83C[\uDF93\uDFEB\uDF3E\uDF73\uDFED\uDFA4\uDFA8]|\u2696\uFE0F?|\uD83D[\uDD27\uDCBC\uDD2C\uDCBB\uDE80\uDE92]|\u2708\uFE0F?))?|\uDFFE(?:\u200D(?:\uD83E(?:\uDD1D\u200D\uD83D(?:\uDC69\uD83C[\uDFFB-\uDFFD\uDFFF]|\uDC68\uD83C[\uDFFB-\uDFFD\uDFFF])|[\uDDB0\uDDB1\uDDB3\uDDB2\uDDAF\uDDBC\uDDBD])|\u2695\uFE0F?|\uD83C[\uDF93\uDFEB\uDF3E\uDF73\uDFED\uDFA4\uDFA8]|\u2696\uFE0F?|\uD83D[\uDD27\uDCBC\uDD2C\uDCBB\uDE80\uDE92]|\u2708\uFE0F?))?|\uDFFF(?:\u200D(?:\uD83E(?:\uDD1D\u200D\uD83D(?:\uDC69\uD83C[\uDFFB-\uDFFE]|\uDC68\uD83C[\uDFFB-\uDFFE])|[\uDDB0\uDDB1\uDDB3\uDDB2\uDDAF\uDDBC\uDDBD])|\u2695\uFE0F?|\uD83C[\uDF93\uDFEB\uDF3E\uDF73\uDFED\uDFA4\uDFA8]|\u2696\uFE0F?|\uD83D[\uDD27\uDCBC\uDD2C\uDCBB\uDE80\uDE92]|\u2708\uFE0F?))?)|\u200D(?:\uD83E[\uDDB0\uDDB1\uDDB3\uDDB2\uDDAF\uDDBC\uDDBD]|\u2695\uFE0F?|\uD83C[\uDF93\uDFEB\uDF3E\uDF73\uDFED\uDFA4\uDFA8]|\u2696\uFE0F?|\uD83D(?:\uDC69\u200D\uD83D(?:\uDC66(?:\u200D\uD83D\uDC66)?|\uDC67(?:\u200D\uD83D[\uDC66\uDC67])?)|\uDC66(?:\u200D\uD83D\uDC66)?|\uDC67(?:\u200D\uD83D[\uDC66\uDC67])?|[\uDD27\uDCBC\uDD2C\uDCBB\uDE80\uDE92])|\u2708\uFE0F?|\u2764(?:\uFE0F\u200D\uD83D(?:\uDC8B\u200D\uD83D[\uDC68\uDC69]|[\uDC68\uDC69])|\u200D\uD83D(?:\uDC8B\u200D\uD83D[\uDC68\uDC69]|[\uDC68\uDC69])))))?|[\uDC74\uDC75](?:\uD83C[\uDFFB-\uDFFF])?|[\uDE4D\uDE4E\uDE45\uDE46\uDC81\uDE4B\uDE47\uDC6E](?:(?:\uD83C(?:[\uDFFB-\uDFFF](?:\u200D(?:[\u2642\u2640]\uFE0F?))?)|\u200D(?:[\u2642\u2640]\uFE0F?)))?|\uDD75(?:(?:\uFE0F(?:\u200D(?:[\u2642\u2640]\uFE0F?))?|\uD83C(?:[\uDFFB-\uDFFF](?:\u200D(?:[\u2642\u2640]\uFE0F?))?)|\u200D(?:[\u2642\u2640]\uFE0F?)))?|[\uDC82\uDC77](?:(?:\uD83C(?:[\uDFFB-\uDFFF](?:\u200D(?:[\u2642\u2640]\uFE0F?))?)|\u200D(?:[\u2642\u2640]\uFE0F?)))?|\uDC78(?:\uD83C[\uDFFB-\uDFFF])?|\uDC73(?:(?:\uD83C(?:[\uDFFB-\uDFFF](?:\u200D(?:[\u2642\u2640]\uFE0F?))?)|\u200D(?:[\u2642\u2640]\uFE0F?)))?|[\uDC72\uDC70\uDC7C](?:\uD83C[\uDFFB-\uDFFF])?|[\uDC86\uDC87\uDEB6](?:(?:\uD83C(?:[\uDFFB-\uDFFF](?:\u200D(?:[\u2642\u2640]\uFE0F?))?)|\u200D(?:[\u2642\u2640]\uFE0F?)))?|[\uDC83\uDD7A](?:\uD83C[\uDFFB-\uDFFF])?|\uDD74(?:(?:\uD83C[\uDFFB-\uDFFF]|\uFE0F))?|\uDC6F(?:\u200D(?:[\u2642\u2640]\uFE0F?))?|[\uDEA3\uDEB4\uDEB5](?:(?:\uD83C(?:[\uDFFB-\uDFFF](?:\u200D(?:[\u2642\u2640]\uFE0F?))?)|\u200D(?:[\u2642\u2640]\uFE0F?)))?|[\uDEC0\uDECC\uDC6D\uDC6B\uDC6C](?:\uD83C[\uDFFB-\uDFFF])?|\uDDE3\uFE0F?|\uDC15(?:\u200D\uD83E\uDDBA)?|[\uDC3F\uDD4A\uDD77\uDD78\uDDFA\uDEE3\uDEE4\uDEE2\uDEF3\uDEE5\uDEE9\uDEF0\uDECE\uDD70\uDD79\uDDBC\uDD76\uDECD\uDDA5\uDDA8\uDDB1\uDDB2\uDCFD\uDD6F\uDDDE\uDDF3\uDD8B\uDD8A\uDD8C\uDD8D\uDDC2\uDDD2\uDDD3\uDD87\uDDC3\uDDC4\uDDD1\uDDDD\uDEE0\uDDE1\uDEE1\uDDDC\uDECF\uDECB\uDD49]\uFE0F?|[\uDE00\uDE03\uDE04\uDE01\uDE06\uDE05\uDE02\uDE42\uDE43\uDE09\uDE0A\uDE07\uDE0D\uDE18\uDE17\uDE1A\uDE19\uDE0B\uDE1B-\uDE1D\uDE10\uDE11\uDE36\uDE0F\uDE12\uDE44\uDE2C\uDE0C\uDE14\uDE2A\uDE34\uDE37\uDE35\uDE0E\uDE15\uDE1F\uDE41\uDE2E\uDE2F\uDE32\uDE33\uDE26-\uDE28\uDE30\uDE25\uDE22\uDE2D\uDE31\uDE16\uDE23\uDE1E\uDE13\uDE29\uDE2B\uDE24\uDE21\uDE20\uDE08\uDC7F\uDC80\uDCA9\uDC79-\uDC7B\uDC7D\uDC7E\uDE3A\uDE38\uDE39\uDE3B-\uDE3D\uDE40\uDE3F\uDE3E\uDE48-\uDE4A\uDC8B\uDC8C\uDC98\uDC9D\uDC96\uDC97\uDC93\uDC9E\uDC95\uDC9F\uDC94\uDC9B\uDC9A\uDC99\uDC9C\uDDA4\uDCAF\uDCA2\uDCA5\uDCAB\uDCA6\uDCA8\uDCA3\uDCAC\uDCAD\uDCA4\uDC40\uDC45\uDC44\uDC8F\uDC91\uDC6A\uDC64\uDC65\uDC63\uDC35\uDC12\uDC36\uDC29\uDC3A\uDC31\uDC08\uDC2F\uDC05\uDC06\uDC34\uDC0E\uDC2E\uDC02-\uDC04\uDC37\uDC16\uDC17\uDC3D\uDC0F\uDC11\uDC10\uDC2A\uDC2B\uDC18\uDC2D\uDC01\uDC00\uDC39\uDC30\uDC07\uDC3B\uDC28\uDC3C\uDC3E\uDC14\uDC13\uDC23-\uDC27\uDC38\uDC0A\uDC22\uDC0D\uDC32\uDC09\uDC33\uDC0B\uDC2C\uDC1F-\uDC21\uDC19\uDC1A\uDC0C\uDC1B-\uDC1E\uDC90\uDCAE\uDD2A\uDDFE\uDDFB\uDC92\uDDFC\uDDFD\uDD4C\uDED5\uDD4D\uDD4B\uDC88\uDE82-\uDE8A\uDE9D\uDE9E\uDE8B-\uDE8E\uDE90-\uDE9C\uDEF5\uDEFA\uDEB2\uDEF4\uDEF9\uDE8F\uDEA8\uDEA5\uDEA6\uDED1\uDEA7\uDEF6\uDEA4\uDEA2\uDEEB\uDEEC\uDCBA\uDE81\uDE9F-\uDEA1\uDE80\uDEF8\uDD5B\uDD67\uDD50\uDD5C\uDD51\uDD5D\uDD52\uDD5E\uDD53\uDD5F\uDD54\uDD60\uDD55\uDD61\uDD56\uDD62\uDD57\uDD63\uDD58\uDD64\uDD59\uDD65\uDD5A\uDD66\uDD25\uDCA7\uDEF7\uDD2E\uDC53-\uDC62\uDC51\uDC52\uDCFF\uDC84\uDC8D\uDC8E\uDD07-\uDD0A\uDCE2\uDCE3\uDCEF\uDD14\uDD15\uDCFB\uDCF1\uDCF2\uDCDE-\uDCE0\uDD0B\uDD0C\uDCBB\uDCBD-\uDCC0\uDCFA\uDCF7-\uDCF9\uDCFC\uDD0D\uDD0E\uDCA1\uDD26\uDCD4-\uDCDA\uDCD3\uDCD2\uDCC3\uDCDC\uDCC4\uDCF0\uDCD1\uDD16\uDCB0\uDCB4-\uDCB8\uDCB3\uDCB9\uDCB1\uDCB2\uDCE7-\uDCE9\uDCE4-\uDCE6\uDCEB\uDCEA\uDCEC-\uDCEE\uDCDD\uDCBC\uDCC1\uDCC2\uDCC5-\uDCD0\uDD12\uDD13\uDD0F-\uDD11\uDD28\uDD2B\uDD27\uDD29\uDD17\uDD2C\uDD2D\uDCE1\uDC89\uDC8A\uDEAA\uDEBD\uDEBF\uDEC1\uDED2\uDEAC\uDDFF\uDEAE\uDEB0\uDEB9-\uDEBC\uDEBE\uDEC2-\uDEC5\uDEB8\uDEAB\uDEB3\uDEAD\uDEAF\uDEB1\uDEB7\uDCF5\uDD1E\uDD03\uDD04\uDD19-\uDD1D\uDED0\uDD4E\uDD2F\uDD00-\uDD02\uDD3C\uDD3D\uDD05\uDD06\uDCF6\uDCF3\uDCF4\uDD31\uDCDB\uDD30\uDD1F-\uDD24\uDD34\uDFE0-\uDFE2\uDD35\uDFE3-\uDFE5\uDFE7-\uDFE9\uDFE6\uDFEA\uDFEB\uDD36-\uDD3B\uDCA0\uDD18\uDD33\uDD32\uDEA9])|\uD83E(?:[\uDD1A\uDD0F\uDD1E\uDD1F\uDD18\uDD19\uDD1B\uDD1C\uDD32\uDD33\uDDB5\uDDB6\uDDBB\uDDD2](?:\uD83C[\uDFFB-\uDFFF])?|\uDDD1(?:(?:\uD83C(?:[\uDFFB-\uDFFF](?:\u200D(?:\uD83E(?:\uDD1D\u200D\uD83E\uDDD1\uD83C[\uDFFB-\uDFFF]|[\uDDB0\uDDB1\uDDB3\uDDB2\uDDAF\uDDBC\uDDBD])|\u2695\uFE0F?|\uD83C[\uDF93\uDFEB\uDF3E\uDF73\uDFED\uDFA4\uDFA8]|\u2696\uFE0F?|\uD83D[\uDD27\uDCBC\uDD2C\uDCBB\uDE80\uDE92]|\u2708\uFE0F?))?)|\u200D(?:\uD83E(?:\uDD1D\u200D\uD83E\uDDD1|[\uDDB0\uDDB1\uDDB3\uDDB2\uDDAF\uDDBC\uDDBD])|\u2695\uFE0F?|\uD83C[\uDF93\uDFEB\uDF3E\uDF73\uDFED\uDFA4\uDFA8]|\u2696\uFE0F?|\uD83D[\uDD27\uDCBC\uDD2C\uDCBB\uDE80\uDE92]|\u2708\uFE0F?)))?|[\uDDD4\uDDD3](?:\uD83C[\uDFFB-\uDFFF])?|[\uDDCF\uDD26\uDD37](?:(?:\uD83C(?:[\uDFFB-\uDFFF](?:\u200D(?:[\u2642\u2640]\uFE0F?))?)|\u200D(?:[\u2642\u2640]\uFE0F?)))?|[\uDD34\uDDD5\uDD35\uDD30\uDD31\uDD36](?:\uD83C[\uDFFB-\uDFFF])?|[\uDDB8\uDDB9\uDDD9-\uDDDD](?:(?:\uD83C(?:[\uDFFB-\uDFFF](?:\u200D(?:[\u2642\u2640]\uFE0F?))?)|\u200D(?:[\u2642\u2640]\uFE0F?)))?|[\uDDDE\uDDDF](?:\u200D(?:[\u2642\u2640]\uFE0F?))?|[\uDDCD\uDDCE\uDDD6\uDDD7\uDD38](?:(?:\uD83C(?:[\uDFFB-\uDFFF](?:\u200D(?:[\u2642\u2640]\uFE0F?))?)|\u200D(?:[\u2642\u2640]\uFE0F?)))?|\uDD3C(?:\u200D(?:[\u2642\u2640]\uFE0F?))?|[\uDD3D\uDD3E\uDD39\uDDD8](?:(?:\uD83C(?:[\uDFFB-\uDFFF](?:\u200D(?:[\u2642\u2640]\uFE0F?))?)|\u200D(?:[\u2642\u2640]\uFE0F?)))?|[\uDD23\uDD70\uDD29\uDD2A\uDD11\uDD17\uDD2D\uDD2B\uDD14\uDD10\uDD28\uDD25\uDD24\uDD12\uDD15\uDD22\uDD2E\uDD27\uDD75\uDD76\uDD74\uDD2F\uDD20\uDD73\uDD13\uDDD0\uDD7A\uDD71\uDD2C\uDD21\uDD16\uDDE1\uDD0E\uDD0D\uDD1D\uDDBE\uDDBF\uDDE0\uDDB7\uDDB4\uDD3A\uDDB0\uDDB1\uDDB3\uDDB2\uDD8D\uDDA7\uDDAE\uDD8A\uDD9D\uDD81\uDD84\uDD93\uDD8C\uDD99\uDD92\uDD8F\uDD9B\uDD94\uDD87\uDDA5\uDDA6\uDDA8\uDD98\uDDA1\uDD83\uDD85\uDD86\uDDA2\uDD89\uDDA9\uDD9A\uDD9C\uDD8E\uDD95\uDD96\uDD88\uDD8B\uDD97\uDD82\uDD9F\uDDA0\uDD40\uDD6D\uDD5D\uDD65\uDD51\uDD54\uDD55\uDD52\uDD6C\uDD66\uDDC4\uDDC5\uDD5C\uDD50\uDD56\uDD68\uDD6F\uDD5E\uDDC7\uDDC0\uDD69\uDD53\uDD6A\uDD59\uDDC6\uDD5A\uDD58\uDD63\uDD57\uDDC8\uDDC2\uDD6B\uDD6E\uDD5F-\uDD61\uDD80\uDD9E\uDD90\uDD91\uDDAA\uDDC1\uDD67\uDD5B\uDD42\uDD43\uDD64\uDDC3\uDDC9\uDDCA\uDD62\uDD44\uDDED\uDDF1\uDDBD\uDDBC\uDE82\uDDF3\uDE90\uDDE8\uDDE7\uDD47-\uDD49\uDD4E\uDD4F\uDD4D\uDD4A\uDD4B\uDD45\uDD3F\uDD4C\uDE80\uDE81\uDDFF\uDDE9\uDDF8\uDDF5\uDDF6\uDD7D\uDD7C\uDDBA\uDDE3-\uDDE6\uDD7B\uDE71-\uDE73\uDD7E\uDD7F\uDE70\uDDE2\uDE95\uDD41\uDDEE\uDE94\uDDFE\uDE93\uDDAF\uDDF0\uDDF2\uDDEA-\uDDEC\uDE78-\uDE7A\uDE91\uDE92\uDDF4\uDDF7\uDDF9-\uDDFD\uDDEF])|[\u263A\u2639\u2620\u2763\u2764]\uFE0F?|\u270B(?:\uD83C[\uDFFB-\uDFFF])?|[\u270C\u261D](?:(?:\uD83C[\uDFFB-\uDFFF]|\uFE0F))?|\u270A(?:\uD83C[\uDFFB-\uDFFF])?|\u270D(?:(?:\uD83C[\uDFFB-\uDFFF]|\uFE0F))?|\uD83C(?:\uDF85(?:\uD83C[\uDFFB-\uDFFF])?|\uDFC3(?:(?:\uD83C(?:[\uDFFB-\uDFFF](?:\u200D(?:[\u2642\u2640]\uFE0F?))?)|\u200D(?:[\u2642\u2640]\uFE0F?)))?|[\uDFC7\uDFC2](?:\uD83C[\uDFFB-\uDFFF])?|\uDFCC(?:(?:\uFE0F(?:\u200D(?:[\u2642\u2640]\uFE0F?))?|\uD83C(?:[\uDFFB-\uDFFF](?:\u200D(?:[\u2642\u2640]\uFE0F?))?)|\u200D(?:[\u2642\u2640]\uFE0F?)))?|[\uDFC4\uDFCA](?:(?:\uD83C(?:[\uDFFB-\uDFFF](?:\u200D(?:[\u2642\u2640]\uFE0F?))?)|\u200D(?:[\u2642\u2640]\uFE0F?)))?|\uDFCB(?:(?:\uFE0F(?:\u200D(?:[\u2642\u2640]\uFE0F?))?|\uD83C(?:[\uDFFB-\uDFFF](?:\u200D(?:[\u2642\u2640]\uFE0F?))?)|\u200D(?:[\u2642\u2640]\uFE0F?)))?|[\uDFF5\uDF36\uDF7D\uDFD4-\uDFD6\uDFDC-\uDFDF\uDFDB\uDFD7\uDFD8\uDFDA\uDFD9\uDFCE\uDFCD\uDF21\uDF24-\uDF2C\uDF97\uDF9F\uDF96\uDF99-\uDF9B\uDF9E\uDFF7\uDD70\uDD71\uDD7E\uDD7F\uDE02\uDE37]\uFE0F?|\uDFF4(?:(?:\u200D\u2620\uFE0F?|\uDB40\uDC67\uDB40\uDC62\uDB40(?:\uDC65\uDB40\uDC6E\uDB40\uDC67\uDB40\uDC7F|\uDC73\uDB40\uDC63\uDB40\uDC74\uDB40\uDC7F|\uDC77\uDB40\uDC6C\uDB40\uDC73\uDB40\uDC7F)))?|\uDFF3(?:(?:\uFE0F(?:\u200D\uD83C\uDF08)?|\u200D\uD83C\uDF08))?|\uDDE6\uD83C[\uDDE8-\uDDEC\uDDEE\uDDF1\uDDF2\uDDF4\uDDF6-\uDDFA\uDDFC\uDDFD\uDDFF]|\uDDE7\uD83C[\uDDE6\uDDE7\uDDE9-\uDDEF\uDDF1-\uDDF4\uDDF6-\uDDF9\uDDFB\uDDFC\uDDFE\uDDFF]|\uDDE8\uD83C[\uDDE6\uDDE8\uDDE9\uDDEB-\uDDEE\uDDF0-\uDDF5\uDDF7\uDDFA-\uDDFF]|\uDDE9\uD83C[\uDDEA\uDDEC\uDDEF\uDDF0\uDDF2\uDDF4\uDDFF]|\uDDEA\uD83C[\uDDE6\uDDE8\uDDEA\uDDEC\uDDED\uDDF7-\uDDFA]|\uDDEB\uD83C[\uDDEE-\uDDF0\uDDF2\uDDF4\uDDF7]|\uDDEC\uD83C[\uDDE6\uDDE7\uDDE9-\uDDEE\uDDF1-\uDDF3\uDDF5-\uDDFA\uDDFC\uDDFE]|\uDDED\uD83C[\uDDF0\uDDF2\uDDF3\uDDF7\uDDF9\uDDFA]|\uDDEE\uD83C[\uDDE8-\uDDEA\uDDF1-\uDDF4\uDDF6-\uDDF9]|\uDDEF\uD83C[\uDDEA\uDDF2\uDDF4\uDDF5]|\uDDF0\uD83C[\uDDEA\uDDEC-\uDDEE\uDDF2\uDDF3\uDDF5\uDDF7\uDDFC\uDDFE\uDDFF]|\uDDF1\uD83C[\uDDE6-\uDDE8\uDDEE\uDDF0\uDDF7-\uDDFB\uDDFE]|\uDDF2\uD83C[\uDDE6\uDDE8-\uDDED\uDDF0-\uDDFF]|\uDDF3\uD83C[\uDDE6\uDDE8\uDDEA-\uDDEC\uDDEE\uDDF1\uDDF4\uDDF5\uDDF7\uDDFA\uDDFF]|\uDDF4\uD83C\uDDF2|\uDDF5\uD83C[\uDDE6\uDDEA-\uDDED\uDDF0-\uDDF3\uDDF7-\uDDF9\uDDFC\uDDFE]|\uDDF6\uD83C\uDDE6|\uDDF7\uD83C[\uDDEA\uDDF4\uDDF8\uDDFA\uDDFC]|\uDDF8\uD83C[\uDDE6-\uDDEA\uDDEC-\uDDF4\uDDF7-\uDDF9\uDDFB\uDDFD-\uDDFF]|\uDDF9\uD83C[\uDDE6\uDDE8\uDDE9\uDDEB-\uDDED\uDDEF-\uDDF4\uDDF7\uDDF9\uDDFB\uDDFC\uDDFF]|\uDDFA\uD83C[\uDDE6\uDDEC\uDDF2\uDDF3\uDDF8\uDDFE\uDDFF]|\uDDFB\uD83C[\uDDE6\uDDE8\uDDEA\uDDEC\uDDEE\uDDF3\uDDFA]|\uDDFC\uD83C[\uDDEB\uDDF8]|\uDDFD\uD83C\uDDF0|\uDDFE\uD83C[\uDDEA\uDDF9]|\uDDFF\uD83C[\uDDE6\uDDF2\uDDFC]|[\uDFFB-\uDFFF\uDF38-\uDF3C\uDF37\uDF31-\uDF35\uDF3E-\uDF43\uDF47-\uDF53\uDF45\uDF46\uDF3D\uDF44\uDF30\uDF5E\uDF56\uDF57\uDF54\uDF5F\uDF55\uDF2D-\uDF2F\uDF73\uDF72\uDF7F\uDF71\uDF58-\uDF5D\uDF60\uDF62-\uDF65\uDF61\uDF66-\uDF6A\uDF82\uDF70\uDF6B-\uDF6F\uDF7C\uDF75\uDF76\uDF7E\uDF77-\uDF7B\uDF74\uDFFA\uDF0D-\uDF10\uDF0B\uDFE0-\uDFE6\uDFE8-\uDFED\uDFEF\uDFF0\uDF01\uDF03-\uDF07\uDF09\uDFA0-\uDFA2\uDFAA\uDF11-\uDF20\uDF0C\uDF00\uDF08\uDF02\uDF0A\uDF83\uDF84\uDF86-\uDF8B\uDF8D-\uDF91\uDF80\uDF81\uDFAB\uDFC6\uDFC5\uDFC0\uDFD0\uDFC8\uDFC9\uDFBE\uDFB3\uDFCF\uDFD1-\uDFD3\uDFF8\uDFA3\uDFBD\uDFBF\uDFAF\uDFB1\uDFAE\uDFB0\uDFB2\uDCCF\uDC04\uDFB4\uDFAD\uDFA8\uDF92\uDFA9\uDF93\uDFBC\uDFB5\uDFB6\uDFA4\uDFA7\uDFB7-\uDFBB\uDFA5\uDFAC\uDFEE\uDFF9\uDFE7\uDFA6\uDD8E\uDD91-\uDD9A\uDE01\uDE36\uDE2F\uDE50\uDE39\uDE1A\uDE32\uDE51\uDE38\uDE34\uDE33\uDE3A\uDE35\uDFC1\uDF8C])|\u26F7\uFE0F?|\u26F9(?:(?:\uFE0F(?:\u200D(?:[\u2642\u2640]\uFE0F?))?|\uD83C(?:[\uDFFB-\uDFFF](?:\u200D(?:[\u2642\u2640]\uFE0F?))?)|\u200D(?:[\u2642\u2640]\uFE0F?)))?|[\u2618\u26F0\u26E9\u2668\u26F4\u2708\u23F1\u23F2\u2600\u2601\u26C8\u2602\u26F1\u2744\u2603\u2604\u26F8\u2660\u2665\u2666\u2663\u265F\u26D1\u260E\u2328\u2709\u270F\u2712\u2702\u26CF\u2692\u2694\u2699\u2696\u26D3\u2697\u26B0\u26B1\u26A0\u2622\u2623\u2B06\u2197\u27A1\u2198\u2B07\u2199\u2B05\u2196\u2195\u2194\u21A9\u21AA\u2934\u2935\u269B\u2721\u2638\u262F\u271D\u2626\u262A\u262E\u25B6\u23ED\u23EF\u25C0\u23EE\u23F8-\u23FA\u23CF\u2640\u2642\u2695\u267E\u267B\u269C\u2611\u2714\u2716\u303D\u2733\u2734\u2747\u203C\u2049\u3030\u00A9\u00AE\u2122]\uFE0F?|[\u0023\u002A\u0030-\u0039](?:\uFE0F\u20E3|\u20E3)|[\u2139\u24C2\u3297\u3299\u25FC\u25FB\u25AA\u25AB]\uFE0F?|[\u2615\u26EA\u26F2\u26FA\u26FD\u2693\u26F5\u231B\u23F3\u231A\u23F0\u2B50\u26C5\u2614\u26A1\u26C4\u2728\u26BD\u26BE\u26F3\u267F\u26D4\u2648-\u2653\u26CE\u23E9-\u23EC\u2B55\u2705\u274C\u274E\u2795-\u2797\u27B0\u27BF\u2753-\u2755\u2757\u26AB\u26AA\u2B1B\u2B1C\u25FE\u25FD])');
        let msg = $("#TxtMessage").val().trim();

        var files = $('#ChatAttachment').prop('files');
        if (files.length > 0) {
            if ($("#isPrivateChat").val().toString().toLowerCase() === "true") {
                SavePrivateChatToDB($("#TxtMessage").val());
            }
            else {
                SaveGroupChatToDB($("#TxtMessage").val());
            }
        }
        else {
            if (msg.length > 0) {
                if ($("#diveEmojiPanel").is(":visible")) {
                    toggleEmojis();
                }

                //if (pattern.test(msg)) {
                //    console.log(emojiCode)
                //    for (var i = 0; i < emojiCode.length; i++) {
                //        msg = msg.replace(pattern, emojiCode[i]);
                //    }
                //}

                //$("#TxtMessage").val(msg);

                if ($("#isPrivateChat").val().toString().toLowerCase() === "true") {
                    SavePrivateChatToDB($("#TxtMessage").val());
                }
                else {
                    SaveGroupChatToDB($("#TxtMessage").val());
                }
            }
            else {
                $('#TxtMessage').val('').focus();
                return false;
            }
        }
    }
    function htmlEncode(value) {

       /* var encodedValue = $('<div />').text(value).html();*/
        return value;
    }
    function startChat(data, imageURL, UserName, isPrivate, DBID, isGroupOwner, isOnline) {
        
        //$(".loader").show();
        $(".top-header").addClass("top-mobi-header");
        $(".chat-message-load").hide();
        $("#chatMessages").show();
        $('#GroupMembers div').removeClass('active-user');
        $("#ChatListDiv .user-details-list").removeClass("active-user");
        $("#" + data).addClass("active-user");

        //SignalR_TO_DB_ID
        //SignalR_TO_GROUP_DB_ID
        const myNode = document.getElementById("chatMessages");
        myNode.textContent = '';
        var Title = '';
        $("#SignalR_TO_DB_ID").val(DBID);
        $("#isPrivateChat").val(isPrivate);
        if (isPrivate.toString().toLowerCase() == 'true') {
            $("#SignalRGroupName").val('');
            $("#SignalR_To_ID").val(data);
            Title = "Conversation with " + UserName.toString();
            
            LoadPrivateChatFromDB();
            $('#channel-title').html(UserName);
        }
        else {
            $("#SignalRGroupName").val(UserName);
            $("#SignalR_To_ID").val('');
            $("#SignalR_To_ID").val(DBID);
            Title = "Conversation in " + UserName.toString() + " Group";
            LoadGroupChatFromDB();
            $('#channel-title').html(UserName);
        }
        document.getElementById(data).querySelector('.chat-badge').innerHTML = 0;
        document.getElementById(data).querySelector('.chat-badge').style.display = "none";

        mainChatBadgeValue();
        $('#TxtMessage').val('').focus();
        $(".openChatbox h4").remove();
        $(".openChatbox img").remove();
        setTimeout(function () {

            if (imageURL != "null" && imageURL.length > 0) {
                $(".openChatbox").html("<img src='" + imageURL + "' class='chatAvatar'>");
            }
            else if (UserName) {
                var strIntial = "";
                var initial = UserName.split(" ");
                if (initial.length > 0) {
                    strIntial = initial[0].charAt(0);
                    if (initial.length > 1) {
                        strIntial += initial[1].charAt(0);
                    }

                }
                else {
                    strIntial = initial;
                }
                console.log(strIntial);
                $(".openChatbox").append("<h4>" + strIntial + "<h4>");
            }
        }, 300);
        //$(".loader").hide();

    }
    $('#TxtMessage').keypress(function (e) {
        var key = e.which;
        if (key == 13)  // the enter key code
        {
            sendMessage();
            return false;
        }
    });
    function SaveGroupChatToDB(Message) {

        $('.loader').show();
        var files = $('#ChatAttachment').prop('files');
        let attachmentfile = new FormData();
        for (let index = 0; index < files.length; index++) {
            attachmentfile.append('file' + index, files[index]);
        }
        attachmentfile.append('SignalRGroupId', $("#SignalR_TO_DB_ID").val());
        attachmentfile.append('Msg', Message);
        let chatId = $('#ChatId').val() == '' ? 0 : $('#ChatId').val();
        attachmentfile.append('GroupChatId', chatId);

        $.ajax({
            url: '@Url.Action("SaveGroupConversations", "SignalRHelper")',
            async: false,
            type: 'POST',
            contentType: false,
            processData: false,
            data: attachmentfile,
            success: function (data) {
                console.log("SaveGroupConversations");

                $('.loader').hide();
                if (data.Success) {
                    emojiCode = [];
                    $('#ChatAttachment').val('');
                    $("#ChatAttachmentBadge").hide();
                    $("#ChatAttachmentBadge").html(0);
                    //if (chatId != 0) {
                    //    groupChat(data.Data, data.Message, 1);

                    //}
                    //else {
                    //    groupChat(data.Data, data.Message, 0);
                    //}
                    groupChat(data.Data, $('#DyId').val(),1);
                    $('#ChatId').val("0");
                   /* $('#Msg_' + $('#DyId').val()).text(Message);*/
                    $("#TxtMessage").val('');
                }
                else {
                    toastr.error("Something went wrong please try again later.");
                }
            }
        });
    }
    function LoadGroupChatFromDB() {

        $('.loader').show();
        $.ajax({
            url: '@Url.Action("GetGroupConversations", "SignalRHelper")',
            async: false,
            type: 'POST',
            data: { SignalRGroupId: $("#SignalR_TO_DB_ID").val()},
            success: function (data) {
                $('.loader').hide();

                if (data.Success && data.Data != null) {

                    lastChatInd = data.Data.length;
                    if (data.Data.length > 0) {
                        for (var i = 0; i < data.Data.length; i++) {


                            if (data.Data[i].MsgFrom === data.MySignalRUserId) {

                                var current_msg = data.Data[i].MsgDateTime;
                                var current_date = new Date(parseInt(current_msg.substr(6)));
                                if (i != 0) {
                                    var previous_msg = data.Data[i - 1].MsgDateTime;
                                    var previous_date = new Date(parseInt(previous_msg.substr(6)));

                                    var diff = Math.abs(current_date - previous_date);
                                    var minutes = Math.floor((diff / 1000) / 60);
                                    var lastDiv = $('div:last', '#chatMessages').attr('class');

                                    if (minutes <= 2 && lastDiv == "chat_option") {
                                        data.Data[i].StrMsgDateTime.split('')
                                        //message from this side
                                        if (data.Data[i].Msg.charAt(0) != "<") {
                                            if (data.Data[i].IsEdited) {
                                                $('#chatMessages').append(
                                                    '<label class="msg-time" id="Msg_Time_' + i + '" style="display:none">' + data.Data[i].StrMsgDateTime + '</label>'
                                                    + '<div class="msg_b_row"><div class="edit_icon" id="editIcon_' + i + '"><i class="fa fa-pencil" title="This message has been edited"></i></div><div class="msg_b" title="' + data.Data[i].StrMsgDateTime + '" id="Msg_' + i + '">' + data.Data[i].Msg + '</div>'
                                                    + '<div class= "msg_b_menu" id = "Msg_Menu_' + i + '" onclick = "ShowPopup(' + i + ',' + data.Data[i].GroupChatId + ');" >'
                                                    + '<i class= "fa fa-ellipsis-v" ></i > <div class="chat_option" id="chat_option_' + i + '">'
                                                    + '<span onclick="EditGroupMessage(' + data.Data[i].GroupChatId + ',' + i + ')">Edit</span>'
                                                    + '<span onclick="RemoveMessage(' + data.Data[i].GroupChatId + ',' + i + ')"   >Remove</span></div>'
                                                    + '</div ></div>'


                                                );
                                            }
                                            else {
                                                $('#chatMessages').append(
                                                    '<label class="msg-time" id="Msg_Time_' + i + '" style="display:none">' + data.Data[i].StrMsgDateTime + '</label>'
                                                    +'<div class="msg_b_row"><div class="msg_b" title="' + data.Data[i].StrMsgDateTime + '" id="Msg_' + i + '">' + data.Data[i].Msg + '</div>'
                                                    + '<div class= "msg_b_menu" id = "Msg_Menu_' + i + '" onclick = "ShowPopup(' + i + ',' + data.Data[i].GroupChatId + ');" >'
                                                    + '<i class= "fa fa-ellipsis-v" ></i > <div class="chat_option" id="chat_option_' + i + '">'
                                                    + '<span onclick="EditGroupMessage(' + data.Data[i].GroupChatId + ',' + i + ')">Edit</span>'
                                                    + '<span onclick="RemoveMessage(' + data.Data[i].GroupChatId + ',' + i + ')"   >Remove</span></div>'
                                                    + '</div ></div>'


                                                );
                                            }

                                        }
                                        else {
                                            if (data.Data[i].IsEdited) {
                                                $('#chatMessages').append(
                                                    '<label class="msg-time"  id="Msg_Time_' + i + '" style="display:none">' + data.Data[i].StrMsgDateTime + '</label>'
                                                    + '<div class="msg_b_row"><div class="edit_icon" id="editIcon_' + i + '"><i class="fa fa-pencil" title="This message has been edited"></i></div><div class="msg_b" title="' + data.Data[i].StrMsgDateTime + '" id="Msg_' + i + '">' + data.Data[i].Msg + '</div>'
                                                    + '<div class= "msg_b_menu" id = "Msg_Menu_' + i + '" onclick = "ShowPopup(' + i + ',' + data.Data[i].GroupChatId + ');" >'
                                                    + '<i class= "fa fa-ellipsis-v" ></i > <div class="chat_option" id="chat_option_' + i + '">'
                                                  /*  + '<span onclick="EditGroupMessage(' + data.Data[i].GroupChatId + ',' + i + ')">Edit</span>'*/
                                                    + '<span onclick="RemoveMessage(' + data.Data[i].GroupChatId + ',' + i + ')"   >Remove</span></div>'
                                                    + '</div ></div>'
                                                );
                                            }
                                            else {
                                                $('#chatMessages').append(
                                                    '<label class="msg-time"  id="Msg_Time_' + i + '" style="display:none">' + data.Data[i].StrMsgDateTime + '</label>'
                                                    + '<div class="msg_b_row"><div class="msg_b" title="' + data.Data[i].StrMsgDateTime + '" id="Msg_' + i + '">' + data.Data[i].Msg + '</div>'
                                                    + '<div class= "msg_b_menu" id = "Msg_Menu_' + i + '" onclick = "ShowPopup(' + i + ',' + data.Data[i].GroupChatId + ');" >'
                                                    + '<i class= "fa fa-ellipsis-v" ></i > <div class="chat_option" id="chat_option_' + i + '">'
                                                   /* + '<span onclick="EditGroupMessage(' + data.Data[i].GroupChatId + ',' + i + ')">Edit</span>'*/
                                                    + '<span onclick="RemoveMessage(' + data.Data[i].GroupChatId + ',' + i + ')"   >Remove</span></div>'
                                                    + '</div ></div>'
                                                );
                                            }

                                        }
                                    }
                                    else {
                                        data.Data[i].StrMsgDateTime.split('')
                                        //message from this side
                                        if (data.Data[i].Msg.charAt(0) != "<") {
                                            if (data.Data[i].IsEdited) {
                                                $('#chatMessages').append(
                                                    '<label class="msg-time" id="Msg_Time_' + i + '">' + data.Data[i].StrMsgDateTime + '</label>'
                                                    + '<div class="msg_b_row"><div class="edit_icon" id="editIcon_' + i + '"><i class="fa fa-pencil" title="This message has been edited"></i></div><div class="msg_b" title="' + data.Data[i].StrMsgDateTime + '" id="Msg_' + i + '">' + data.Data[i].Msg + '</div>'
                                                    + '<div class= "msg_b_menu" id = "Msg_Menu_' + i + '" onclick = "ShowPopup(' + i + ',' + data.Data[i].GroupChatId + ');" >'
                                                    + '<i class= "fa fa-ellipsis-v" ></i > <div class="chat_option" id="chat_option_' + i + '">'
                                                    + '<span onclick="EditGroupMessage(' + data.Data[i].GroupChatId + ',' + i + ')">Edit</span>'
                                                    + '<span onclick="RemoveMessage(' + data.Data[i].GroupChatId + ',' + i + ')"   >Remove</span></div>'
                                                    + '</div ></div>'


                                                );
                                            }
                                            else {
                                                $('#chatMessages').append(
                                                    '<label class="msg-time" id="Msg_Time_' + i + '">' + data.Data[i].StrMsgDateTime + '</label>'
                                                    + '<div class="msg_b_row"><div class="msg_b" id="Msg_' + i + '">' + data.Data[i].Msg + '</div>'
                                                    + '<div class= "msg_b_menu" id = "Msg_Menu_' + i + '" onclick = "ShowPopup(' + i + ',' + data.Data[i].GroupChatId + ');" >'
                                                    + '<i class= "fa fa-ellipsis-v" ></i > <div class="chat_option" id="chat_option_' + i + '">'
                                                    + '<span onclick="EditGroupMessage(' + data.Data[i].GroupChatId + ',' + i + ')">Edit</span>'
                                                    + '<span onclick="RemoveMessage(' + data.Data[i].GroupChatId + ',' + i + ')"   >Remove</span></div>'
                                                    + '</div ></div>'


                                                );
                                            }

                                        }
                                        else {
                                            if (data.Data[i].IsEdited) {
                                                $('#chatMessages').append(
                                                    '<label class="msg-time" id="Msg_Time_' + i + '">' + data.Data[i].StrMsgDateTime + '</label>'
                                                    + '<div class="msg_b_row"><div class="edit_icon" id="editIcon_' + i + '"><i class="fa fa-pencil" title="This message has been edited"></i></div><div class="msg_b" title="' + data.Data[i].StrMsgDateTime + '" id="Msg_' + i + '">' + data.Data[i].Msg + '</div>'
                                                    + '<div class= "msg_b_menu" id = "Msg_Menu_' + i + '" onclick = "ShowPopup(' + i + ',' + data.Data[i].GroupChatId + ');" >'
                                                    + '<i class= "fa fa-ellipsis-v" ></i > <div class="chat_option" id="chat_option_' + i + '">'
                                                    /*+ '<span onclick="EditGroupMessage(' + data.Data[i].GroupChatId + ',' + i + ')">Edit</span>'*/
                                                    + '<span onclick="RemoveMessage(' + data.Data[i].GroupChatId + ',' + i + ')"   >Remove</span></div>'
                                                    + '</div ></div>'
                                                );
                                            }
                                            else {
                                                $('#chatMessages').append(
                                                    '<label class="msg-time" id="Msg_Time_' + i + '">' + data.Data[i].StrMsgDateTime + '</label>'
                                                    + '<div class="msg_b_row"><div class="msg_b" id="Msg_' + i + '">' + data.Data[i].Msg + '</div>'
                                                    + '<div class= "msg_b_menu" id = "Msg_Menu_' + i + '" onclick = "ShowPopup(' + i + ',' + data.Data[i].GroupChatId + ');" >'
                                                    + '<i class= "fa fa-ellipsis-v" ></i > <div class="chat_option" id="chat_option_' + i + '">'
                                                   /* + '<span onclick="EditGroupMessage(' + data.Data[i].GroupChatId + ',' + i + ')">Edit</span>'*/
                                                    + '<span onclick="RemoveMessage(' + data.Data[i].GroupChatId + ',' + i + ')"   >Remove</span></div>'
                                                    + '</div ></div>'
                                                );
                                            }

                                        }
                                    }

                                }
                                else {
                                    data.Data[i].StrMsgDateTime.split('')
                                    //message from this side
                                    if (data.Data[i].Msg.charAt(0) != "<") {
                                        if (data.Data[i].IsEdited) {
                                            $('#chatMessages').append(
                                                '<label class="msg-time" id="Msg_Time_' + i + '">' + data.Data[i].StrMsgDateTime + '</label>'
                                                + '<div class="msg_b_row"><div class="edit_icon" id="editIcon_' + i + '"><i class="fa fa-pencil" title="This message has been edited"></i></div><div class="msg_b" title="' + data.Data[i].StrMsgDateTime + '" id="Msg_' + i + '">' + data.Data[i].Msg + '</div>'
                                                + '<div class= "msg_b_menu" id = "Msg_Menu_' + i + '" onclick = "ShowPopup(' + i + ',' + data.Data[i].GroupChatId + ');" >'
                                                + '<i class= "fa fa-ellipsis-v" ></i > <div class="chat_option" id="chat_option_' + i + '">'
                                                + '<span onclick="EditGroupMessage(' + data.Data[i].GroupChatId + ',' + i + ')">Edit</span>'
                                                + '<span onclick="RemoveMessage(' + data.Data[i].GroupChatId + ',' + i + ')"   >Remove</span></div>'
                                                + '</div ></div>'


                                            );
                                        }
                                        else {
                                            $('#chatMessages').append(
                                                '<label class="msg-time" id="Msg_Time_' + i + '">' + data.Data[i].StrMsgDateTime + '</label>'
                                                + '<div class="msg_b_row"><div class="msg_b" id="Msg_' + i + '">' + data.Data[i].Msg + '</div>'
                                                + '<div class= "msg_b_menu" id = "Msg_Menu_' + i + '" onclick = "ShowPopup(' + i + ',' + data.Data[i].GroupChatId + ');" >'
                                                + '<i class= "fa fa-ellipsis-v" ></i > <div class="chat_option" id="chat_option_' + i + '">'
                                                + '<span onclick="EditGroupMessage(' + data.Data[i].GroupChatId + ',' + i + ')">Edit</span>'
                                                + '<span onclick="RemoveMessage(' + data.Data[i].GroupChatId + ',' + i + ')"   >Remove</span></div>'
                                                + '</div ></div>'


                                            );
                                        }

                                    }
                                    else {
                                        if (data.Data[i].IsEdited) {
                                            $('#chatMessages').append(
                                                '<label class="msg-time" id="Msg_Time_' + i + '">' + data.Data[i].StrMsgDateTime + '</label>'
                                                + '<div class="msg_b_row"><div class="edit_icon" id="editIcon_' + i + '"><i class="fa fa-pencil" title="This message has been edited"></i></div><div class="msg_b" title="' + data.Data[i].StrMsgDateTime + '" id="Msg_' + i + '">' + data.Data[i].Msg + '</div>'
                                                + '<div class= "msg_b_menu" id = "Msg_Menu_' + i + '" onclick = "ShowPopup(' + i + ',' + data.Data[i].GroupChatId + ');" >'
                                                + '<i class= "fa fa-ellipsis-v" ></i > <div class="chat_option" id="chat_option_' + i + '">'
                                               /* + '<span onclick="EditGroupMessage(' + data.Data[i].GroupChatId + ',' + i + ')">Edit</span>'*/
                                                + '<span onclick="RemoveMessage(' + data.Data[i].GroupChatId + ',' + i + ')"   >Remove</span></div>'
                                                + '</div ></div>'
                                            );
                                        }
                                        else {
                                            $('#chatMessages').append(
                                                '<label class="msg-time" id="Msg_Time_' + i + '">' + data.Data[i].StrMsgDateTime + '</label>'
                                                + '<div class="msg_b_row"><div class="msg_b" id="Msg_' + i + '">' + data.Data[i].Msg + '</div>'
                                                + '<div class= "msg_b_menu" id = "Msg_Menu_' + i + '" onclick = "ShowPopup(' + i + ',' + data.Data[i].GroupChatId + ');" >'
                                                + '<i class= "fa fa-ellipsis-v" ></i > <div class="chat_option" id="chat_option_' + i + '">'
                                               /* + '<span onclick="EditGroupMessage(' + data.Data[i].GroupChatId + ',' + i + ')">Edit</span>'*/
                                                + '<span onclick="RemoveMessage(' + data.Data[i].GroupChatId + ',' + i + ')"   >Remove</span></div>'
                                                + '</div ></div>'
                                            );
                                        }

                                    }
                                }



                            }
                            else {

                                var current_msg = data.Data[i].MsgDateTime;
                                var current_date = new Date(parseInt(current_msg.substr(6)));
                                if (i != 0) {
                                    var previous_msg = data.Data[i - 1].MsgDateTime;
                                    var previous_date = new Date(parseInt(previous_msg.substr(6)));

                                    var diff = Math.abs(current_date - previous_date);
                                    var minutes = Math.floor((diff / 1000) / 60);
                                    var lastDiv = $('div:last', '#chatMessages').attr('class');

                                    if (minutes <= 2 && lastDiv == "msg_a") {
                                        if (data.Data[i].ImageURL) {
                                            let imageURL = data.Data[i].ImageURL;
                                            if (data.Data[i].IsEdited) {


                                                $('#chatMessages').append(

                                                    '<div class="message-with-profile" style="display:flex;width:100%">'
                                                    + '<div class="user-profile-img" style="padding-top:0px;padding-left: 0;display: inline-block;float: left;">'
                                                    /*+ '<div class="chatAvatar msghistoryUser"><img src = "' + imageURL + '" class="chatAvatar" /></div>'*/
                                                    /*+ '<div class="chatAvatar msghistoryUser"><h4>' + strIntial + '</h4></div>'*/
                                                    + '</div>'
                                                    + '<div class="user-pro-nm" style="padding-left:38px">'
                                                    /* + '<label class="msg-time lbl_msg_sender_a">' + data.Data[i].UserName + '&nbsp;<span>' + data.Data[i].StrMsgDateTime + '</span></label>'*/
                                                    + '<div class="msg_a" title="' + data.Data[i].StrMsgDateTime + '" id="otherside_' + i + '">' + data.Data[i].Msg + '</div>'
                                                    + '</div>'
                                                    + '<div class="edit_icon"><i class="fa fa-pencil" title="This message has been edited"></i></div>'
                                                    + '</div>'


                                                );
                                            }
                                            else {
                                                $('#chatMessages').append(

                                                    '<div class="message-with-profile" style="display:flex;width:100%">'
                                                    + '<div class="user-profile-img" style="padding-top:0px;padding-left: 0;display: inline-block;float: left;">'
                                                    /*+ '<div class="chatAvatar msghistoryUser"><img src = "' + imageURL + '" class="chatAvatar" /></div>'*/
                                                    /*+ '<div class="chatAvatar msghistoryUser"><h4>' + strIntial + '</h4></div>'*/
                                                    + '</div>'
                                                    + '<div class="user-pro-nm" style="padding-left:38px">'
                                                    /* + '<label class="msg-time lbl_msg_sender_a">' + data.Data[i].UserName + '&nbsp;<span>' + data.Data[i].StrMsgDateTime + '</span></label>'*/
                                                    + '<div class="msg_a" title="' + data.Data[i].StrMsgDateTime + '" id="otherside_' + i + '">' + data.Data[i].Msg + '</div>'
                                                    + '</div>'
                                                    + '</div>'


                                                );
                                            }
                                            /*console.log("Image is there");*/

                                        }
                                        else {
                                            //message from other side
                                            var strIntial = "";
                                            var initial = data.Data[i].UserName.split(" ");
                                            if (initial.length > 0) {
                                                strIntial = initial[0].charAt(0);
                                                if (initial.length > 1) {
                                                    strIntial += initial[1].charAt(0);
                                                }

                                            }
                                            if (data.Data[i].IsEdited) {
                                                $('#chatMessages').append(

                                                    '<div class="message-with-profile" style="display:flex;width:100%">'
                                                    + '<div class="user-profile-img" style="padding-top:0px;padding-left: 0;display: inline-block;float: left;">'
                                                    /*+ '<div class="chatAvatar msghistoryUser"><h4>' + strIntial + '</h4></div>'*/
                                                    + '</div>'
                                                    + '<div class="user-pro-nm" style="padding-left:38px;">'
                                                    /* + '<label class="msg-time lbl_msg_sender_a">' + data.Data[i].UserName + '&nbsp;<span>' + data.Data[i].StrMsgDateTime + '</span></label>'*/
                                                    + '<div class="msg_a" title="' + data.Data[i].StrMsgDateTime + '" id="otherside_' + i + '">' + data.Data[i].Msg + '</div>'
                                                    + '</div>'
                                                    + '<div class="edit_icon"><i class="fa fa-pencil" title="This message has been edited"></i></div>'
                                                    + '</div>'

                                                );
                                            }
                                            else {
                                                $('#chatMessages').append(

                                                    '<div class="message-with-profile" style="display:flex;width:100%">'
                                                    + '<div class="user-profile-img" style="padding-top:0px;padding-left: 0;display: inline-block;float: left;">'
                                                    /*+ '<div class="chatAvatar msghistoryUser"><h4>' + strIntial + '</h4></div>'*/
                                                    + '</div>'
                                                    + '<div class="user-pro-nm" style="padding-left:38px;">'
                                                    /* + '<label class="msg-time lbl_msg_sender_a">' + data.Data[i].UserName + '&nbsp;<span>' + data.Data[i].StrMsgDateTime + '</span></label>'*/
                                                    + '<div class="msg_a" title="' + data.Data[i].StrMsgDateTime + '" id="otherside_' + i + '">' + data.Data[i].Msg + '</div>'
                                                    + '</div>'
                                                    + '</div>'

                                                );
                                            }

                                        }
                                    }
                                    else {
                                        if (data.Data[i].ImageURL) {
                                            let imageURL = data.Data[i].ImageURL;
                                            if (data.Data[i].IsEdited) {
                                                $('#chatMessages').append(

                                                    '<div class="message-with-profile" style="display:flex;width:100%">'
                                                    + '<div class="user-profile-img" style="padding-top:0px;padding-left: 0;display: inline-block;float: left;">'
                                                    + '<div class="chatAvatar msghistoryUser"><img src = "' + imageURL + '" class="chatAvatar" /></div>'
                                                    /*+ '<div class="chatAvatar msghistoryUser"><h4>' + strIntial + '</h4></div>'*/
                                                    + '</div>'
                                                    + '<div class="user-pro-nm">'
                                                    + '<label class="msg-time lbl_msg_sender_a">' + data.Data[i].UserName + '&nbsp;<span>' + data.Data[i].StrMsgDateTime + '</span></label>'
                                                    + '<div class="msg_a" title="' + data.Data[i].StrMsgDateTime + '" id="otherside_' + i + '">' + data.Data[i].Msg + '</div>'
                                                    + '</div>'
                                                    + '<div class="edit_icon"><i class="fa fa-pencil" title="This message has been edited"></i></div>'/*edited*/
                                                    + '</div>'


                                                );
                                            }
                                            else {
                                                $('#chatMessages').append(

                                                    '<div class="message-with-profile" style="display:flex;width:100%">'
                                                    + '<div class="user-profile-img" style="padding-top:0px;padding-left: 0;display: inline-block;float: left;">'
                                                    + '<div class="chatAvatar msghistoryUser"><img src = "' + imageURL + '" class="chatAvatar" /></div>'
                                                    /*+ '<div class="chatAvatar msghistoryUser"><h4>' + strIntial + '</h4></div>'*/
                                                    + '</div>'
                                                    + '<div class="user-pro-nm">'
                                                    + '<label class="msg-time lbl_msg_sender_a">' + data.Data[i].UserName + '&nbsp;<span>' + data.Data[i].StrMsgDateTime + '</span></label>'
                                                    + '<div class="msg_a" id="otherside_' + i + '">' + data.Data[i].Msg + '</div>'
                                                    + '</div>'
                                                    + '</div>'


                                                );
                                            }
                                            /*console.log("Image is there");*/

                                        }
                                        else {
                                            //message from other side
                                            var strIntial = "";
                                            var initial = data.Data[i].UserName.split(" ");
                                            if (initial.length > 0) {
                                                strIntial = initial[0].charAt(0);
                                                if (initial.length > 1) {
                                                    strIntial += initial[1].charAt(0);
                                                }

                                            }
                                            if (data.Data[i].IsEdited) {
                                                $('#chatMessages').append(

                                                    '<div class="message-with-profile" style="display:flex;width:100%">'
                                                    + '<div class="user-profile-img" style="padding-top:0px;padding-left: 0;display: inline-block;float: left;">'
                                                    + '<div class="chatAvatar msghistoryUser"><h4>' + strIntial + '</h4></div>'
                                                    + '</div>'
                                                    + '<div class="user-pro-nm">'
                                                    + '<label class="msg-time lbl_msg_sender_a">' + data.Data[i].UserName + '&nbsp;<span>' + data.Data[i].StrMsgDateTime + '</span></label>'
                                                    + '<div class="msg_a" title="' + data.Data[i].StrMsgDateTime + '" id="otherside_' + i + '">' + data.Data[i].Msg + '</div>'
                                                    + '</div>'
                                                    + '<div class="edit_icon"><i class="fa fa-pencil" title="This message has been edited"></i></div>'/*edited*/
                                                   /* + '<div class="msg_a" title="' + data.Data[i].StrMsgDateTime + '" id="otherside_' + i + '">' + data.Data[i].Msg + '</div>'*/
                                                    + '</div>'

                                                );
                                            }
                                            else {
                                                $('#chatMessages').append(

                                                    '<div class="message-with-profile" style="display:flex;width:100%">'
                                                    + '<div class="user-profile-img" style="padding-top:0px;padding-left: 0;display: inline-block;float: left;">'
                                                    + '<div class="chatAvatar msghistoryUser"><h4>' + strIntial + '</h4></div>'
                                                    + '</div>'
                                                    + '<div class="user-pro-nm">'
                                                    + '<label class="msg-time lbl_msg_sender_a">' + data.Data[i].UserName + '&nbsp;<span>' + data.Data[i].StrMsgDateTime + '</span></label>'
                                                    + '<div class="msg_a" id="otherside_' + i + '">' + data.Data[i].Msg + '</div>'
                                                    + '</div>'
                                                    + '</div>'

                                                );
                                            }

                                        }
                                    }
                                }
                                else {
                                    if (data.Data[i].ImageURL) {
                                        let imageURL = data.Data[i].ImageURL;
                                        /*console.log("Image is there");*/
                                        if (data.Data[i].IsEdited) {
                                            $('#chatMessages').append(

                                                '<div class="message-with-profile" style="display:flex;width:100%">'
                                                + '<div class="user-profile-img" style="padding-top:0px;padding-left: 0;display: inline-block;float: left;">'
                                                + '<div class="chatAvatar msghistoryUser"><img src = "' + imageURL + '" class="chatAvatar" /></div>'
                                                /*+ '<div class="chatAvatar msghistoryUser"><h4>' + strIntial + '</h4></div>'*/
                                                + '</div>'
                                                + '<div class="user-pro-nm">'
                                                + '<label class="msg-time lbl_msg_sender_a">' + data.Data[i].UserName + '&nbsp;<span>' + data.Data[i].StrMsgDateTime + '</span></label>'
                                                + '<div class="msg_a" id="otherside_' + i + '">' + data.Data[i].Msg + '</div>'
                                                + '</div>'
                                                + '<div class="edit_icon"><i class="fa fa-pencil" title="This message has been edited"></i></div>'/*edited*/
                                                + '</div>'


                                            );
                                        }
                                        else {
                                            $('#chatMessages').append(

                                                '<div class="message-with-profile" style="display:flex;width:100%">'
                                                + '<div class="user-profile-img" style="padding-top:0px;padding-left: 0;display: inline-block;float: left;">'
                                                + '<div class="chatAvatar msghistoryUser"><img src = "' + imageURL + '" class="chatAvatar" /></div>'
                                                /*+ '<div class="chatAvatar msghistoryUser"><h4>' + strIntial + '</h4></div>'*/
                                                + '</div>'
                                                + '<div class="user-pro-nm">'
                                                + '<label class="msg-time lbl_msg_sender_a">' + data.Data[i].UserName + '&nbsp;<span>' + data.Data[i].StrMsgDateTime + '</span></label>'
                                                + '<div class="msg_a" id="otherside_' + i + '">' + data.Data[i].Msg + '</div>'
                                                + '</div>'
                                                + '</div>'


                                            );
                                        }

                                    }
                                    else {
                                        //message from other side
                                        var strIntial = "";
                                        var initial = data.Data[i].UserName.split(" ");
                                        if (initial.length > 0) {
                                            strIntial = initial[0].charAt(0);
                                            if (initial.length > 1) {
                                                strIntial += initial[1].charAt(0);
                                            }

                                        }
                                        if (data.Data[i].IsEdited) {
                                            $('#chatMessages').append(

                                                '<div class="message-with-profile" style="display:flex;width:100%">'
                                                + '<div class="user-profile-img" style="padding-top:0px;padding-left: 0;display: inline-block;float: left;">'
                                                + '<div class="chatAvatar msghistoryUser"><h4>' + strIntial + '</h4></div>'
                                                + '</div>'
                                                + '<div class="user-pro-nm">'
                                                + '<label class="msg-time lbl_msg_sender_a">' + data.Data[i].UserName + '&nbsp;<span>' + data.Data[i].StrMsgDateTime + '</span></label>'
                                                + '<div class="msg_a" id="otherside_' + i + '">' + data.Data[i].Msg + '</div>'
                                                + '</div>'
                                                + '<div class="edit_icon"><i class="fa fa-pencil" title="This message has been edited"></i></div>'/*edited*/
                                                + '</div>'

                                            );
                                        }
                                        else {
                                            $('#chatMessages').append(

                                                '<div class="message-with-profile" style="display:flex;width:100%">'
                                                + '<div class="user-profile-img" style="padding-top:0px;padding-left: 0;display: inline-block;float: left;">'
                                                + '<div class="chatAvatar msghistoryUser"><h4>' + strIntial + '</h4></div>'
                                                + '</div>'
                                                + '<div class="user-pro-nm">'
                                                + '<label class="msg-time lbl_msg_sender_a">' + data.Data[i].UserName + '&nbsp;<span>' + data.Data[i].StrMsgDateTime + '</span></label>'
                                                + '<div class="msg_a" id="otherside_' + i + '">' + data.Data[i].Msg + '</div>'
                                                + '</div>'
                                                + '</div>'

                                            );
                                        }

                                    }
                                }



                            }
                        }
                        scrollChatDiv();
                    }
                }
            }
        });
    }
    function SavePrivateChatToDB(Message) {
        //$('.loader').show();
        var files = $('#ChatAttachment').prop('files');
        let attachmentfile = new FormData();
        for (let index = 0; index < files.length; index++) {
            attachmentfile.append('file' + index, files[index]);
        }
        attachmentfile.append('MsgTo', $("#SignalR_TO_DB_ID").val());
        attachmentfile.append('Msg', Message);
        let chatId = $('#ChatId').val() == '' ? 0 : $('#ChatId').val();
        attachmentfile.append('ChatId', chatId);

        $.ajax({
            url: '@Url.Action("SavePrivateConversations", "SignalRHelper")',
            async: false,
            type: 'POST',
            contentType: false,
            processData: false,
            data: attachmentfile,
            success: function (data) {
                //$('.loader').hide();


                if (data.Success) {
                    //var id = $('#ChatAttachment').attr('id');
                    emojiCode = [];
                    $('#ChatAttachment').val('');
                    $("#ChatAttachmentBadge").hide();
                    $("#ChatAttachmentBadge").html(0);
                    /* privateChat(data.Data, $('#DyId').val(), 1);*/
                    if (chatId != 0) {
                        privateChat(data.Data, data.Message, 1);
                    }
                    else {
                        privateChat(data.Data, data.Message, 0);
                    }

                    $('#ChatId').val("0");
                   /* $('#Msg_' + $('#DyId').val()).text(Message);*/
                    $("#TxtMessage").val('');
                    //$('#chatMessages').html('');
                    //LoadPrivateChatFromDB();
                }
                else {
                    toastr.error("Something went wrong please try again later.");
                }
            }
        });
    }
    function LoadPrivateChatFromDB() {

        //$('.loader').show();

        $.ajax({
            url: '@Url.Action("GetPrivateConversations", "SignalRHelper")',
            async: false,
            type: 'POST',
            data: { MsgTo: $("#SignalR_TO_DB_ID").val()},
            success: function (data) {

               // $('.loader').hide();


                if (data.Success && data.Data != null) {
                    var msgDayList = [];
                    if (data.Data.length > 0) {

                        var todayExist = false;
                        //var pre_msd_date = new Date();

                        for (var i = 0; i < data.Data.length; i++) {

                            //added

                            var current_msg = data.Data[i].MsgDateTime;
                            var current_date = new Date(parseInt(current_msg.substr(6)));
                            if (i != 0) {

                                var previous_msg = data.Data[i - 1].MsgDateTime;
                                var previous_date = new Date(parseInt(previous_msg.substr(6)));

                                var diff = Math.abs(current_date - previous_date);
                                var minutes = Math.floor((diff / 1000) / 60);

                                var lastDiv = $('div:last', '#chatMessages').attr('class');
                                if (minutes <= 2 ) {

                                    if (lastDiv == "msg_a") {

                                        var status = msgDayList.includes(data.Data[i].MessageDay);
                                        if (data.Data[i].MsgFrom === parseInt($("#SignalR_TO_DB_ID").val())) {
                                            if (!status) {
                                                $('#chatMessages').append('<p class="time-summary-day">' + data.Data[i].MessageDay + '</p>');
                                                msgDayList.push(data.Data[i].MessageDay);
                                            }
                                            //message from other side
                                            //'<p class="time-summary-day-sticky">' + data.Data[i].MessageDay + '</p>'
                                            if (data.Data[i].IsEdited) {

                                                var userprofile_src = $("#headeruser img").attr("src");
                                                if (userprofile_src) {
                                                    $('#chatMessages').append(
                                                        '<div class="message-with-profile" style="display:flex;width:100%">'
                                                        + '<div class="user-profile-img" style="padding-top:0px;padding-left: 0;display: inline-block;float: left;"></div>'
                                                        + '<div class="user-pro-nm" style="padding-left:38px">'
                                                        + '<div class="msg_a" title="' + data.Data[i].StrMsgDateTime + '" id="otherside_' + i + '">' + data.Data[i].Msg + '</div></div><div class="edit_icon"><i class="fa fa-pencil" title="This message has been edited"></i></div>'
                                                        + '</div>'
                                                    );
                                                }
                                                else {
                                                    /* var userInitial = $("#TopChannelDiv h4")[0].outerText;*/
                                                    var userInitial = $(".user-profile-name")[0].outerText;
                                                    var strIntial = "";
                                                    var initial = userInitial.split(" ");
                                                    if (initial.length > 0) {
                                                        strIntial = initial[0].charAt(0);
                                                        if (initial.length > 1) {
                                                            strIntial += initial[1].charAt(0);
                                                        }
                                                    }


                                                    $('#chatMessages').append(
                                                        '<div class="message-with-profile" style="display:flex;width:100%">'
                                                        + '<div class="user-profile-img" style="padding-top:0px;padding-left: 0;display: inline-block;float: left;"></div>'
                                                        + '<div class="user-pro-nm" style="padding-left:38px">'
                                                        + '<div class="msg_a" title="' + data.Data[i].StrMsgDateTime + '" id="otherside_' + i + '">' + data.Data[i].Msg + '</div></div><div class="edit_icon"><i class="fa fa-pencil" title="This message has been edited"></i></div>'
                                                        + '</div>'
                                                    );
                                                }
                                                //$('#chatMessages').append(
                                                //    '<div class="message-with-profile" style="display:flex;width:100%">'
                                                //    + '<div class="user-profile-img" style="padding-top:0px;padding-left: 0;display: inline-block;float: left;"><div class="chatAvatar openChatbox msghistoryUser"><h4>KP</h4></div></div>'
                                                //    + '<div class="user-pro-nm"><label class="msg-time">' + data.Data[i].StrMsgDateTime + '</label>'
                                                //    + '<div class="msg_a" id="otherside_' + i + '">' + data.Data[i].Msg + '</div></div><div class="edit_icon"><i class="fa fa-pencil" title="This message has been edited"></i></div>'
                                                //    + '</div>'
                                                //);



                                            }
                                            else {

                                                var userprofile_src = $("#headeruser img").attr("src");
                                                /*  var userInitial = $(".user-profile-name")[0].outerText;*/
                                                if (userprofile_src) {
                                                    $('#chatMessages').append(
                                                        '<div class="message-with-profile" style="display:flex;width:100%">'
                                                        + '<div class="user-profile-img" style="padding-top:0px;padding-left: 0;display: inline-block;float: left;"></div>'
                                                        + '<div class="user-pro-nm" style="padding-left:38px">'
                                                        + '<div class="msg_a" title="' + data.Data[i].StrMsgDateTime + '" id="otherside_' + i + '">' + data.Data[i].Msg + '</div></div>'
                                                        + '</div>'
                                                    );
                                                }
                                                else {
                                                    /*var userInitial = $("#headeruser h4")[0].outerText;*/
                                                    var userInitial = $(".user-profile-name")[0].outerText;
                                                    var strIntial = "";
                                                    var initial = userInitial.split(" ");
                                                    if (initial.length > 0) {
                                                        strIntial = initial[0].charAt(0);
                                                        if (initial.length > 1) {
                                                            strIntial += initial[1].charAt(0);
                                                        }
                                                    }


                                                    $('#chatMessages').append(
                                                        '<div class="message-with-profile" style="display:flex;width:100%">'
                                                        + '<div class="user-profile-img" style="padding-top:0px;padding-left: 0;display: inline-block;float: left;"></div>'
                                                        + '<div class="user-pro-nm" style="padding-left:38px">'
                                                        + '<div class="msg_a" title="' + data.Data[i].StrMsgDateTime + '" id="otherside_' + i + '">' + data.Data[i].Msg + '</div></div>'
                                                        + '</div>'
                                                    );
                                                }
                                                //$('#chatMessages').append(
                                                //    '<div class="message-with-profile" style="display:flex;width:100%">'
                                                //    + '<div class="user-profile-img" style="padding-top:0px;padding-left: 0;display: inline-block;float: left;"><div class="chatAvatar openChatbox msghistoryUser"><h4>KP</h4></div></div>'
                                                //    + '<div class="user-pro-nm"><label class="msg-time">' + data.Data[i].StrMsgDateTime+ '</label>'
                                                //    + '<div class="msg_a" id="otherside_' + i + '">' + data.Data[i].Msg + '</div></div>'
                                                //    +'</div>'
                                                //);


                                            }

                                        }

                                        else {

                                            //message from this side
                                            if (!status) {
                                                $('#chatMessages').append('<p class="time-summary-day">' + data.Data[i].MessageDay + '</p>');
                                                msgDayList.push(data.Data[i].MessageDay);
                                            }
                                            if (data.Data[i].Msg.charAt(0) != "<") {
                                                if (data.Data[i].IsEdited) {

                                                    $('#chatMessages').append(`<label class="msg-time" id="Msg_Time_${i}" style="">${data.Data[i].StrMsgDateTime}</label><div class="msg_b_row"><div class="edit_icon" id="editIcon_${i}"><i class="fa fa-pencil" title="This message has been edited"></i></div><div class="msg_b" id="Msg_${i}">${data.Data[i].Msg}</div>`
                                                        + `<div class="msg_b_menu" id="Msg_Menu_${i}" onclick="ShowPopup(${i},${data.Data[i].PersonalChatId});">`
                                                        + `<i class="fa fa-ellipsis-v"></i><div class="chat_option" id="chat_option_${i}">`
                                                        + `<span onclick="EditMessage(${data.Data[i].PersonalChatId},${i})">Edit</span>`
                                                        + `<span onclick="RemoveMessage(${data.Data[i].PersonalChatId},${i})">Remove</span></div>`
                                                        + `</div></div>`);
                                                }
                                                else {
                                                    $('#chatMessages').append(`<label class="msg-time" id="Msg_Time_${i}" style="">${data.Data[i].StrMsgDateTime}</label><div class="msg_b_row"><div class="msg_b" id="Msg_${i}">${data.Data[i].Msg}</div>`
                                                        + `<div class="msg_b_menu" id="Msg_Menu_${i}" onclick="ShowPopup(${i},${data.Data[i].PersonalChatId});">`
                                                        + `<i class="fa fa-ellipsis-v"></i><div class="chat_option" id="chat_option_${i}">`
                                                        + `<span onclick="EditMessage(${data.Data[i].PersonalChatId},${i})">Edit</span>`
                                                        + `<span onclick="RemoveMessage(${data.Data[i].PersonalChatId},${i})">Remove</span></div>`
                                                        + `</div></div>`);
                                                }


                                            }
                                            else {

                                                var lastMsg_time = $('#chatMessages label.msg-time:last').text();
                                                var fg = $('label:last', '.msg-time').attr('id');
                                                $('#chatMessages').append(`<label class="msg-time" id="Msg_Time_${i}" style="">${data.Data[i].StrMsgDateTime}</label><div class="msg_b_row"><div class="msg_b" id="Msg_${i}">${data.Data[i].Msg}</div>`
                                                    + `<div class="msg_b_menu" id="Msg_Menu_${i}" onclick="ShowPopup(${i},${data.Data[i].PersonalChatId});">`
                                                    + `<i class="fa fa-ellipsis-v"></i><div class="chat_option" id="chat_option_${i}">`
                                                    + `<span onclick="RemoveMessage(${data.Data[i].PersonalChatId},${i})">Remove</span></div>`
                                                    + `</div></div>`);


                                            }

                                        }

                                    }

                                    else {

                                        var status = msgDayList.includes(data.Data[i].MessageDay);
                                        if (data.Data[i].MsgFrom === parseInt($("#SignalR_TO_DB_ID").val())) {
                                            if (!status) {
                                                $('#chatMessages').append('<p class="time-summary-day">' + data.Data[i].MessageDay + '</p>');
                                                msgDayList.push(data.Data[i].MessageDay);
                                            }
                                            //message from other side
                                            //'<p class="time-summary-day-sticky">' + data.Data[i].MessageDay + '</p>'
                                            if (data.Data[i].IsEdited) {

                                                var userprofile_src = $("#headeruser img").attr("src");
                                                if (userprofile_src) {
                                                    $('#chatMessages').append(
                                                        '<div class="message-with-profile" style="display:flex;width:100%">'
                                                        + '<div class="user-profile-img" style="padding-top:0px;padding-left: 0;display: inline-block;float: left;"><div class="chatAvatar openChatbox msghistoryUser"><img class="chatAvatar" src="' + userprofile_src + '"></div></div>'
                                                        + '<div class="user-pro-nm"><label class="msg-time">' + data.Data[i].StrMsgDateTime + '</label>'
                                                        + '<div class="msg_a" id="otherside_' + i + '">' + data.Data[i].Msg + '</div></div><div class="edit_icon"><i class="fa fa-pencil" title="This message has been edited"></i></div>'
                                                        + '</div>'
                                                    );
                                                }
                                                else {
                                                    /* var userInitial = $("#TopChannelDiv h4")[0].outerText;*/
                                                     var userInitial = $(".user-profile-name")[0].outerText;
                                                    var strIntial = "";
                                                    var initial = userInitial.split(" ");
                                                    if (initial.length > 0) {
                                                        strIntial = initial[0].charAt(0);
                                                        if (initial.length > 1) {
                                                            strIntial += initial[1].charAt(0);
                                                        }
                                                    }


                                                    $('#chatMessages').append(
                                                        '<div class="message-with-profile" style="display:flex;width:100%">'
                                                        + '<div class="user-profile-img" style="padding-top:0px;padding-left: 0;display: inline-block;float: left;"><div class="chatAvatar openChatbox msghistoryUser"><h4>' + strIntial + '</h4></div></div>'
                                                        + '<div class="user-pro-nm"><label class="msg-time">' + data.Data[i].StrMsgDateTime + '</label>'
                                                        + '<div class="msg_a" id="otherside_' + i + '">' + data.Data[i].Msg + '</div></div><div class="edit_icon"><i class="fa fa-pencil" title="This message has been edited"></i></div>'
                                                        + '</div>'
                                                    );
                                                }
                                                //$('#chatMessages').append(
                                                //    '<div class="message-with-profile" style="display:flex;width:100%">'
                                                //    + '<div class="user-profile-img" style="padding-top:0px;padding-left: 0;display: inline-block;float: left;"><div class="chatAvatar openChatbox msghistoryUser"><h4>KP</h4></div></div>'
                                                //    + '<div class="user-pro-nm"><label class="msg-time">' + data.Data[i].StrMsgDateTime + '</label>'
                                                //    + '<div class="msg_a" id="otherside_' + i + '">' + data.Data[i].Msg + '</div></div><div class="edit_icon"><i class="fa fa-pencil" title="This message has been edited"></i></div>'
                                                //    + '</div>'
                                                //);
                                            }
                                            else {

                                                var userprofile_src = $("#headeruser img").attr("src");
                                                /*  var userInitial = $(".user-profile-name")[0].outerText;*/
                                                if (userprofile_src) {
                                                    $('#chatMessages').append(
                                                        '<div class="message-with-profile" style="display:flex;width:100%">'
                                                        + '<div class="user-profile-img" style="padding-top:0px;padding-left: 0;display: inline-block;float: left;"><div class="chatAvatar openChatbox msghistoryUser"><img class="chatAvatar" src="' + userprofile_src + '"></div></div>'
                                                        + '<div class="user-pro-nm"><label class="msg-time">' + data.Data[i].StrMsgDateTime + '</label>'
                                                        + '<div class="msg_a" id="otherside_' + i + '">' + data.Data[i].Msg + '</div></div>'
                                                        + '</div>'
                                                    );
                                                }
                                                else {
                                                  /*  var userInitial = $("#headeruser h4")[0].outerText;*/
                                                    var userInitial = $(".user-profile-name")[0].outerText;
                                                    var strIntial = "";
                                                    var initial = userInitial.split(" ");
                                                    if (initial.length > 0) {
                                                        strIntial = initial[0].charAt(0);
                                                        if (initial.length > 1) {
                                                            strIntial += initial[1].charAt(0);
                                                        }
                                                    }


                                                    $('#chatMessages').append(
                                                        '<div class="message-with-profile" style="display:flex;width:100%">'
                                                        + '<div class="user-profile-img" style="padding-top:0px;padding-left: 0;display: inline-block;float: left;"><div class="chatAvatar openChatbox msghistoryUser"><h4>' + strIntial + '</h4></div></div>'
                                                        + '<div class="user-pro-nm"><label class="msg-time">' + data.Data[i].StrMsgDateTime + '</label>'
                                                        + '<div class="msg_a" id="otherside_' + i + '">' + data.Data[i].Msg + '</div></div>'
                                                        + '</div>'
                                                    );
                                                }
                                                //$('#chatMessages').append(
                                                //    '<div class="message-with-profile" style="display:flex;width:100%">'
                                                //    + '<div class="user-profile-img" style="padding-top:0px;padding-left: 0;display: inline-block;float: left;"><div class="chatAvatar openChatbox msghistoryUser"><h4>KP</h4></div></div>'
                                                //    + '<div class="user-pro-nm"><label class="msg-time">' + data.Data[i].StrMsgDateTime+ '</label>'
                                                //    + '<div class="msg_a" id="otherside_' + i + '">' + data.Data[i].Msg + '</div></div>'
                                                //    +'</div>'
                                                //);
                                            }

                                        }
                                        else {

                                            //message from this side
                                            if (!status) {
                                                $('#chatMessages').append('<p class="time-summary-day">' + data.Data[i].MessageDay + '</p>');
                                                msgDayList.push(data.Data[i].MessageDay);
                                            }
                                            if (data.Data[i].Msg.charAt(0) != "<") {
                                                if (data.Data[i].IsEdited) {

                                                    $('#chatMessages').append(`<label class="msg-time" id="Msg_Time_${i}" style="display:none">${data.Data[i].StrMsgDateTime}</label><div class="msg_b_row"><div class="edit_icon" id="editIcon_${i}"><i class="fa fa-pencil" title="This message has been edited"></i></div><div class="msg_b" title="${data.Data[i].StrMsgDateTime}" id="Msg_${i}">${data.Data[i].Msg}</div>`
                                                        + `<div class="msg_b_menu" id="Msg_Menu_${i}" onclick="ShowPopup(${i},${data.Data[i].PersonalChatId});">`
                                                        + `<i class="fa fa-ellipsis-v"></i><div class="chat_option" id="chat_option_${i}">`
                                                        + `<span onclick="EditMessage(${data.Data[i].PersonalChatId},${i})">Edit</span>`
                                                        + `<span onclick="RemoveMessage(${data.Data[i].PersonalChatId},${i})">Remove</span></div>`
                                                        + `</div></div>`); /*<label class="msg-time" id="Msg_Time_${i}" style="">${data.Data[i].StrMsgDateTime}</label>*/
                                                }
                                                else {
                                                    $('#chatMessages').append(`<label class="msg-time" id="Msg_Time_${i}" style="display:none">${data.Data[i].StrMsgDateTime}</label><div class="msg_b_row"><div class="msg_b" title="${data.Data[i].StrMsgDateTime}" id="Msg_${i}">${data.Data[i].Msg}</div>`
                                                        + `<div class="msg_b_menu" id="Msg_Menu_${i}" onclick="ShowPopup(${i},${data.Data[i].PersonalChatId});">`
                                                        + `<i class="fa fa-ellipsis-v"></i><div class="chat_option" id="chat_option_${i}">`
                                                        + `<span onclick="EditMessage(${data.Data[i].PersonalChatId},${i})">Edit</span>`
                                                        + `<span onclick="RemoveMessage(${data.Data[i].PersonalChatId},${i})">Remove</span></div>`
                                                        + `</div></div>`); /*<label class="msg-time" id="Msg_Time_${i}" style="">${data.Data[i].StrMsgDateTime}</label>*/
                                                }


                                            }
                                            else {

                                                $('#chatMessages').append(`<label class="msg-time" id="Msg_Time_${i}" style="display:none">${data.Data[i].StrMsgDateTime}</label><div class="msg_b_row"><div class="msg_b" title="${data.Data[i].StrMsgDateTime}" id="Msg_${i}">${data.Data[i].Msg}</div>`
                                                    + `<div class="msg_b_menu" id="Msg_Menu_${i}" onclick="ShowPopup(${i},${data.Data[i].PersonalChatId});">`
                                                    + `<i class="fa fa-ellipsis-v"></i><div class="chat_option" id="chat_option_${i}">`
                                                    + `<span onclick="RemoveMessage(${data.Data[i].PersonalChatId},${i})">Remove</span></div>`
                                                    + `</div></div>`); /*<label class="msg-time" id="Msg_Time_${i}" style="">${data.Data[i].StrMsgDateTime}</label>*/


                                            }

                                        }

                                    }



                                }



                                else {
                                    var status = msgDayList.includes(data.Data[i].MessageDay);
                                    if (data.Data[i].MsgFrom === parseInt($("#SignalR_TO_DB_ID").val())) {
                                        if (!status) {
                                            $('#chatMessages').append('<p class="time-summary-day">' + data.Data[i].MessageDay + '</p>');
                                            msgDayList.push(data.Data[i].MessageDay);
                                        }
                                        //message from other side
                                        //'<p class="time-summary-day-sticky">' + data.Data[i].MessageDay + '</p>'
                                        if (data.Data[i].IsEdited) {

                                            var userprofile_src = $("#headeruser img").attr("src");
                                            if (userprofile_src) {
                                                $('#chatMessages').append(
                                                    '<div class="message-with-profile" style="display:flex;width:100%">'
                                                    + '<div class="user-profile-img" style="padding-top:0px;padding-left: 0;display: inline-block;float: left;"><div class="chatAvatar openChatbox msghistoryUser"><img class="chatAvatar" src="' + userprofile_src + '"></div></div>'
                                                    + '<div class="user-pro-nm"><label class="msg-time">' + data.Data[i].StrMsgDateTime + '</label>'
                                                    + '<div class="msg_a" id="otherside_' + i + '">' + data.Data[i].Msg + '</div></div><div class="edit_icon"><i class="fa fa-pencil" title="This message has been edited"></i></div>'
                                                    + '</div>'
                                                );
                                            }
                                            else {
                                                /* var userInitial = $("#TopChannelDiv h4")[0].outerText;*/
                                               var userInitial = $(".user-profile-name")[0].outerText;
                                                var strIntial = "";
                                                var initial = userInitial.split(" ");
                                                if (initial.length > 0) {
                                                    strIntial = initial[0].charAt(0);
                                                    if (initial.length > 1) {
                                                        strIntial += initial[1].charAt(0);
                                                    }
                                                }


                                                $('#chatMessages').append(
                                                    '<div class="message-with-profile" style="display:flex;width:100%">'
                                                    + '<div class="user-profile-img" style="padding-top:0px;padding-left: 0;display: inline-block;float: left;"><div class="chatAvatar openChatbox msghistoryUser"><h4>' + strIntial + '</h4></div></div>'
                                                    + '<div class="user-pro-nm"><label class="msg-time">' + data.Data[i].StrMsgDateTime + '</label>'
                                                    + '<div class="msg_a" id="otherside_' + i + '">' + data.Data[i].Msg + '</div></div><div class="edit_icon"><i class="fa fa-pencil" title="This message has been edited"></i></div>'
                                                    + '</div>'
                                                );
                                            }
                                            //$('#chatMessages').append(
                                            //    '<div class="message-with-profile" style="display:flex;width:100%">'
                                            //    + '<div class="user-profile-img" style="padding-top:0px;padding-left: 0;display: inline-block;float: left;"><div class="chatAvatar openChatbox msghistoryUser"><h4>KP</h4></div></div>'
                                            //    + '<div class="user-pro-nm"><label class="msg-time">' + data.Data[i].StrMsgDateTime + '</label>'
                                            //    + '<div class="msg_a" id="otherside_' + i + '">' + data.Data[i].Msg + '</div></div><div class="edit_icon"><i class="fa fa-pencil" title="This message has been edited"></i></div>'
                                            //    + '</div>'
                                            //);
                                        }
                                        else {

                                             var userprofile_src = $("#headeruser img").attr("src");
                                            /*  var userInitial = $(".user-profile-name")[0].outerText;*/
                                            if (userprofile_src) {
                                                $('#chatMessages').append(
                                                    '<div class="message-with-profile" style="display:flex;width:100%">'
                                                    + '<div class="user-profile-img" style="padding-top:0px;padding-left: 0;display: inline-block;float: left;"><div class="chatAvatar openChatbox msghistoryUser"><img class="chatAvatar" src="' + userprofile_src + '"></div></div>'
                                                    + '<div class="user-pro-nm"><label class="msg-time">' + data.Data[i].StrMsgDateTime + '</label>'
                                                    + '<div class="msg_a" id="otherside_' + i + '">' + data.Data[i].Msg + '</div></div>'
                                                    + '</div>'
                                                );
                                            }
                                            else {
                                               /* var userInitial = $("#headeruser h4")[0].outerText;*/
                                                var userInitial = $(".user-profile-name")[0].outerText;
                                                var strIntial = "";
                                                var initial = userInitial.split(" ");
                                                if (initial.length > 0) {
                                                    strIntial = initial[0].charAt(0);
                                                    if (initial.length > 1) {
                                                        strIntial += initial[1].charAt(0);
                                                    }
                                                }


                                                $('#chatMessages').append(
                                                    '<div class="message-with-profile" style="display:flex;width:100%">'
                                                    + '<div class="user-profile-img" style="padding-top:0px;padding-left: 0;display: inline-block;float: left;"><div class="chatAvatar openChatbox msghistoryUser"><h4>' + strIntial + '</h4></div></div>'
                                                    + '<div class="user-pro-nm"><label class="msg-time">' + data.Data[i].StrMsgDateTime + '</label>'
                                                    + '<div class="msg_a" id="otherside_' + i + '">' + data.Data[i].Msg + '</div></div>'
                                                    + '</div>'
                                                );
                                            }
                                            //$('#chatMessages').append(
                                            //    '<div class="message-with-profile" style="display:flex;width:100%">'
                                            //    + '<div class="user-profile-img" style="padding-top:0px;padding-left: 0;display: inline-block;float: left;"><div class="chatAvatar openChatbox msghistoryUser"><h4>KP</h4></div></div>'
                                            //    + '<div class="user-pro-nm"><label class="msg-time">' + data.Data[i].StrMsgDateTime+ '</label>'
                                            //    + '<div class="msg_a" id="otherside_' + i + '">' + data.Data[i].Msg + '</div></div>'
                                            //    +'</div>'
                                            //);
                                        }

                                    }
                                    else {
                                        //message from this side
                                        if (!status) {
                                            $('#chatMessages').append('<p class="time-summary-day">' + data.Data[i].MessageDay + '</p>');
                                            msgDayList.push(data.Data[i].MessageDay);
                                        }
                                        if (data.Data[i].Msg.charAt(0) != "<") {
                                            if (data.Data[i].IsEdited) {

                                                $('#chatMessages').append(`<label class="msg-time" id="Msg_Time_${i}" style="">${data.Data[i].StrMsgDateTime}</label><div class="msg_b_row"><div class="edit_icon" id="editIcon_${i}"><i class="fa fa-pencil" title="This message has been edited"></i></div><div class="msg_b" id="Msg_${i}">${data.Data[i].Msg}</div>`
                                                    + `<div class="msg_b_menu" id="Msg_Menu_${i}" onclick="ShowPopup(${i},${data.Data[i].PersonalChatId});">`
                                                    + `<i class="fa fa-ellipsis-v"></i><div class="chat_option" id="chat_option_${i}">`
                                                    + `<span onclick="EditMessage(${data.Data[i].PersonalChatId},${i})">Edit</span>`
                                                    + `<span onclick="RemoveMessage(${data.Data[i].PersonalChatId},${i})">Remove</span></div>`
                                                    + `</div></div>`);
                                            }
                                            else {
                                                $('#chatMessages').append(`<label class="msg-time" id="Msg_Time_${i}" style="">${data.Data[i].StrMsgDateTime}</label><div class="msg_b_row"><div class="msg_b" id="Msg_${i}">${data.Data[i].Msg}</div>`
                                                    + `<div class="msg_b_menu" id="Msg_Menu_${i}" onclick="ShowPopup(${i},${data.Data[i].PersonalChatId});">`
                                                    + `<i class="fa fa-ellipsis-v"></i><div class="chat_option" id="chat_option_${i}">`
                                                    + `<span onclick="EditMessage(${data.Data[i].PersonalChatId},${i})">Edit</span>`
                                                    + `<span onclick="RemoveMessage(${data.Data[i].PersonalChatId},${i})">Remove</span></div>`
                                                    + `</div></div>`);
                                            }


                                        }
                                        else {
                                            $('#chatMessages').append(`<label class="msg-time" id="Msg_Time_${i}" style="">${data.Data[i].StrMsgDateTime}</label><div class="msg_b_row"><div class="msg_b" id="Msg_${i}">${data.Data[i].Msg}</div>`
                                                + `<div class="msg_b_menu" id="Msg_Menu_${i}" onclick="ShowPopup(${i},${data.Data[i].PersonalChatId});">`
                                                + `<i class="fa fa-ellipsis-v"></i><div class="chat_option" id="chat_option_${i}">`
                                                + `<span onclick="RemoveMessage(${data.Data[i].PersonalChatId},${i})">Remove</span></div>`
                                                + `</div></div>`);


                                        }

                                    }
                                }
                            }


                            else {
                                var status = msgDayList.includes(data.Data[i].MessageDay);
                                if (data.Data[i].MsgFrom === parseInt($("#SignalR_TO_DB_ID").val())) {
                                    if (!status) {
                                        $('#chatMessages').append('<p class="time-summary-day">' + data.Data[i].MessageDay + '</p>');
                                        msgDayList.push(data.Data[i].MessageDay);
                                    }
                                    //message from other side
                                    //'<p class="time-summary-day-sticky">' + data.Data[i].MessageDay + '</p>'
                                    if (data.Data[i].IsEdited) {

                                        var userprofile_src = $("#headeruser img").attr("src");
                                        if (userprofile_src) {
                                            $('#chatMessages').append(
                                                '<div class="message-with-profile" style="display:flex;width:100%">'
                                                + '<div class="user-profile-img" style="padding-top:0px;padding-left: 0;display: inline-block;float: left;"><div class="chatAvatar openChatbox msghistoryUser"><img class="chatAvatar" src="' + userprofile_src + '"></div></div>'
                                                + '<div class="user-pro-nm"><label class="msg-time">' + data.Data[i].StrMsgDateTime + '</label>'
                                                + '<div class="msg_a" id="otherside_' + i + '">' + data.Data[i].Msg + '</div></div><div class="edit_icon"><i class="fa fa-pencil" title="This message has been edited"></i></div>'
                                                + '</div>'
                                            );
                                        }
                                        else {
                                            /* var userInitial = $("#TopChannelDiv h4")[0].outerText;*/
                                            var userInitial = $(".user-profile-name")[0].outerText;
                                            var strIntial = "";
                                            var initial = userInitial.split(" ");
                                            if (initial.length > 0) {
                                                strIntial = initial[0].charAt(0);
                                                if (initial.length > 1) {
                                                    strIntial += initial[1].charAt(0);
                                                }
                                            }


                                            $('#chatMessages').append(
                                                '<div class="message-with-profile" style="display:flex;width:100%">'
                                                + '<div class="user-profile-img" style="padding-top:0px;padding-left: 0;display: inline-block;float: left;"><div class="chatAvatar openChatbox msghistoryUser"><h4>' + strIntial + '</h4></div></div>'
                                                + '<div class="user-pro-nm"><label class="msg-time">' + data.Data[i].StrMsgDateTime + '</label>'
                                                + '<div class="msg_a" id="otherside_' + i + '">' + data.Data[i].Msg + '</div></div><div class="edit_icon"><i class="fa fa-pencil" title="This message has been edited"></i></div>'
                                                + '</div>'
                                            );
                                        }
                                        //$('#chatMessages').append(
                                        //    '<div class="message-with-profile" style="display:flex;width:100%">'
                                        //    + '<div class="user-profile-img" style="padding-top:0px;padding-left: 0;display: inline-block;float: left;"><div class="chatAvatar openChatbox msghistoryUser"><h4>KP</h4></div></div>'
                                        //    + '<div class="user-pro-nm"><label class="msg-time">' + data.Data[i].StrMsgDateTime + '</label>'
                                        //    + '<div class="msg_a" id="otherside_' + i + '">' + data.Data[i].Msg + '</div></div><div class="edit_icon"><i class="fa fa-pencil" title="This message has been edited"></i></div>'
                                        //    + '</div>'
                                        //);
                                    }
                                    else {

                                         var userprofile_src = $("#headeruser img").attr("src");
                                        /*  var userInitial = $(".user-profile-name")[0].outerText;*/
                                        if (userprofile_src) {
                                            $('#chatMessages').append(
                                                '<div class="message-with-profile" style="display:flex;width:100%">'
                                                + '<div class="user-profile-img" style="padding-top:0px;padding-left: 0;display: inline-block;float: left;"><div class="chatAvatar openChatbox msghistoryUser"><img class="chatAvatar" src="' + userprofile_src + '"></div></div>'
                                                + '<div class="user-pro-nm"><label class="msg-time">' + data.Data[i].StrMsgDateTime + '</label>'
                                                + '<div class="msg_a" id="otherside_' + i + '">' + data.Data[i].Msg + '</div></div>'
                                                + '</div>'
                                            );
                                        }
                                        else {
                                            /*var userInitial = $("#headeruser h4")[0].outerText;*/
                                            var userInitial = $(".user-profile-name")[0].outerText;
                                            var strIntial = "";
                                            var initial = userInitial.split(" ");
                                            if (initial.length > 0) {
                                                strIntial = initial[0].charAt(0);
                                                if (initial.length > 1) {
                                                    strIntial += initial[1].charAt(0);
                                                }
                                            }


                                            $('#chatMessages').append(
                                                '<div class="message-with-profile" style="display:flex;width:100%">'
                                                + '<div class="user-profile-img" style="padding-top:0px;padding-left: 0;display: inline-block;float: left;"><div class="chatAvatar openChatbox msghistoryUser"><h4>' + strIntial + '</h4></div></div>'
                                                + '<div class="user-pro-nm"><label class="msg-time">' + data.Data[i].StrMsgDateTime + '</label>'
                                                + '<div class="msg_a" id="otherside_' + i + '">' + data.Data[i].Msg + '</div></div>'
                                                + '</div>'
                                            );
                                        }
                                        //$('#chatMessages').append(
                                        //    '<div class="message-with-profile" style="display:flex;width:100%">'
                                        //    + '<div class="user-profile-img" style="padding-top:0px;padding-left: 0;display: inline-block;float: left;"><div class="chatAvatar openChatbox msghistoryUser"><h4>KP</h4></div></div>'
                                        //    + '<div class="user-pro-nm"><label class="msg-time">' + data.Data[i].StrMsgDateTime+ '</label>'
                                        //    + '<div class="msg_a" id="otherside_' + i + '">' + data.Data[i].Msg + '</div></div>'
                                        //    +'</div>'
                                        //);
                                    }

                                }
                                else {
                                    //message from this side
                                    if (!status) {
                                        $('#chatMessages').append('<p class="time-summary-day">' + data.Data[i].MessageDay + '</p>');
                                        msgDayList.push(data.Data[i].MessageDay);
                                    }
                                    if (data.Data[i].Msg.charAt(0) != "<") {
                                        if (data.Data[i].IsEdited) {
                                            $('#chatMessages').append(`<label class="msg-time" id="Msg_Time_${i}" style="">${data.Data[i].StrMsgDateTime}</label><div class="msg_b_row"><div class="edit_icon" id="editIcon_${i}"><i class="fa fa-pencil" title="This message has been edited"></i></div><div class="msg_b" id="Msg_${i}">${data.Data[i].Msg}</div>`
                                                + `<div class="msg_b_menu" id="Msg_Menu_${i}" onclick="ShowPopup(${i},${data.Data[i].PersonalChatId});">`
                                                + `<i class="fa fa-ellipsis-v"></i><div class="chat_option" id="chat_option_${i}">`
                                                + `<span onclick="EditMessage(${data.Data[i].PersonalChatId},${i})">Edit</span>`
                                                + `<span onclick="RemoveMessage(${data.Data[i].PersonalChatId},${i})">Remove</span></div>`
                                                + `</div></div>`);
                                        }
                                        else {

                                            $('#chatMessages').append(`<label class="msg-time" id="Msg_Time_${i}" style="">${data.Data[i].StrMsgDateTime}</label><div class="msg_b_row"><div class="msg_b" id="Msg_${i}">${data.Data[i].Msg}</div>`
                                                + `<div class="msg_b_menu" id="Msg_Menu_${i}" onclick="ShowPopup(${i},${data.Data[i].PersonalChatId});">`
                                                + `<i class="fa fa-ellipsis-v"></i><div class="chat_option" id="chat_option_${i}">`
                                                + `<span onclick="EditMessage(${data.Data[i].PersonalChatId},${i})">Edit</span>`
                                                + `<span onclick="RemoveMessage(${data.Data[i].PersonalChatId},${i})">Remove</span></div>`
                                                + `</div></div>`);
                                        }


                                    }
                                    else {
                                        $('#chatMessages').append(`<label class="msg-time" id="Msg_Time_${i}" style="">${data.Data[i].StrMsgDateTime}</label><div class="msg_b_row"><div class="msg_b" id="Msg_${i}">${data.Data[i].Msg}</div>`
                                            + `<div class="msg_b_menu" id="Msg_Menu_${i}" onclick="ShowPopup(${i},${data.Data[i].PersonalChatId});">`
                                            + `<i class="fa fa-ellipsis-v"></i><div class="chat_option" id="chat_option_${i}">`
                                            + `<span onclick="RemoveMessage(${data.Data[i].PersonalChatId},${i})">Remove</span></div>`
                                            + `</div></div>`);


                                    }

                                }
                            }

                        }
                        scrollChatDiv();
                    }
                }
            }
        });
    }
    function SaveSignalRUserNGetContacts() {

        $('.loader').show();
        $.ajax({
            url: '@Url.Action("SaveUserNGetContacts", "SignalRHelper")',
            async: false,
            type: 'POST',
            data: { SignalRId: $("#SignalR_From_ID").val() },
            success: function (data) {

                $('.loader').hide();


                if (data.Success) {
                    triggerNewJoinAlert();
                    loadChatContact();

                }
            }
        });
    }
    function loadChatContact() {
        $('.loader').show();
        $.ajax({
            url: encodeURI('@Url.Action("GetContactNGroupsList", "SignalRHelper")'),
            type: "POST",
            async: false,
            success: function (data) {
                $('.loader').hide();


                if (data.Success && data.Data.length > 0) {

                    if (DeleteChannel) {
                        if ($("#channel-title").val() == "") {
                            $('.chat-message-load').css({ "display": "flex" });
                        }
                    }

                    const myNode = document.getElementById("ChatListDiv");
                    myNode.textContent = '';
                    var Groupcnt = 0;
                    $("#GroupMembers").html("");
                  /*  var isdeletedGroup = false;*/
                    for (var i = 0; i < data.Data.length; i++) {
                        let id = data.Data[i].SignalRId;
                        let userName = data.Data[i].UserName;
                        let isPrivate = data.Data[i].IsPrivate;
                        let isOnline = data.Data[i].IsOnline;
                        let onlineDateTime = data.Data[i].OnlineDateTime;
                        let isGroupOwner = data.Data[i].IsGroupOwner;
                        let initials = data.Data[i].UserInitials;
                        let unReadCount = data.Data[i].UnReadCount;
                        let imageName = data.Data[i].ImageName;
                        let imageURL = data.Data[i].ImageURL;
                        let Privatecnt = 0;
                        let DBID = 0;
                        let IsStickedUser = data.Data[i].IsStickedUser;

                        let onlineofflinestatus = '<div class="status-circle-offline"></div>';

                        //if (data.Data[i].IsOnline==1) {
                        //    onlineofflinestatus = '<div class="status-circle-online"></div>';
                        //}
                        //else if (data.Data[i].IsOnline == 2) {
                        //    onlineofflinestatus = '<div class="status-circle-online"></div>';
                        //}
                        //else if (data.Data[i].IsOnline == 3) {

                        //    onlineofflinestatus = '<div class="fa fa-ban"></div>';
                        //}
                        //else if (data.Data[i].IsOnline == 4) {
                        //    onlineofflinestatus = '<div class="status-circle-online"></div>';
                        //}

                        // Changes for user status
                        if (data.Data[i].UserStatus > 1) {
                            if (data.Data[i].UserStatus == 2) {
                                onlineofflinestatus = '<div class="status-circle-away"></div>';
                            }
                            else if (data.Data[i].UserStatus == 3) {
                                onlineofflinestatus = '<div class="status-circle-dnd"></div>';
                            }
                            else if (data.Data[i].UserStatus == 4) {
                                onlineofflinestatus = '<div class="status-circle-invisible"></div>';
                            }
                        }
                        else {

                            onlineofflinestatus = '<div class="status-circle-offline"></div>';
                            if (data.Data[i].IsOnline == 1) {
                                onlineofflinestatus = '<div class="status-circle-online"></div>';
                            }
                        }
                        //
                        let displayUserName = '';
                        if (data.Data[i].IsPrivate) {
                            Privatecnt += i+1;
                            DBID = data.Data[i].SignalRUserId;
                            if (imageName) {
                                initials = '<div><img src = "' + imageURL + '" class="chatAvatar" /></div>'
                            }
                            else {
                                initials = '<div>' + initials + '</div>';
                            }
                            let chatbadge = '<div class="chat-badge" style="display:none">0</div>';

                            if (unReadCount > 0) {
                                chatbadge = '<div class="chat-badge">' + unReadCount + '</div>';
                            }

                            let StickedUser = '<i class="fa fa-thumb-tack" aria-hidden="true" onclick="changeStickedUser(' + DBID + ',' + IsStickedUser + ')"></i>';
                            if (IsStickedUser) {
                                StickedUser = '<i class="fa fa-thumb-tack" aria-hidden="true" style="color: chartreuse; transform: rotate(90deg);" onclick="changeStickedUser(' + DBID + ',' + IsStickedUser + ')"></i>';
                            }

                            if ($("#channel-title").text() == data.Data[i].UserName) {
                                $("#SignalR_To_ID").val(id);
                            }

                            $('#ChatListDiv').append(
                                `<div class="row chat-pb-5 user-details-list" onclick="startChat(this.id,'` + imageURL+`','` + userName.toString() + `',` + isPrivate + `,'` + DBID + `',` + isGroupOwner + `,` + isOnline + `)" id="` + id + `">`
                                + '<div class="user-profile-img">'
                                + '<div class="chatAvatar">' + initials + '</div>'
                                + onlineofflinestatus
                                + '</div>'
                                + '<div class="user-profile-name" style="color:#bcabbc;">' + userName + '<div class="user-sticky sticked-user">'
                                + StickedUser
                                + '</div>'
                                + chatbadge
                                + '<div style="font-size: 10px;color: #7b647c;">' + onlineDateTime + '</div>'
                                + '</div>'
                                + '</div>');
                            $('#DirectMessage').html(' (' + Privatecnt + ')');
                            mainChatBadgeValue();
                        }
                        else {

                            let chatbadgegroup = '<div class="chat-badge" style="display:none">0</div>';
                            if (unReadCount > 0) {
                                chatbadgegroup = '<div class="chat-badge">' + unReadCount + '</div>';
                            }
                            DBID = data.Data[i].SignalRGroupId;
                            joinGroup(userName);
                            let cnt = '<i title="delete group" class="fa fa-trash-o deleteGroupBtn" onclick="DeleteGroup(' + DBID + ')"></i>' + '<i class="fa fa-pencil editGroupBtn" title="edit group" onclick="AddEditGroup(' + DBID + ')"></i>';
                            $('#GroupMembers').append(`<div id="` + id + `" class="row" style="padding-right: 20px;padding-left: 30px;"><div class="grp_name"  id="` + id + `" onclick="startChat(this.id,'` + imageURL + `','` + userName.toString() + `',` + isPrivate + `,'` + DBID + `',` + null + `,` + isOnline + `)">` + '#' + userName + `</div><div id="` + id + `" class="grp_action">` + cnt + chatbadgegroup + '</div></div>');
                             /*$('#GroupMembers').append(`<div style="padding-bottom: 11px;padding-left: 15px;"onclick="startChat(this.id,'` + imageURL +`','` + userName.toString() + `',` + isPrivate + `,'` + DBID + `',` + null + `,` + isOnline + `)" id="` + id + `">` + '#' + userName + cnt + chatbadgegroup+'</div>');*/

                            Groupcnt++;
                            $('#GroupCount').html(' (' + Groupcnt + ')');
                            mainChatBadgeValue();

                        }
                    }

                    if (Groupcnt == 0) {
                        $('#GroupCount').html('');
                    }

                }
            }
        });
    }
    function mainChatBadgeValue() {
        var ele = $(".chat-pb-5");
        var parentBadgeVal = 0;
        for (var i = 0; i < ele.length; i++) {
            var childbadgeval = ele[i].querySelector('.chat-badge').innerHTML;
            if (parseInt(childbadgeval) > 0) {
                parentBadgeVal = parentBadgeVal + parseInt(childbadgeval);
            }
        }
            unreadCountChange(parentBadgeVal);
    }
    setInterval(function () {
        mainChatBadgeValue();
    },100)
    function unreadCountChange(newUnreadCount) {
        try {
            navigator.setAppBadge(newUnreadCount);
        } catch (e) {
            console.error(e);
        }
    }
    function sendNotificationToWindow(title, msgbody) {
        //alert(title + ' ' + msgbody);
        var val = $(".on").css("display")

            if (window.Notification && Notification.permission.toLowerCase() === "granted") {
                var iconURL = location.origin + '/Content/img/icons/chat-icon/apple-touch-icon/favicon.png';
                if (val == "block") {
                    var notification = new Notification(title, {
                        body: msgbody,
                        icon: iconURL,
                        silent: false
                    });
                }
                else {
                    var notification = new Notification(title, {
                        body: msgbody,
                        icon: iconURL,
                        silent: true
                    });
                }

            }


    }
    function AddEditGroup(groupId) {

        var count = 0;
        /*CloseJqueryDialog();*/
        $('.loader').show();
        $.ajax({
            url: '@Url.Action("GetSignalRGroupName", "SignalRHelper")',
            async: false,
            type: 'POST',
            data: { SignalRGroupId: groupId },
            success: function (data) {

                $('.loader').hide();

                $('#idGroupModelBody').html(data);
                for (var i = 0; i < $(data).find('input[type=checkbox]:checked').length; i++) {
                   count =+1;
                }
                $('#AddEditGroupModal').modal('toggle');
                //chat.server.PublicMessage("","");
                //chat.client.PublicMessage = function (Cl_Name, Cl_Message) {
                //    console.log(Cl_Name, Cl_Message);
                //    if (Cl_Name === "NewJoin" || Cl_Name === "Disconnect") {
                //        loadChatContact();
                //    }
                //};
            }
        });

    }
    function formatAMPM(date) {
         //var Date = date.getDate().toString().padStart(2, '0');
        //var Month = (date.getMonth() + 1).toString().padStart(2, '0');
        //var Year = date.getFullYear().toString().padStart(4, '0');
       // var hours = date.getHours();
        //var minutes = date.getMinutes();
        var hours = date.getUTCHours();
        var minutes = date.getUTCMinutes();
        var ampm = hours >= 12 ? 'PM' : 'AM';
        hours = hours % 12;
        hours = hours ? hours : 12; // the hour '0' should be '12'
        minutes = minutes < 10 ? '0' + minutes : minutes;
        //var strDate = Date + '/' + Month + '/' + Year;
        var strTime = ("0" + hours).slice(-2) + ':' + ("0" + minutes).slice(-2) + ' ' + ampm;
        return strTime;
    }
    function scrollChatDiv() {
        setTimeout(function () {
            var scrollHeight = document.getElementById('chatMessages').scrollHeight;
            document.getElementById('chatMessages').scrollTop = scrollHeight;
        }, 500);
    }
    function toggleEmojis() {
        $('#diveEmojiPanel').toggle('slow');
    }
    function toggleChatAttachment() {
        $('#ChatAttachment').click();
    }
    function SelectEmoji(emojiSpan, CodeOfEmoji) {
        emojiCode.push('&#' + CodeOfEmoji);
        var message = $("#TxtMessage").val();
        //message = message + ' &#' + CodeOfEmoji + ' ';
        message = message + emojiSpan.innerHTML;
        $("#TxtMessage").val(message)
    }
    function GetUserName() {
        var Name = $("#LoadUser").val();
        $('.loader').show();
        $.ajax({
            url: encodeURI('@Url.Action("DisplayUserSearchByName", "SignalRHelper")'),
            type: "POST",
            data: { Name: Name },
            async: false,
            success: function (data) {
                $('.loader').hide();
                $('#GroupMembers').html("");
                $('#ChatListDiv').html("");
                $('#DirectMessage').html("");
                $('#GroupCount').html("");
                if (data.Success && data.Data.length > 0) {
                    for (var i = 0; i < data.Data.length; i++) {
                        let id = data.Data[i].SignalRId;
                        let userName = data.Data[i].UserName;
                        let isPrivate = data.Data[i].IsPrivate;
                        let isOnline = data.Data[i].IsOnline;
                        let onlineDateTime = data.Data[i].OnlineDateTime;
                        let isGroupOwner = data.Data[i].IsGroupOwner;
                        let initials = data.Data[i].UserInitials;
                        let unReadCount = data.Data[i].UnReadCount;
                        let imageName = data.Data[i].ImageName;
                        let imageURL = data.Data[i].ImageURL;
                        let Msg = data.Data[i].Msg;
                        let Privatecnt = 0;
                        let Groupcnt = 0;
                        let DBID = 0;

                        let onlineofflinestatus = '<div class="status-circle-offline searchStatus"></div>';

                        if (data.Data[i].IsOnline == 1) {
                            onlineofflinestatus = '<div class="status-circle-online searchStatus"></div>';
                        }
                        let displayUserName = '';
                        if (data.Data[i].IsPrivate) {
                            Privatecnt += i + 1;
                            DBID = data.Data[i].SignalRUserId;
                            if (imageName) {
                                initials = '<div><img src = "' + imageURL + '" class="chatAvatar" /></div>'
                            }
                            else {
                                initials = '<div>' + initials + '</div>';
                            }
                            let chatbadge = '<div class="chat-badge" style="display:none">0</div>';

                            if (unReadCount > 0) {
                                chatbadge = '<div class="chat-badge">' + unReadCount + '</div>';
                            }
                            if (Msg != null) {

                                $('#ChatListDiv').append(
                                    `<div class="row chat-pb-5" onclick="startChat(this.id,'` + imageURL + `','` + userName.toString() + `',` + isPrivate + `,'` + DBID + `',` + isGroupOwner + `,` + isOnline + `)" id="` + id + `">`
                                    + '<div class="col-xs-2">'
                                    + '<div class="chatAvatar">' + initials + '</div>'
                                    + onlineofflinestatus
                                    + '</div>'
                                    + '<div class="col-xs-10 user-profile-name" style="color:white;"><div />' + userName + chatbadge + '<div style="font-size: 10px;color: #b9ddfb;">' + onlineDateTime + '</div>'/*style = "padding-bottom: 12px;"*/
                                    + '</div>'
                                    + '<div class="col-xs-10" style="color:white;">' + Msg + '</div>'
                                    + '</div>');
                            }
                            else {
                                $('#ChatListDiv').append(
                                    `<div class="row chat-pb-5" onclick="startChat(this.id,'` + imageURL + `','` + userName.toString() + `',` + isPrivate + `,'` + DBID + `',` + isGroupOwner + `,` + isOnline + `)" id="` + id + `">`
                                    + '<div class="col-xs-2">'
                                    + '<div class="chatAvatar">' + initials + '</div>'
                                    + onlineofflinestatus
                                    + '</div>'
                                    + '<div class="col-xs-10 user-profile-name" style="color:white;"><div />' + userName + chatbadge + '<div style="font-size: 10px;color: #b9ddfb;">' + onlineDateTime + '</div>'/*style = "padding-bottom: 12px;"*/
                                    + '</div>'
                                    + '</div>');
                            }

                            $('#DirectMessage').html(' (' + Privatecnt + ')');
                        }
                        else {

                            let chatbadgegroup = '<div class="chat-badge" style="display:none">0</div>';
                            if (unReadCount > 0) {
                                chatbadgegroup = '<div class="chat-badge">' + unReadCount + '</div>';
                            }
                            DBID = data.Data[i].SignalRGroupId;
                            joinGroup(userName);
                            let cnt = '<i class="glyphicon glyphicon-remove-circle deleteGroupBtn" onclick="DeleteGroup(' + DBID + ')"></i>' + '<i class="fa fa-pencil-square-o editGroupBtn" onclick="AddEditGroup(' + DBID + ')"></i>';
                            /*$('#GroupMembers').append(`<div style="padding-bottom: 11px;padding-left: 10px;"onclick="startChat(this.id,'` + imageURL + `','` + userName.toString() + `',` + isPrivate + `,'` + DBID + `',` + null + `,` + isOnline + `)" id="` + id + `">` + '#' + userName + cnt + chatbadgegroup + '</div>');*/
                            $('#GroupMembers').append(`<div id="` + id + `" class="row" style="padding-right: 20px;padding-left: 30px;"><div class="grp_name"  id="` + id + `" onclick="startChat(this.id,'` + imageURL + `','` + userName.toString() + `',` + isPrivate + `,'` + DBID + `',` + null + `,` + isOnline + `)">` + '#' + userName + `</div><div id="` + id + `" class="grp_action">` + cnt + chatbadgegroup + '</div></div>');
                            Groupcnt++;
                            $('#GroupCount').html(' (' + Groupcnt + ')');
                        }
                    }
                }
                else {
                    loadChatContact();
                }
            }
        });
    }
    //function UpdateUserStatus() {
    $("li.userStatus").click(function () {
        $("i.fa-check").removeClass("fa fa-check");
        $(this).find("a").find("i").addClass("fa fa-check");
        //var status = document.getElementById("selectstatus");
        //var UserStatus = status.options[status.selectedIndex].value;
        let status = $(this).find("a").text();
        let UserStatus = status == "Active" ? 1 : status == "Away" ? 2 : status == "Do not Distrub" ? 3 : status == "Invisible" ? 4 : "";
        $("#staticStatusSpan").text(status);
        $("#userStaticStatus").removeClass();
        status = UserStatus == 2 ? $("#userStaticStatus").addClass("user-status-away") : UserStatus == 3 ? $("#userStaticStatus").addClass("user-status-dnd") : UserStatus == 4 ? $("#userStaticStatus").addClass("user-status-invisible") : $("#userStaticStatus").addClass("user-status-online");
        if (UserStatus != "") {
            $('.loader').show();
            $.ajax({
                url: encodeURI('@Url.Action("UpdateUserStatus", "SignalRHelper")'),
                type: "POST",
                data: { UserStatus: UserStatus },
                async: false,
                success: function (data) {
                    $('.loader').hide();
                    if (data.Success) {
                        var UserName = '@ProjectSession.LoginChatUserDetails.FirstName' + ' ' + '@ProjectSession.LoginChatUserDetails.LastName';
                        chat.server.statusChangeDisplay($('#SignalR_From_ID').val(), UserName);
                        loadChatContact();
                        toastr.success("Status changed successfully.");
                    }
                }
            });
        }
    });
    //}
    function ShowPopup(i, PersonalChatId) {
        //$(".chat_option").css('display', 'none');
        //$("#chat_option_" + i).toggle();

        if ($("#chat_option_" + i).hasClass("toggle")) {
            $("#chat_option_" + i).css("display", "none");
            $("#chat_option_" + i).removeClass("toggle");

        }
        else {
            $(".toggle").css("display", "none");
            $("#chat_option_" + i).toggle();
            $("#chat_option_" + i).addClass("toggle");

        }
        //$('#Msg_' + i + '').append(
        //    '<div><p onclick="EditMessage(' + PersonalChatId + ',' + i + ')">Edit</p><p onclick="RemoveMessage(' + PersonalChatId + ',' + i + ')">Remove</p></div>'
        //    //'<select id="selectstatus" class="form-control" onchange="EditMessage(' + PersonalChatId + ',' + i + ')" ><option value="0" selected>-select-</option><option value="1">Edit</option><option value="2">Remove</option></select>'
        //);
    }

    function EditMessage(ChatId,i)
    {
        $('#TxtMessage').val('');
            $('.loader').show();
            $.ajax({
                url: '@Url.Action("LoadMessageFromDB", "SignalRHelper")',
                async: false,
                type: 'POST',
                data: { PersonalChatId: ChatId},
                success: function (data) {
                    $('#TxtMessage').val(data.Data.Msg).focus();
                    $('#ChatId').val(data.Data.PersonalChatId);
                    $('#DyId').val(i);
                    $('.loader').hide();
                    //window.location.reload();

                }   
            });
    }

    function EditGroupMessage(GroupChatId, i)
    {
        $('#TxtMessage').val('');
        $('.loader').show();
        $('#TxtMessage').val($('#Msg_' + i).text()).focus();
        $('#ChatId').val(GroupChatId);
        $('#DyId').val(i);
        $('.loader').hide();
    }
    function UpdateMessageFromDb() {
        let dyid=$('#DyId').val();
         $.ajax({
            url: '@Url.Action("updateMessage", "SignalRHelper")',
            async: false,
            type: 'POST',
            data: { PersonalChatId: $('#ChatId').val(), Message: $("#TxtMessage").val()},
            success: function (data) {
                $('.loader').hide();
                if (data.Success) {
                    var UserName = '@ProjectSession.LoginChatUserDetails.FirstName' + ' ' + '@ProjectSession.LoginChatUserDetails.LastName';
                        $('#Msg_' + dyid + '').html('<div>' + $('#TxtMessage').val() + '</div>');
                    chat.server.privateChat($('#SignalR_To_ID').val(), $('#SignalR_From_ID').val(), UserName, $('#TxtMessage').val(), $('#ChatId').val(), IsEdit);
                        scrollChatDiv();
                    $('#TxtMessage').val('').focus();
                    //window.location.reload();

                }
                else {
                    toastr.error("Something went wrong please try again later.");
                }
            }
        });
    }

    function DeleteGroup(groupId) {
           bootbox.confirm({
              message: "Are you sure you want to delete this group?",
              buttons: {
                  cancel: {
                      label: "No",
                      className: "btn-primary cancel"
                  },
                  confirm: {
                      label: "Yes",
                      className: "btn-danger confirm"
                  }
              },
               callback: function (result) {
                   if (result) {
                       $('.loader').show();
                        $.ajax({
                          url: '@Url.Action("DeleteSignalRGroup", "SignalRHelper")',
                          async: false,
                          type: 'POST',
                          data: { SignalRGroupId: groupId },
                              success: function (data) {

                                 if (data.Success) {
                                     $('.loader').hide();
                                     loadChatContact();
                                     var val = $("#SignalR_TO_DB_ID").val();
                                     if (val != "" && val != null) {
                                         var group_id = parseInt(val);
                                         if (group_id == groupId) {
                                             $('.chat-message-load').css({ "display": "flex" });
                                             $("#channel-title").val("");
                                         }
                                     }

                                     DeleteChannel = true;
                                     //$.connection.hub.start().done(function () {
                                     //    chat.server.letsChat("NewJoin", $('#GroupName').val());
                                     //});
                                     $.connection.hub.start().done(function () {
                                         chat.server.letsChat("DeleteChannel", groupId.toString());
                                     });

                                     toastr.success("Group deleted successfully.");

                                 }
                                 else {
                                     $('.loader').hide();
                                     toastr.error("Something went wrong!");
                                 }
                              }
                        });
                   }
               }
           }).init(function () {
               $(".confirm").prop("title", "Delete");
               $(".cancel").prop("title", "Cancel");
           });


        @*$.ajax({
        url: '@Url.Action("DeleteSignalRGroup", "SignalRHelper")',
        async: false,
        type: 'POST',
        data: { SignalRGroupId: groupId },
            success: function (data) {

            if (data.Success) {
                $('.loader').hide();

                loadChatContact();
                var val = $("#SignalR_TO_DB_ID").val();
                if (val != "" && val != null) {
                    var group_id = parseInt(val);
                    if (group_id == groupId) {
                        $('.chat-message-load').css({ "display": "flex" });
                    }
                }
                $.connection.hub.start().done(function () {
                    chat.server.letsChat("NewJoin", $('#GroupName').val());
                });

                //chat.server.letsChat("NewJoin", $('#GroupName').val());
                toastr.success("Group deleted successfully.");

            }
            else {
                $('.loader').hide();
                toastr.error("Something went wrong!");
            }
        }
        });*@
    }
    function GetUserStatus() {
        $.ajax({
        url: '@Url.Action("GetUserStatus", "SignalRHelper")',
        async: false,
        type: 'POST',
        data: { },
        success: function (data) {
            if (data.Success) {

                let UserOnlineStatusId = data.UserStatus;
                let UserOnlineStatus = UserOnlineStatusId == 2 ? "Away" : UserOnlineStatusId == 3 ? "Do not Distrub" : UserOnlineStatusId == 4 ? "Invisible" : "Active";
                let status = UserOnlineStatusId == 2 ? $("#userStaticStatus").addClass("user-status-away") : UserOnlineStatusId == 3 ? $("#userStaticStatus").addClass("user-status-dnd") : UserOnlineStatusId == 4 ? $("#userStaticStatus").addClass("user-status-invisible") : $("#userStaticStatus").addClass("user-status-online");
                $("#staticStatusSpan").text(UserOnlineStatus);
                $("li.userStatus").each(function () {
                    if ($(this).find("a").text() == UserOnlineStatus) {
                        $("i.fa-check").removeClass("fa fa-check");
                        $(this).find("a").find("i").addClass("fa fa-check");
                    }
                });
            }
        }
        });
    }


    function changeStickedUser(SignalRUserId, IsStickedUser) {
        $.ajax({
        url: '@Url.Action("changeStickedUser", "SignalRHelper")',
        async: false,
        type: 'POST',
            data: {
                SignalRUserId: SignalRUserId,
                IsStick: !IsStickedUser
            },
        success: function (data) {
            if (data.Success) {
                console.log(data);
                loadChatContact();
            }
        }
        });
    }

    function RemoveMessage(ChatId, i)
    {
        if ($("#isPrivateChat").val() == 'true') {
            let PersonalChatId = parseInt(ChatId);
            $('.loader').show();
            $.ajax({
                url: '@Url.Action("RemovePrivateMsg", "SignalRHelper")',
                async: false,
                type: 'POST',
                data: { PersonalChatId: PersonalChatId },
                success: function (data) {

                    if ($('#ChatId').val() == ChatId) {
                        $('#TxtMessage').val('');
                        $('#ChatId').val(0);
                        $('#DyId').val('');
                    }
                    privateChat(null, i, 0);
                    var parentDiv = $('#Msg_' + i + '').parent();
                    $('#editIcon_' + i).remove();
                    $('#Msg_' + i + '').remove();
                    $('#Msg_Menu_' + i).remove();

                    //$('#Msg_Time_' + i).remove();
                    //parentDiv.remove();
                    var nextDiv = parentDiv.next();
                    var display = $('#Msg_Time_' + i).css("display");
                    if (display != "none") {
                        if (nextDiv.length > 0) {
                            var nextDivId = nextDiv.attr("id");
                            if (nextDivId != undefined && nextDivId != "" && nextDivId != null) {
                                $('#' + nextDivId).css({ "display": "flex" });
                            }
                        }
                    }


                    $('#Msg_Time_' + i).remove();
                    parentDiv.remove();
                    $('.loader').hide();

                }
            });
        }
        else {
            
            let GroupChatId = parseInt(ChatId);
            $('.loader').show();
            $.ajax({
                url: '@Url.Action("RemoveGroupMsg", "SignalRHelper")',
                async: false,
                type: 'POST',
                data: { GroupChatId: GroupChatId },
                success: function (data) {
                    if ($('#ChatId').val() == ChatId) {
                        $('#TxtMessage').val('');
                        $('#ChatId').val(0);
                        $('#DyId').val('');
                    }
                    groupChat(null, i, 0);
                    var parentDiv = $('#Msg_' + i + '').parent();
                    $('#Msg_' + i + '').remove();
                    /*$('#Msg_' + i + '').css("display","none");*/
                    $('#editIcon_' + i).remove();
                    $('#Msg_Menu_' + i).remove();

                    var nextDiv = parentDiv.next();
                    var display = $('#Msg_Time_' + i).css("display");
                    if (display != "none") {
                        if (nextDiv.length > 0) {
                            var nextDivId = nextDiv.attr("id");
                            if (nextDivId != undefined && nextDivId != "" && nextDivId != null) {
                                $('#' + nextDivId).css({ "display": "flex" });
                            }
                        }
                    }

                    $('#Msg_Time_' + i).remove();
                    parentDiv.remove();
                    $('.loader').hide();
                }
            });
        }

    }

    function hideChat() {
        $("#chatMessages").hide();
        $(".chat-message-load").attr("style", "");
        $(".top-header").removeClass("top-mobi-header");
    }
    if ('serviceWorker' in navigator) {
        navigator.serviceWorker
            .register('/serviceworker.js')
            .then(function () { console.log('Service Worker Registered'); });

    }
</script>
<script>
    var fixmeTop = $('.fixme').offset().top;
    $(".sticky-after-scroll").scroll(function () {
        var currentScroll = $(".sticky-after-scroll").scrollTop();

        if (currentScroll >= fixmeTop) {
            $('.fixme').css({
                position: 'static',
                top: '0',
                left: '0'
            });
        } else {
            $('.fixme').css({
                position: 'sticky'
            });
        }
    });

    setTimeout(function () {
        $('#GroupMembers div').on('click', function () { $(".chat-message-load").hide(); });
        $("#ChatListDiv .user-details-list").click(function () {
            $(".chat-message-load").hide();
        });
    }, 500)
</script>


