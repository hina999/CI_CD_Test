name: Code Style Check (.NET Framework 4.5)

on:
  pull_request:
    paths: 'TxWeb/**'
    branches: [ main, dev ]

jobs:
  stylecop:
    name: StyleCop Analysis (.NET 4.5)
    runs-on: windows-2019  # VS 2019 image with .NET 4.5 support

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup NuGet
      uses: NuGet/setup-nuget@v1

    - name: Setup MSBuild
      uses: microsoft/setup-msbuild@v1.3.1
      with:
        vs-version: '16.11'  # VS 2019

    - name: Restore NuGet packages
      run: nuget restore TxWeb/FXAdminTransferConnex.sln

    - name: Run StyleCop analysis
      shell: pwsh
      run: |
        # Configure error handling
        $ErrorActionPreference = "Continue"
        
        # Run build with StyleCop
        msbuild "TxWeb/FXAdminTransferConnex.sln" `
          /p:Configuration=Release `
          /p:RunCodeAnalysis=true `
          /p:TreatWarningsAsErrors=true `
          /v:minimal `
          /nologo 2>&1 | Tee-Object -FilePath buildlog.txt

        # Parse logs
        $logContent = Get-Content buildlog.txt -Raw
        $styleCopIssues = [regex]::Matches($logContent, 'SA\d{4}.+?(?=\n|$)') | ForEach-Object { $_.Value.Trim() }
        $buildErrors = [regex]::Matches($logContent, 'error (?!SA\d{4}).+?(?=\n|$)') | ForEach-Object { $_.Value.Trim() }

        # Generate user-friendly summary
        $summaryPath = "build_summary.md"
        
        @"
## üö® Code Style Validation Failed

Hi @$env:GITHUB_ACTOR, we found some issues that need attention:
"@ | Out-File -FilePath $summaryPath

        if ($styleCopIssues.Count -gt 0) {
          @"
### üîç StyleCop Violations ($($styleCopIssues.Count) found)
These are code style violations that need to be fixed:
$(($styleCopIssues | Select-Object -First 10 | ForEach-Object { "- ``$_``" }) -join "`n")
"@ | Out-File -FilePath $summaryPath -Append
        }

        if ($buildErrors.Count -gt 0) {
          @"
### ‚ùå Build Errors ($($buildErrors.Count) found)
These are critical issues preventing successful build:
$(($buildErrors | Select-Object -First 10 | ForEach-Object { "- ``$_``" }) -join "`n")
"@ | Out-File -FilePath $summaryPath -Append
        }

        @"
**‚ÑπÔ∏è Need help?**
- For StyleCop issues, check [StyleCop documentation](https://github.com/DotNetAnalyzers/StyleCopAnalyzers/blob/master/DOCUMENTATION.md)
- For build errors, check the full log below
- Only showing first 10 issues per category - [View complete log](buildlog.txt)

Please fix these issues and update your PR.
"@ | Out-File -FilePath $summaryPath -Append

        # Add to GitHub summary
        Get-Content $summaryPath | Out-File -Append -FilePath $env:GITHUB_STEP_SUMMARY

        # Fail the build if issues found
        if ($styleCopIssues.Count -gt 0 -or $buildErrors.Count -gt 0 -or $LASTEXITCODE -ne 0) {
          exit 1
        }
      
    - name: Upload complete build log
      if: failure()
      uses: actions/upload-artifact@v4
      with:
        name: stylecop-analysis-log
        path: buildlog.txt
